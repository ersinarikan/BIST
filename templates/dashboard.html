<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIST AI System - Real-time Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        // üöÄ CACHE BUSTER & VERSION CONTROL
        const DASHBOARD_VERSION = '2025.08.08.WebSocket.1.1';
        const CACHE_BUSTER = 1758220727;
        console.log('üéØ BIST Dashboard - Version:', DASHBOARD_VERSION, 'Cache:', CACHE_BUSTER);
        
        // Force refresh indicator
        if (localStorage.getItem('dashboardVersion') !== DASHBOARD_VERSION) {
            localStorage.setItem('dashboardVersion', DASHBOARD_VERSION);
            console.log('‚úÖ Dashboard version updated - forcing fresh data');
        }
        
        // üîó WebSocket Connection
        let socket = null;
        let isConnected = false;
        
        function initializeWebSocket() {
            socket = io({ 
                path: '/socket.io',
                transports: ['polling', 'websocket'],
                upgrade: true,
                secure: window.location.protocol === 'https:',
                rejectUnauthorized: false,
                withCredentials: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 20,
                timeout: 60000,
                maxReconnectionAttempts: 20
            });
            
            socket.on('connect', function() {
                isConnected = true;
                window._reconnectAttempts = 0; // Reset reconnect counter on successful connection
                console.log('üîó WebSocket connected:', socket.id);
                addLog('SUCCESS', 'üîó Real-time connection established');
                
                // Join admin room
                socket.emit('join_admin');
                
                // Update connection status in navbar
                try {
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-success"></i> Connected';
                    }
                } catch (e) {
                    console.warn('Navbar connection status update error:', e);
                }
                
                // Update connection status in panel
                try {
                    const wsStatusElement = document.getElementById('websocket-status');
                    if (wsStatusElement) {
                        wsStatusElement.textContent = 'connected';
                        wsStatusElement.className = 'badge bg-success';
                    }
                } catch (e) {
                    console.warn('WebSocket status update error:', e);
                }
            });
            
            socket.on('disconnect', function() {
                isConnected = false;
                console.log('‚ùå WebSocket disconnected');
                addLog('ERROR', '‚ùå Real-time connection lost');
                
                // Update connection status in navbar
                try {
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-danger"></i> Disconnected';
                    }
                } catch (e) {
                    console.warn('Navbar connection status update error:', e);
                }
                
                // Update connection status in panel
                try {
                    const wsStatusElement = document.getElementById('websocket-status');
                    if (wsStatusElement) {
                        wsStatusElement.textContent = 'disconnected';
                        wsStatusElement.className = 'badge bg-danger';
                    }
                } catch (e) {
                    console.warn('WebSocket status update error:', e);
                }
                // Controlled reconnect attempt with exponential backoff
                try { 
                    if (!window._reconnectAttempts) window._reconnectAttempts = 0;
                    window._reconnectAttempts++;
                    const delay = Math.min(30000, 1500 * Math.pow(2, window._reconnectAttempts - 1));
                    setTimeout(() => { 
                        if (socket && !socket.connected && window._reconnectAttempts < 10) { 
                            socket.connect(); 
                        }
                    }, delay); 
                } catch (e) {}
            });

            socket.on('connect_error', function(err) {
                try {
                    const msg = (err && (err.message || err.description || err.type || err.name)) || String(err);
                    console.error('‚ùå WebSocket connect_error:', err);
                    addLog('ERROR', `‚ùå WebSocket connect_error: ${msg}`);
                    
                    // Update connection status in navbar on connect error
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-danger"></i> Connection Error';
                    }
                } catch (_) {}
            });

            socket.on('reconnect', function() {
                console.log('üîÑ WebSocket reconnected');
                addLog('SUCCESS', 'üîÑ Real-time connection restored');
                
                // Rejoin admin room after reconnection
                socket.emit('join_admin');
                
                // Update connection status in navbar
                try {
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-success"></i> Connected';
                    }
                } catch (e) {
                    console.warn('Navbar connection status update error:', e);
                }
                
                // Update connection status in panel
                try {
                    const wsStatusElement = document.getElementById('websocket-status');
                    if (wsStatusElement) {
                        wsStatusElement.textContent = 'connected';
                        wsStatusElement.className = 'badge bg-success';
                    }
                } catch (e) {
                    console.warn('WebSocket status update error:', e);
                }
            });

            socket.on('reconnect_attempt', function() {
                console.log('üîÑ Attempting to reconnect...');
                addLog('INFO', 'üîÑ Attempting to reconnect...');
                
                // Update connection status in navbar during reconnect attempt
                try {
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-warning"></i> Reconnecting...';
                    }
                } catch (e) {
                    console.warn('Navbar connection status update error:', e);
                }
            });

            socket.on('reconnect_failed', function() {
                console.log('‚ùå Reconnection failed');
                addLog('ERROR', '‚ùå Reconnection failed - please refresh page');
                
                // Update connection status in navbar when reconnection fails
                try {
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-danger"></i> Connection Failed';
                    }
                } catch (e) {
                    console.warn('Navbar connection status update error:', e);
                }
            });
            
            socket.on('room_joined', function(data) {
                console.log('üë§ Joined room:', data.room);
                addLog('INFO', `üë§ ${data.message}`);
            });
            
            socket.on('log_update', function(data) {
                addLog(data.level.toUpperCase(), data.message, data.category);
            });
            
            socket.on('pattern_analysis', function(data) {
                console.log('üìä Pattern analysis received:', data.symbol);
                addLog('INFO', `üìä Pattern analysis updated for ${data.symbol}`);
                // Auto-refresh dashboard when new analysis arrives
                updateDashboard();
                // Also update recent tasks to show new trading activity
                setTimeout(updateRecentTasks, 1000);
            });
            
            socket.on('error', function(data) {
                console.error('‚ùå Socket error:', data.message);
                addLog('ERROR', `‚ùå ${data.message}`);
            });
            
            // Real-time simulation updates
            socket.on('simulation_trade', function(data) {
                console.log('üí∞ Simulation trade received:', data);
                addLog('INFO', `üí∞ ${data.trade_type}: ${data.symbol} @ ${data.price}‚Ç∫`);
                // Update recent tasks immediately
                updateRecentTasks();
                // Update simulation status if currently shown
                if (currentSimulationId) {
                    checkSimulationStatus();
                }
            });
            
            // Task updates
            socket.on('task_update', function(data) {
                console.log('üìã Task update received:', data);
                updateRecentTasks();
            });
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                statusEl.innerHTML = connected ? 
                    '<i class="fas fa-wifi text-success"></i> Real-time' : 
                    '<i class="fas fa-wifi text-danger"></i> Disconnected';
            }
        }
    </script>
    
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .status-healthy { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .status-unknown { color: #6c757d; }
        
        .metric-card {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        /* Recent tasks panel: let flexbox control height */
        #recent-tasks {
            overflow-y: auto;
        }
        /* Stretch recent tasks list to fill its card height */
        .recent-card { display: flex; flex-direction: column; }
        .recent-card #recent-tasks { flex: 1 1 auto; max-height: none; min-height: 0; overflow-y: auto; }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .chart-container {
            position: relative;
            height: 150px;
            margin: 12px 0;
        }

        .gauge-box { height: 120px; display:flex; align-items:center; justify-content:center; }
        .mid-six {
            min-height: 540px;
            height: 540px;
            overflow: hidden;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Make mid-six panels content flexible without scrollbars */
        .mid-six > div:last-child {
            flex: 1 1 auto;
            overflow: hidden;
        }
        
        /* Hide scrollbars in all panel content areas */
        .dashboard-card {
            overflow: hidden;
        }
        
        .dashboard-card * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }
        
        .dashboard-card *::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        /* Match all panels' height to System Health card height on desktop */
        /* reset row sync */

        /* Make Recent Tasks fill card */
        .recent-fixed { position: relative; }
        #recent-card #recent-tasks { flex: 1 1 auto; min-height: 0; overflow-y: auto; }

        /* Make columns equal height for the 3-up row */
        .equal-panels > [class^="col-"],
        .equal-panels > [class*=" col-"] {
            display: flex;            /* make columns flex containers */
        }
        .equal-panels .dashboard-card {
            flex: 1 1 auto;          /* let cards stretch to column height */
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Ensure proper spacing and alignment for middle 6 panels */
        .equal-panels.g-4 {
            margin-bottom: 2rem;
        }
        
        /* Make content areas flexible within cards */
        .equal-panels .dashboard-card > div:last-child {
            flex: 1 1 auto;
        }

        /* Equalize top metric cards */
        .metric-grid .metric-card {
            height: 120px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .metric-grid .metric-card .metric-value { margin-bottom: 4px; line-height: 1; }
        #bulk-age { position: absolute; bottom: 10px; left: 10px; }
        
        /* Responsive improvements */
        @media (max-width: 991.98px) {
            .mid-six {
                min-height: 350px;
                height: auto;
                overflow: hidden;
            }
            
            .equal-panels .dashboard-card {
                margin-bottom: 1.5rem;
            }
        }
        
        @media (max-width: 767.98px) {
            .mid-six {
                min-height: 300px;
                height: auto;
                overflow: hidden;
            }
            
            .metric-grid .metric-card {
                height: 100px;
            }
            
            .container-fluid {
                padding-left: 15px;
                padding-right: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-robot me-2"></i>lotlot.net y√∂netim paneli</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="connection-status">
                    <i class="fas fa-wifi text-warning"></i> Connecting...
                </span>
                <span class="navbar-text me-3">
                    <i class="fas fa-circle pulse status-healthy"></i> Live Monitoring
                </span>
                <span class="navbar-text" id="last-update">
                    Last update: <span id="timestamp">--:--:--</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row equal-panels">
            <!-- System Overview -->
            <div class="col-12 mb-4">
                <div class="dashboard-card p-4">
                    <h3><i class="fas fa-tachometer-alt me-2"></i>System Overview</h3>
                    <div class="row mt-3 metric-grid">
                <div class="col-md-3">
                            <div class="metric-card text-center">
                                <div class="metric-value" id="automation-status-header">--</div>
                                <div class="metric-label">Automation Status</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center" style="background: linear-gradient(45deg, #ffd86f 0%, #fc6262 100%);">
                                <div class="metric-value" id="bulk-count">--</div>
                                <div class="metric-label">Bulk Predictions (records)</div>
                                <div class="small" id="bulk-age" style="opacity:.9">Age: --</div>
                                <span class="badge bg-secondary" id="bulk-stale" style="position:absolute; top:10px; right:10px;">--</span>
                                <button class="btn btn-sm btn-light" style="position:absolute; bottom:10px; right:10px;" id="btn-refresh-bulk" onclick="refreshBulkNow()"><i class="fas fa-rotate"></i> Refresh</button>
                            </div>
                        </div>
                <div class="col-md-3">
                            <div class="metric-card text-center" style="background: linear-gradient(45deg, #4ecdc4 0%, #44a08d 100%);">
                                <div class="metric-value" id="stocks-count">--</div>
                                <div class="metric-label">Stocks in DB</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center" style="background: linear-gradient(45deg, #ffecd2 0%, #fcb69f 100%); color: #333;">
                                <div class="metric-value" id="price-records">--</div>
                                <div class="metric-label">Price Records</div>
                </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Middle 6 Panels in 2x3 Grid -->
        <div class="row equal-panels g-4 mb-4">
            <!-- System Health -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div class="dashboard-card mid-six p-4 w-100 recent-card" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4><i class="fas fa-heartbeat me-2 text-success"></i>System Health</h4>
                    <div id="health-status" class="mt-3">
                        <!-- Compact card layout (Overall, Automation, Flask, DB, WebSocket) -->
                        <div class="row g-2">
                            <div class="col-12">
                                <div class="p-2 rounded d-flex justify-content-between align-items-center" style="background:#f8fff9;border:1px solid #e2f3e7;">
                                    <div>
                                        <div class="fw-bold small">Overall Status</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">System Integration</small>
                                    </div>
                                    <span class="badge bg-success" id="overall-status" style="font-size: 0.7rem;">MIGRATED</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-2 rounded d-flex justify-content-between align-items-center" style="background:#f6fbff;border:1px solid #e3f0fb;">
                                    <div>
                                        <div class="fw-bold small">Automation Engine</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">Background Processing</small>
                                    </div>
                                    <span class="badge bg-info" id="automation-status" style="font-size: 0.7rem;">active</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-2 rounded d-flex justify-content-between align-items-center" style="background:#fffaf6;border:1px solid #fde8d9;">
                                    <div>
                                        <div class="fw-bold small">Flask API</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">Web Service</small>
                                    </div>
                                    <span class="badge bg-success" id="flask-status" style="font-size: 0.7rem;">healthy</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-2 rounded d-flex justify-content-between align-items-center" style="background:#fdf9ff;border:1px solid #efe3fb;">
                                    <div>
                                        <div class="fw-bold small">Database</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">PostgreSQL Connection</small>
                                    </div>
                                    <span class="badge bg-success" id="db-status" style="font-size: 0.7rem;">connected</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-2 rounded d-flex justify-content-between align-items-center" style="background:#f9fdff;border:1px solid #e3f7ff;">
                                    <div>
                                        <div class="fw-bold small">WebSocket</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">Real-time Updates</small>
                                    </div>
                                    <span class="badge bg-success" id="websocket-status" style="font-size: 0.7rem;">connected</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Automation Control -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div id="automation-control-card" class="dashboard-card mid-six p-4 w-100" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4><i class="fas fa-cogs me-2 text-primary"></i>Automation Control</h4>
                    <div class="row g-2 mt-3">
                        <div class="col-6">
                            <button class="btn btn-success w-100 py-2" onclick="startAutomation()">
                                <i class="fas fa-play me-1"></i><small>Start</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-danger w-100 py-2" onclick="stopAutomation()">
                                <i class="fas fa-stop me-1"></i><small>Stop</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-warning w-100 py-2" onclick="runTask('health_check')">
                                <i class="fas fa-stethoscope me-1"></i><small>Health</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-info w-100 py-2" onclick="runTask('data_collection')">
                                <i class="fas fa-database me-1"></i><small>Data</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-primary w-100 py-2" onclick="runTask('model_retraining')">
                                <i class="fas fa-brain me-1"></i><small>Retrain</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-secondary w-100 py-2" onclick="generateReport()">
                                <i class="fas fa-file-alt me-1"></i><small>Report</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calibration Summary Panel -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div id="recent-card" class="dashboard-card mid-six p-4 recent-fixed w-100" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4><i class="fas fa-sliders-h me-2 text-success"></i>Calibration Summary</h4>
                    <div id="calibration-summary" class="mt-3 small text-muted" style="max-height: 430px; overflow-y: auto; overflow-x: hidden; scrollbar-gutter: stable both-edges;">Loading...</div>
                </div>
            </div>

            <!-- System Performance -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div class="dashboard-card mid-six p-4 w-100" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4><i class="fas fa-chart-line me-2"></i>System Performance</h4>
                    <div class="row g-3">
                        <div class="col-6 text-center">
                            <div class="gauge-box"><canvas id="gaugeCpu"></canvas></div>
                            <div class="small mt-1"><strong>CPU</strong>: <span id="valCpu">-</span>%</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="gauge-box"><canvas id="gaugeRam"></canvas></div>
                            <div class="small mt-1"><strong>RAM</strong>: <span id="valRam">-</span>%</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="gauge-box"><canvas id="gaugeDisk"></canvas></div>
                            <div class="small mt-1"><strong>Disk</strong>: <span id="valDisk">-</span>%</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="gauge-box"><canvas id="gaugeLoad"></canvas></div>
                            <div class="small mt-1"><strong>Load</strong>: <span id="valLoad">-</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cache Coverage + AI Simulation Panel -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div class="dashboard-card mid-six p-4 w-100" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h5><i class="fas fa-database me-2 text-info"></i>Cache Coverage</h5>
                    <div id="coverage-box" class="mb-2">
                        <div class="d-flex justify-content-between align-items-center p-2 rounded" style="background:#f8f9fa;border:1px solid #dee2e6;">
                            <div>
                                <div class="small text-muted">Pattern cache</div>
                                <div class="fw-bold" id="coverage-stats" style="font-size: 0.9rem;">-- / --</div>
                            </div>
                            <span class="badge bg-secondary" id="coverage-age" style="font-size: 0.7rem;">--</span>
                        </div>
                        <div class="mt-1 d-flex gap-1">
                            <button class="btn btn-sm btn-outline-secondary py-1" onclick="loadCoverage()" style="font-size: 0.75rem;"><i class="fas fa-sync"></i></button>
                            <button class="btn btn-sm btn-outline-primary py-1" onclick="refreshBulkNow()" style="font-size: 0.75rem;"><i class="fas fa-rotate"></i></button>
                        </div>
                    </div>
                    
                    <h5><i class="fas fa-robot me-2 text-info"></i>AI Simulation</h5>
                    <div class="small text-muted mb-2">Virtual trading - 606 hisse</div>
                    
                    <!-- Compact Duration & Status -->
                    <div class="row g-1 mb-2">
                        <div class="col-7">
                            <select class="form-select form-select-sm" id="simulation-duration" style="font-size: 0.8rem;">
                                <option value="12">12h</option>
                                <option value="24">24h</option>
                                <option value="48" selected>48h</option>
                                <option value="72">72h</option>
                                <option value="168">1w</option>
                            </select>
                        </div>
                        <div class="col-5">
                            <div class="p-1 rounded text-center" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                                <div class="small text-dark fw-bold" id="sim-balance" style="font-size: 0.75rem;">‚Ç∫0.00</div>
                                <small class="text-success" id="sim-profit" style="font-size: 0.7rem;">¬±0%</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div id="simulation-status" class="mb-2">
                        <div class="p-2 rounded" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                            <div class="small fw-bold text-dark" id="sim-status-text">No Active Test</div>
                            <small class="text-muted" id="sim-details" style="font-size: 0.7rem;">Select duration & start</small>
                        </div>
                    </div>
                    
                    <!-- Compact Controls -->
                    <div class="row g-1">
                        <div class="col-6">
                            <button class="btn btn-success w-100 py-1 mb-1" id="start-simulation-btn" onclick="startSimulation()" style="font-size: 0.8rem;">
                                <i class="fas fa-play me-1"></i>Start
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-danger w-100 py-1 mb-1" id="stop-simulation-btn" onclick="stopSimulation()" disabled style="font-size: 0.8rem;">
                                <i class="fas fa-stop me-1"></i>Stop
                            </button>
                        </div>
                        <div class="col-12">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text" style="font-size: 0.75rem;">‚Ç∫</span>
                                <input type="number" class="form-control" id="trade-amount" value="10000" min="1000" max="50000" style="font-size: 0.75rem;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compact Stats -->
                    <div class="row g-1 mt-2" id="simulation-stats" style="display: none;">
                        <div class="col-4 text-center">
                            <div class="p-1 rounded" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                                <div class="small text-muted" style="font-size: 0.7rem;">Trades</div>
                                <div class="fw-bold text-dark" id="sim-trades" style="font-size: 0.8rem;">0</div>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="p-1 rounded" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                                <div class="small text-muted" style="font-size: 0.7rem;">Win%</div>
                                <div class="fw-bold text-success" id="sim-winrate" style="font-size: 0.8rem;">0%</div>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="p-1 rounded" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                                <div class="small text-muted" style="font-size: 0.7rem;">Time</div>
                                <div class="fw-bold text-dark" id="sim-runtime" style="font-size: 0.8rem;">0h</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Tasks -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div class="dashboard-card mid-six p-4 w-100" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4>
                        <i class="fas fa-tasks me-2"></i>Recent Tasks
                        <span id="current-phase-badge" class="badge bg-secondary ms-2" title="Current pipeline phase">IDLE</span>
                    </h4>
                    <div class="d-flex justify-content-between align-items-center mt-2" style="flex:0 0 auto;">
                        <div class="small text-muted">
                            <span class="badge" style="background:#0d6efd; font-size: 0.6rem;">INC</span>
                            <span class="badge" style="background:#6f42c1; font-size: 0.6rem;">ANA</span>
                            <span class="badge" style="background:#0dcaf0;color:#000; font-size: 0.6rem;">COL</span>
                            <span class="badge" style="background:#20c997; font-size: 0.6rem;">ML</span>
                        </div>
                        <div class="input-group input-group-sm" style="width: 120px;">
                            <label class="input-group-text" for="tasks-count-select" style="font-size: 0.7rem;">Show</label>
                            <select id="tasks-count-select" class="form-select form-select-sm" style="font-size: 0.75rem;">
                                <option value="3">3</option>
                                <option value="4" selected>4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    <div id="recent-tasks" class="mt-2" style="flex:1 1 auto; min-height:0; overflow-y:auto; overflow-x:hidden;">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <p class="mt-2 small">Loading tasks...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Live Logs -->
            <div class="col-12 mb-4">
                <div class="dashboard-card p-4">
                    <h4><i class="fas fa-terminal me-2"></i>Live System Logs</h4>
                    <div class="log-container" id="live-logs">
                        <div>[INFO] Dashboard initialized - Waiting for system logs...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">System Report</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="reportModalBody">
            <div class="text-muted">Loading...</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

<script>
        // Global variables
        let gaugeCpu, gaugeRam, gaugeDisk, gaugeLoad;
        let logCounter = 0;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            updateDashboard();
            // Load recent tasks immediately on page load
            updateRecentTasks();
            loadCalibrationSummary();
            startLiveUpdates();
        });

        // Initialize four semi-circle gauges
        function initializeChart() {
            const makeGauge = (canvasId)=> new Chart(document.getElementById(canvasId).getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Low','Med','High'], datasets: [{ data: [40,35,25], backgroundColor: ['#2a9d8f','#ffd166','#ef476f'], borderWidth:0, circumference:180, rotation:-90, cutout:'70%' }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{enabled:false} } }
            });
            gaugeCpu = makeGauge('gaugeCpu');
            gaugeRam = makeGauge('gaugeRam');
            gaugeDisk = makeGauge('gaugeDisk');
            gaugeLoad = makeGauge('gaugeLoad');
        }

        // Update dashboard data
        async function updateDashboard() {
            try {
                // Update timestamp
                document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
                
                // Get automation status with improved retry logic
                let automationData;
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount < maxRetries) {
                    try {
                        const automationResponse = await fetch('/api/internal/automation/status?v=' + Date.now(), {
                            headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                        });
                        if (automationResponse.ok) {
                            automationData = await automationResponse.json();
                            break; // Success, exit retry loop
                        } else {
                            throw new Error(`HTTP ${automationResponse.status}: ${automationResponse.statusText}`);
                        }
                    } catch (error) {
                        retryCount++;
                        console.warn(`Automation status fetch failed (attempt ${retryCount}/${maxRetries}):`, error.message);
                        
                        if (retryCount >= maxRetries) {
                            // Final fallback
                            automationData = {
                                available: false,
                                scheduler_status: { is_running: false },
                                mode: 'UNKNOWN',
                                error: error.message
                            };
                            addLog('WARNING', `‚ö†Ô∏è Automation status unavailable after ${maxRetries} attempts: ${error.message}`);
                        } else {
                            // Wait before retry (exponential backoff)
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                        }
                    }
                }
                
                if (automationData && automationData.available) {
                    const status = automationData.scheduler_status;
                    // Ensure status exists and has valid data (handle both boolean and string)
                    if (status && (typeof status.is_running === 'boolean' || typeof status.is_running === 'string')) {
                        const isRunning = (status.is_running === true || status.is_running === 'True' || status.is_running === 'true');
                        const currentStatus = isRunning ? 'RUNNING' : 'STOPPED';
                        const currentJobs = (automationData.mode === 'SYMBOL_FLOW') ? 'Symbol Flow (Sequential)' : (status.scheduled_jobs || 0);
                        
                        // Only update if different to prevent flickering
                        const statusElement = document.getElementById('automation-status');
                        const headerEl = document.getElementById('automation-status-header');
                        const jobsElement = null; // removed scheduled-jobs widget
                        
                        if (statusElement && statusElement.textContent !== currentStatus) {
                            statusElement.textContent = currentStatus;
                            console.log('üîÑ Automation status updated to:', currentStatus);
                        }
                        if (headerEl && headerEl.textContent !== currentStatus) {
                            headerEl.textContent = currentStatus;
                        }
                        // scheduled-jobs widget removed
                    }
                } else {
                    // Fallback when automation data is unavailable: try admin/system_stats
                    try {
                        const sys = await fetch('/api/admin/system_stats?v=' + Date.now());
                        if (sys.ok) {
                            const sj = await sys.json();
                            const aut = String(sj.automation || '').toUpperCase();
                            const statusEl = document.getElementById('automation-status');
                            const headerEl = document.getElementById('automation-status-header');
                            const txt = (aut === 'RUNNING') ? 'RUNNING' : (aut === 'STOPPED' ? 'STOPPED' : 'CHECKING...');
                            if (statusEl) statusEl.textContent = txt;
                            if (headerEl) headerEl.textContent = txt;
                        } else {
                            const _as = document.getElementById('automation-status'); if (_as) { _as.textContent = 'CHECKING...'; }
                            const _ah = document.getElementById('automation-status-header'); if (_ah) { _ah.textContent = 'CHECKING...'; }
                        }
                    } catch (_) {
                        const _as = document.getElementById('automation-status'); if (_as) { _as.textContent = 'CHECKING...'; }
                        const _ah = document.getElementById('automation-status-header'); if (_ah) { _ah.textContent = 'CHECKING...'; }
                    }
                }

                // Get system info (safe parse)
                let __dbLooksConnected = false;
                try {
                    const systemResponse = await fetch('/api/system-info');
                    if (systemResponse.ok) {
                        const systemData = await systemResponse.json();
                        if (systemData && systemData.database) {
                            const sc = document.getElementById('stocks-count');
                            const pr = document.getElementById('price-records');
                            if (sc) sc.textContent = systemData.database.stocks || 0;
                            if (pr) pr.textContent = (systemData.database.price_records || 0).toLocaleString();
                            // If DB counts are returned, DB is reachable
                            __dbLooksConnected = true;
                        }
                    }
                } catch (_) { /* ignore */ }

                // Bulk predictions freshness (internal endpoint)
                try {
                    const resp = await fetch('/api/internal/bulk-predictions/status', {
                        headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                    });
                    if (resp.ok) {
                        const bj = await resp.json();
                        const cnt = (bj && typeof bj.predictions_count === 'number') ? bj.predictions_count : null;
                        const ageSec = (bj && typeof bj.age_seconds === 'number') ? bj.age_seconds : null;
                        const stale = (bj && typeof bj.stale !== 'undefined') ? !!bj.stale : null;
                        const fmtAge = (s) => {
                            if (typeof s !== 'number' || !isFinite(s)) return '--';
                            const h = Math.floor(s / 3600);
                            const m = Math.floor((s % 3600) / 60);
                            if (h > 0) return `${h}h ${m}m`;
                            return `${m}m`;
                        };
                        const cntEl = document.getElementById('bulk-count');
                        const ageEl = document.getElementById('bulk-age');
                        const staleEl = document.getElementById('bulk-stale');
                        if (cntEl) cntEl.textContent = (cnt !== null ? cnt : '--');
                        if (ageEl) ageEl.textContent = 'Age: ' + fmtAge(ageSec);
                        if (staleEl) {
                            if (stale === true) { staleEl.textContent = 'STALE'; staleEl.className = 'badge bg-danger'; }
                            else if (stale === false) { staleEl.textContent = 'FRESH'; staleEl.className = 'badge bg-success'; }
                            else { staleEl.textContent = '--'; staleEl.className = 'badge bg-secondary'; }
                        }
                    }
                } catch (e) { /* ignore */ }

                // Get health status using internal endpoint (tokened) to enable CPU/RAM/Disk
                let healthData = { health_check: { systems: {}, overall_status: 'unknown' } };
                try {
                    const healthResponse = await fetch('/api/internal/automation/health?v=' + Date.now(), {
                        headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                    });
                    if (healthResponse.ok) {
                        healthData = await healthResponse.json();
                    }
                } catch (_) { /* ignore, keep default */ }

                // If DB looked connected via /api/system-info, reflect it in health block
                try {
                    if (__dbLooksConnected) {
                        if (!healthData.health_check) healthData.health_check = { systems: {}, overall_status: 'unknown' };
                        if (!healthData.health_check.systems) healthData.health_check.systems = {};
                        healthData.health_check.systems.database = { status: 'connected' };
                    }
                } catch (_) { /* ignore */ }

                updateHealthStatus(healthData);
                updatePerformanceChart(healthData);
                
            // Update Recent Tasks & dynamic pipeline info
            await updateRecentTasks();
            await updatePipelineInfo();
            await loadCalibrationSummary();
                
                // Ba≈üarƒ±lƒ± g√ºncelleme log'unu 60 saniyede bir yaz (spam √∂nleme)
                if (!window.__lastOKLog || (Date.now() - window.__lastOKLog) > 60000) {
                    addLog('INFO', 'Dashboard updated successfully');
                    window.__lastOKLog = Date.now();
                }
        
    } catch (error) {
                console.error('Dashboard update error:', error);
                addLog('ERROR', `Dashboard update failed: ${error.message}`);
            }
        }

        // Update health status display
        function updateHealthStatus(healthData) {
            const healthContainer = document.getElementById('health-status');
            if (!healthData.health_check) {
                healthContainer.innerHTML = '<div class="alert alert-warning">Health data not available</div>';
                return;
            }
            const health = healthData.health_check;
            const systems = health.systems || {};
            const overall = (health.overall_status || 'unknown').toLowerCase();
            const badge = (s) => s === 'healthy' ? 'success' : (s === 'warning' ? 'warning' : (s === 'connected' ? 'success' : 'danger'));

            // Build modern card layout consistently with static HTML above
            const card = (title, subtitle, id, statusKey) => {
                const val = (statusKey && systems[statusKey]) ? (systems[statusKey].status || 'unknown') : (systems[title] && systems[title].status) || 'unknown';
                return `
                <div class="col-12">
                    <div class="p-3 rounded d-flex justify-content-between align-items-center" style="background:#f8f9fa;border:1px solid #e9ecef;">
                        <div>
                            <div class="fw-bold">${title}</div>
                            <small class="text-muted">${subtitle}</small>
                        </div>
                        <span class="badge bg-${badge(val)}" id="${id}">${val}</span>
                    </div>
                </div>`;
            };

            const html = `
            <div class="row g-3">
                <div class="col-12">
                    <div class="p-3 rounded d-flex justify-content-between align-items-center" style="background:#f8fff9;border:1px solid #e2f3e7;">
                        <div>
                            <div class="fw-bold">Overall Status</div>
                            <small class="text-muted">System Integration</small>
                        </div>
                        <span class="badge bg-${overall==='healthy'?'success':overall==='warning'?'warning':'danger'}" id="overall-status">${overall.toUpperCase()}</span>
                    </div>
                </div>
                ${card('Automation Engine','Background Processing','automation-status','automation_engine')}
                ${card('Flask API','Web Service','flask-status','flask_api')}
                ${card('Database','PostgreSQL Connection','db-status','database')}
                ${card('WebSocket','Real-time Updates','websocket-status','websocket')}
            </div>`;
            healthContainer.innerHTML = html;
        }

        // Update performance chart
        function updatePerformanceChart(healthData) {
            // Extract CPU/RAM/Disk metrics if available
            let cpu = null, mem = null, disk = null, loadAvg = null;
            try {
                const res = (healthData && healthData.health_check) ? healthData.health_check.system_resources : null;
                if (res) {
                    cpu = Number(res.cpu_percent);
                    mem = Number(res.memory_percent);
                    disk = Number(res.disk_percent);
                    loadAvg = Array.isArray(res.load_avg) ? res.load_avg[0] : null;
                }
            } catch (_) {}
            // Update gauge pointer text and labels
            try {
                document.getElementById('valCpu').textContent = Number.isFinite(cpu) ? cpu.toFixed(0) : '-';
                document.getElementById('valRam').textContent = Number.isFinite(mem) ? mem.toFixed(0) : '-';
                document.getElementById('valDisk').textContent = Number.isFinite(disk) ? disk.toFixed(0) : '-';
                document.getElementById('valLoad').textContent = loadAvg !== null ? loadAvg.toFixed(2) : '-';
                // Dynamic color band emphasis: adjust dataset data ratios based on value thresholds
                const updateBands = (chart, valPct)=>{
                    // valPct 0-100; we keep three segments Low/Med/High with same sizes, but tint by opacity
                    const colors = ['#2a9d8f','#ffd166','#ef476f'];
                    const idx = valPct >= 80 ? 2 : (valPct >= 50 ? 1 : 0);
                    const bg = colors.map((c,i)=> i===idx ? c : `${c}66`); // active band solid, others translucent
                    chart.data.datasets[0].backgroundColor = bg;
                    chart.update('none');
                };
                if (gaugeCpu && Number.isFinite(cpu)) updateBands(gaugeCpu, cpu);
                if (gaugeRam && Number.isFinite(mem)) updateBands(gaugeRam, mem);
                if (gaugeDisk && Number.isFinite(disk)) updateBands(gaugeDisk, disk);
                if (gaugeLoad && loadAvg !== null) {
                    // Normalize loadAvg (rough heuristic: 0-2 -> 0-100)
                    const pct = Math.max(0, Math.min(100, (loadAvg / 2) * 100));
                    updateBands(gaugeLoad, pct);
                }
            } catch (_) {}
        }

        // Calculate health score
        function calculateHealthScore(healthData) {
            if (!healthData.health_check || !healthData.health_check.systems) return 0;
            
            const systems = healthData.health_check.systems;
            const total = Object.keys(systems).length;
            const healthy = Object.values(systems).filter(s => s.status === 'healthy').length;
            
            return Math.round((healthy / total) * 100);
        }

        // Update Recent Tasks
        async function updateRecentTasks() {
            try {
                const response = await fetch('/api/recent-tasks');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const tasksContainer = document.getElementById('recent-tasks');
                
                if (data.status === 'success' && data.tasks && data.tasks.length > 0) {
                    const preferCount = parseInt(localStorage.getItem('tasksDisplayCount') || '4');
                    const MAX_TASKS_DISPLAY = Number.isFinite(preferCount) ? preferCount : 5;
                const tasksToRender = data.tasks.slice(0, MAX_TASKS_DISPLAY);
                let html = '';
                    
                    tasksToRender.forEach(task => {
                        const state = (task.status || '').toLowerCase();
                        const statusIcon = {
                            'completed': '‚úÖ',
                            'running': '‚è≥',
                            'failed': '‚ùå',
                            'pending': '‚è∞',
                            'start': '‚ñ∂Ô∏è',
                            'end': '‚úÖ',
                            'error': '‚ùå'
                        };
                        const badgeClass = {
                            'completed': 'bg-success',
                            'running': 'bg-primary',
                            'failed': 'bg-danger',
                            'pending': 'bg-warning',
                            'start': 'bg-primary',
                            'end': 'bg-success',
                            'error': 'bg-danger'
                        };
                        const badgeText = (state === 'start' || state === 'end' || state === 'error')
                            ? state.toUpperCase()
                            : (state || 'UNKNOWN').toUpperCase();
                        const phaseKey = String(task.task || '').toLowerCase();
                        const phase = (task.task || '').replace(/_/g, ' ');
                        const phaseColors = {
                            'incremental_cycle': '#0d6efd',
                            'ai_analysis': '#6f42c1',
                            'data_collection': '#0dcaf0',
                            'bulk_predictions': '#20c997',
                            'symbol_flow': '#ffc107'
                        };
                        const leftColor = phaseColors[phaseKey] || '#ced4da';
                        const repeatBadge = (task.repeat && task.repeat > 1) ? `<span class="badge bg-secondary ms-2">x${task.repeat}</span>` : '';
                        html += `
                            <div class="d-flex align-items-start mb-3 p-2 border-bottom" style="border-left:4px solid ${leftColor};">
                                <span class="me-2 fs-5">${statusIcon[state] || task.icon || 'üß©'}</span>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <strong class="small">${phase}</strong>
                                        <small class="text-muted">${task.timestamp}</small>
                                    </div>
                                    <div class="small text-muted">${task.description || ''}</div>
                                    <span class="badge ${badgeClass[state] || 'bg-secondary'}">${badgeText}</span>${repeatBadge}
                                </div>
                            </div>
                        `;
                    });

                    if (data.tasks.length > MAX_TASKS_DISPLAY) {
                        html += `
                            <div class="text-center text-muted small pb-1">
                                Showing ${MAX_TASKS_DISPLAY}/${data.tasks.length}. Panel kaydƒ±rƒ±labilir.
                            </div>
                        `;
                    }
                    
                    // Ensure at least 4 rows visible to avoid big empty area
                    const MIN_ROWS = 4;
                    if (tasksToRender.length < MIN_ROWS) {
                        for (let i = tasksToRender.length; i < MIN_ROWS; i++) {
                            html += `
                            <div class="d-flex align-items-start mb-3 p-2 border-bottom" style="border-left:4px solid transparent; opacity:0.6;">
                                <span class="me-2 fs-5">&nbsp;</span>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <strong class="small text-muted">‚Äî</strong>
                                        <small class="text-muted">‚Äî</small>
                                    </div>
                                    <div class="small text-muted">No more items</div>
                                    <span class="badge bg-light text-muted">&nbsp;</span>
                                </div>
                            </div>`;
                        }
                    }
                    tasksContainer.innerHTML = html;
                    console.log('‚úÖ Recent Tasks updated successfully');
                } else {
                    tasksContainer.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle"></i>
                            <p class="mt-2">No recent tasks available</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Recent Tasks update error:', error);
                const tasksContainer = document.getElementById('recent-tasks');
                tasksContainer.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p class="mt-2">Failed to load tasks</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // Dynamic pipeline info (header metrics)
        async function updatePipelineInfo() {
            try {
                // Read current automation status first to avoid stale phase display
                const statusRes = await fetch('/api/internal/automation/status', {
                    headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                });
                const statusJson = statusRes.ok ? await statusRes.json() : null;
                let isRunning = false;
                if (statusJson) {
                    // Try multiple sources for running status
                    isRunning = !!(statusJson.automation && statusJson.automation.running) ||
                               !!(statusJson.scheduler_status && statusJson.scheduler_status.is_running) ||
                               !!(statusJson.running);
                }

                const res = await fetch('/api/internal/automation/pipeline-history', {
                    headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                });
                if (!res.ok) return;
                const data = await res.json();
                const hist = (data.history || []);
                // Update Current Phase badge from last history entry
                const badge = document.getElementById('current-phase-badge');
                if (badge) {
                    let label = 'IDLE', cls = 'bg-secondary';
                    if (isRunning && hist.length > 0) {
                        // Find most recent 'start' entry to decide the phase reliably
                        let lastStart = null;
                        for (let i = hist.length - 1; i >= 0; i--) {
                            if (hist[i].state === 'start' && (hist[i].phase === 'data_collection' || hist[i].phase === 'ai_analysis' || hist[i].phase === 'incremental_cycle' || hist[i].phase === 'symbol_flow')) {
                                lastStart = hist[i];
                                break;
                            }
                        }
                        const phase = lastStart ? (lastStart.phase || '') : '';
                        const state = lastStart ? 'start' : '';
                        if (state === 'start') {
                            if (phase === 'data_collection') { label = 'Collecting'; cls = 'bg-info'; }
                            else if (phase === 'ai_analysis') { label = 'Analyzing'; cls = 'bg-primary'; }
                            else if (phase === 'incremental_cycle') { label = 'Incremental'; cls = 'bg-primary'; }
                            else if (phase === 'symbol_flow') { label = 'Symbol Flow'; cls = 'bg-warning'; }
                            else { label = 'Running'; cls = 'bg-primary'; }
                        } else if (state === 'end') {
                            label = 'Idle'; cls = 'bg-success';
                        } else if (state === 'error') {
                            label = 'Error'; cls = 'bg-danger';
                        }
                    } else if (!isRunning) {
                        label = 'Idle';
                        cls = 'bg-secondary';
                    }
                    badge.textContent = label.toUpperCase();
                    badge.className = `badge ${cls} ms-2`;
                }
                // Intentionally do not mirror pipeline history as log here to avoid misleading entries
            } catch (e) { /* ignore */ }
        }

        // Automation control functions
        async function startAutomation() {
            try {
                addLog('INFO', 'Starting automation...');
                console.log('üöÄ Starting automation via /api/internal/automation/start');
                const response = await fetch('/api/internal/automation/start?v=1.1', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw'
                    }
                });
                let data;
                try { data = await response.json(); } catch (_) { data = { status: 'error', message: `HTTP ${response.status}` }; }
                const okStatuses = ['started', 'already_running'];
                const logType = (response.ok && okStatuses.includes(String(data.status))) ? 'SUCCESS' : 'ERROR';
                addLog(logType, `Automation: ${data.message || data.status || 'Unknown response'}`);
                updateDashboard();
            } catch (error) {
                addLog('ERROR', `Start automation failed: ${error.message}`);
            }
        }

        async function stopAutomation() {
            try {
                addLog('INFO', 'Stopping automation...');
                console.log('üõë Stopping automation via /api/internal/automation/stop');
                const response = await fetch('/api/internal/automation/stop?v=1.1', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw'
                    }
                });
                let data;
                try { data = await response.json(); } catch (_) { data = { status: 'error', message: `HTTP ${response.status}` }; }
                const okStatuses = ['stopped', 'already_stopped'];
                const logType = (response.ok && okStatuses.includes(String(data.status))) ? 'SUCCESS' : 'ERROR';
                addLog(logType, `Automation: ${data.message || data.status || 'Unknown response'}`);
                updateDashboard();
            } catch (error) {
                addLog('ERROR', `Stop automation failed: ${error.message}`);
            }
        }

        async function runTask(taskName) {
            try {
                addLog('INFO', `Running task: ${taskName}...`);
                
                // Add loading state for long-running tasks
                const isLongTask = ['data_collection', 'model_retraining'].includes(taskName);
                if (isLongTask) {
                    addLog('INFO', `‚è≥ ${taskName} is a long-running task, please wait...`);
                }
                
                const headers = {
                    'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw',
                    'X-Internal-Request': 'true',
                    'Content-Type': 'application/json'
                };
                
                // Debug: Log request details
                console.log(`üîç Request: POST /api/internal/automation/run-task/${taskName}`);
                console.log('üîç Headers:', headers);
                
                const response = await fetch(`/api/internal/automation/run-task/${taskName}`, { 
                    method: 'POST',
                    headers: headers,
                    // Set appropriate timeout for long tasks
                    signal: isLongTask ? undefined : AbortSignal.timeout(30000) // 30s for short tasks
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const logType = data.status === 'success' ? 'SUCCESS' : 'ERROR';
                addLog(logType, `Task ${taskName}: ${data.message}`);
                
                // Show detailed results for successful tasks
                if (data.status === 'success' && data.result) {
                    const result = data.result;
                    if (typeof result === 'object') {
                        const details = Object.entries(result)
                            .filter(([k, v]) => k !== 'timestamp' && v !== undefined)
                            .map(([k, v]) => `${k}: ${v}`)
                            .join(', ');
                        if (details) {
                            addLog('INFO', `üìä ${taskName} details: ${details}`);
                        }
                    }
                }
                
                updateDashboard();
            } catch (error) {
                if (error.name === 'TimeoutError') {
                    addLog('WARNING', `Task ${taskName} timed out - may still be running in background`);
                } else {
                    addLog('ERROR', `Task ${taskName} failed: ${error.message}`);
                }
            }
        }

        let __reportChart = null;
        async function generateReport() {
            try {
                addLog('INFO', 'Generating system report...');
                const [repRes, histRes] = await Promise.all([
                    fetch('/api/admin/automation/report?v=' + Date.now()),
                    fetch('/api/internal/automation/pipeline-history?v=' + Date.now(), { headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' } })
                ]);
                const rep = repRes.ok ? await repRes.json() : { status: 'error' };
                const hist = histRes.ok ? await histRes.json() : { status: 'error' };
                renderReportModal(rep, hist);
                const modalEl = document.getElementById('reportModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
                addLog('SUCCESS', 'System report generated successfully');
            } catch (error) {
                addLog('ERROR', `Report generation failed: ${error.message}`);
            }
        }

        function renderReportModal(rep, hist) {
            try {
                const body = document.getElementById('reportModalBody');
                // Aggregate metrics since automation start
                const aggr = (rep && rep.report && rep.report.aggregates) ? rep.report.aggregates : {};
                const sinceStarted = (rep && rep.report) ? (rep.report.since_started || '') : '';
                const lastStats = (rep && rep.report && rep.report.last_run_stats) ? rep.report.last_run_stats : {};
                let cycle = Number(lastStats.cycle || 0);
                let analyzed = Number(lastStats.analyzed || 0);
                let collected = Number(lastStats.total_records || 0);
                let updated = Number(lastStats.updated_records || 0);

                const history = (hist && hist.history) ? hist.history.filter(h => h.phase === 'symbol_flow' && h.state === 'end') : [];
                // Fallback: if last_run_stats missing/zero, derive counters from last history end entry
                if ((cycle === 0 && history.length > 0) || (!lastStats || Object.keys(lastStats).length === 0)) {
                    const lastEnd = history[history.length - 1] || {};
                    const det = lastEnd.details || {};
                    cycle = Number(det.cycle || history.length || 0);
                    analyzed = Number(det.analyzed || 0);
                    collected = Number(det.collected_records || 0);
                    updated = Number(det.updated_records || 0);
                }

                // Volume tiers from backend report (if any)
                const volume = (rep && rep.report && rep.report.volume) ? rep.report.volume : null;
                const lookbackDays = volume ? Number(volume.lookback_days || 0) : 0;
                const recent = history.slice(-10);
                const rows = recent.map((r, idx) => {
                    const det = r.details || {};
                    return `<tr>
                        <td>${recent.length - idx}</td>
                        <td>${r.timestamp || ''}</td>
                        <td>${det.analyzed ?? '-'}</td>
                        <td>${det.collected_records ?? 0}</td>
                        <td>${det.updated_records ?? 0}</td>
                        <td>${det.total ?? '-'}</td>
                    </tr>`;
                }).join('');

                body.innerHTML = `
                    <div class="row g-3 mb-3">
                        <div class="col-6 col-md-3">
                            <div class="p-3 rounded text-center" style="background:#f8f9fa;border:1px solid #e9ecef;">
                                <div class="small text-muted">Cycle</div>
                                <div class="h4 mb-0">${cycle}</div>
                                <div class="small text-muted mt-1">since start: ${aggr.cycles ?? '-'}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 rounded text-center" style="background:#f8fff9;border:1px solid #e2f3e7;">
                                <div class="small text-muted">Analyzed</div>
                                <div class="h4 mb-0">${analyzed}</div>
                                <div class="small text-muted mt-1">since start: ${aggr.analyzed ?? '-'}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 rounded text-center" style="background:#f6fbff;border:1px solid #e3f0fb;">
                                <div class="small text-muted">Collected</div>
                                <div class="h4 mb-0">${collected}</div>
                                <div class="small text-muted mt-1">since start: ${aggr.collected ?? '-'}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 rounded text-center" style="background:#fffaf6;border:1px solid #fde8d9;">
                                <div class="small text-muted">Updated</div>
                                <div class="h4 mb-0">${updated}</div>
                                <div class="small text-muted mt-1">since start: ${aggr.updated ?? '-'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <div><strong>Since Started:</strong> <span class="text-muted">${sinceStarted || '-'}</span></div>
                                    <div><strong>Total Trainings:</strong> <span>${(aggr && (aggr.train_total ?? aggr.train_total === 0)) ? aggr.train_total : '-'}</span></div>
                                    <div><strong>Total Signals:</strong> <span>${(aggr && (aggr.signals_total ?? aggr.signals_total === 0)) ? aggr.signals_total : '-'}</span></div>
                                    <div><strong>YOLO Detections:</strong> <span>${(aggr && (aggr.yolo_detections ?? aggr.yolo_detections === 0)) ? aggr.yolo_detections : '-'}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label small">Volume Tier</label>
                            <select class="form-select form-select-sm" id="filterVolumeTier">
                                <option value="all" selected>All</option>
                                <option value="vh">Very High</option>
                                <option value="h">High</option>
                                <option value="m">Medium</option>
                                <option value="l">Low</option>
                                <option value="vl">Very Low</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Timeframe</label>
                            <select class="form-select form-select-sm" id="filterTimeframe" disabled>
                                <option value="1">1d</option>
                                <option value="3" selected>3d</option>
                                <option value="7">7d</option>
                                <option value="14">14d</option>
                                <option value="30">30d</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Search <span id="searchResultCount" class="text-muted"></span></label>
                            <div class="input-group input-group-sm">
                                <input class="form-control" id="filterSearch" placeholder="√ñrn: THYAO, T√ºrk Hava" />
                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-lg-6">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <canvas id="reportChart" height="220"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Recent Cycles</strong>
                                    <small class="text-muted">Last ${recent.length}</small>
                                </div>
                                <div class="table-responsive" style="max-height:260px;">
                                    <table class="table table-sm table-striped align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>#</th><th>Time</th><th>Analyzed</th><th>Collected</th><th>Updated</th><th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>${rows || ''}</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mt-3" id="volumeSection">
                        <div class="col-12">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Volume Tiers</strong>
                                    <small class="text-muted">Lookback: ${lookbackDays || '-'} days</small>
                                </div>
                                <div id="volumeSummary" class="mb-2"></div>
                                <div class="table-responsive" style="max-height:260px;">
                                    <table class="table table-sm table-striped align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Symbol</th><th>Avg Volume</th><th>Tier</th>
                                            </tr>
                                        </thead>
                                        <tbody id="volumeSymbolsList"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Build chart
                try {
                    const labels = recent.map((r) => (r.details && (r.details.cycle || ''))).map((v, i) => v || `#${cycle - (recent.length - i)}`);
                    const collectedArr = recent.map(r => (r.details && Number(r.details.collected_records || 0)) || 0);
                    const updatedArr = recent.map(r => (r.details && Number(r.details.updated_records || 0)) || 0);
                    const ctx = document.getElementById('reportChart').getContext('2d');
                    if (__reportChart) { try { __reportChart.destroy(); } catch (_) {} }
                    __reportChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Collected', data: collectedArr, backgroundColor: 'rgba(13, 110, 253, 0.6)' },
                                { label: 'Updated', data: updatedArr, backgroundColor: 'rgba(25, 135, 84, 0.6)' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                } catch (e) { /* ignore chart errors */ }
                // Volume tier rendering and filters
                try {
                    window.__reportVolume = volume || null;
                    const tierSel = document.getElementById('filterVolumeTier');
                    const searchInp = document.getElementById('filterSearch');
                    const sectionEl = document.getElementById('volumeSection');

                    function mapShortToTier(s) {
                        if (s === 'vh') return 'very_high';
                        if (s === 'h') return 'high';
                        if (s === 'm') return 'medium';
                        if (s === 'l') return 'low';
                        if (s === 'vl') return 'very_low';
                        return 'all';
                    }

                    function renderVolumeSymbols() {
                        const vol = window.__reportVolume;
                        const listEl = document.getElementById('volumeSymbolsList');
                        const sumEl = document.getElementById('volumeSummary');
                        if (!vol) {
                            if (sectionEl) sectionEl.style.display = 'none';
                            return;
                        }
                        if (sectionEl) sectionEl.style.display = '';
                        const all = Array.isArray(vol.symbols) ? vol.symbols : [];
                        const sum = vol.summary || {};
                        sumEl.innerHTML = `
                            <span class="badge bg-dark me-1">Very High: ${sum.very_high || 0}</span>
                            <span class="badge bg-primary me-1">High: ${sum.high || 0}</span>
                            <span class="badge bg-secondary me-1">Medium: ${sum.medium || 0}</span>
                            <span class="badge bg-warning text-dark me-1">Low: ${sum.low || 0}</span>
                            <span class="badge bg-light text-dark">Very Low: ${sum.very_low || 0}</span>
                        `;
                        const tierVal = (tierSel && tierSel.value) ? tierSel.value : 'all';
                        const q = (searchInp && searchInp.value ? searchInp.value : '').trim().toUpperCase();
                        let filtered = all.slice();
                        if (tierVal !== 'all') {
                            const target = mapShortToTier(tierVal);
                            filtered = filtered.filter(s => (s.tier || '') === target);
                        }
                        if (q) {
                            filtered = filtered.filter(s => {
                                const sym = String(s.symbol || '').toUpperCase();
                                const name = String(s.name || '').toUpperCase();
                                return sym.includes(q) || name.includes(q);
                            });
                        }
                        const rowsHtml = filtered.slice(0, 200).map(s => {
                            // Highlight search terms
                            let displayText = s.symbol;
                            if (s.name) displayText += ' - ' + s.name;
                            if (q) {
                                const regex = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                                displayText = displayText.replace(regex, '<mark>$1</mark>');
                            }
                            return `
                            <tr>
                                <td>${displayText}</td>
                                <td>${Number(s.avg_volume || 0).toLocaleString('tr-TR')}</td>
                                <td><span class="badge bg-secondary">${s.tier}</span></td>
                            </tr>
                        `;
                        }).join('');
                        
                        // Update search result count
                        const countEl = document.getElementById('searchResultCount');
                        if (countEl) {
                            if (q) {
                                countEl.textContent = `(${filtered.length} sonu√ß)`;
                                countEl.className = 'text-success';
                            } else {
                                countEl.textContent = '';
                            }
                        }
                        
                        listEl.innerHTML = rowsHtml || '<tr><td colspan="3" class="text-muted">Sonu√ß bulunamadƒ±</td></tr>';
                    }

                    if (volume) {
                        renderVolumeSymbols();
                        if (tierSel) tierSel.addEventListener('change', renderVolumeSymbols);
                        if (searchInp) {
                            // Remove existing listeners to prevent duplicates
                            searchInp.removeEventListener('input', renderVolumeSymbols);
                            searchInp.addEventListener('input', renderVolumeSymbols);
                            
                            // Enhanced keydown handler
                            searchInp.addEventListener('keydown', function(e){
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    renderVolumeSymbols();
                                    try { 
                                        if (sectionEl) sectionEl.scrollIntoView({behavior: 'smooth', block: 'start'}); 
                                    } catch (_) {}
                                } else if (e.key === 'Escape') {
                                    // Clear search on Escape
                                    searchInp.value = '';
                                    renderVolumeSymbols();
                                }
                            });
                        }
                    } else if (sectionEl) {
                        sectionEl.style.display = 'none';
                    }
                } catch (_) { /* ignore */ }

            } catch (e) {
                // Fallback content
                const body = document.getElementById('reportModalBody');
                body.innerHTML = '<div class="alert alert-warning">Report content could not be rendered.</div>';
            }
        }

        // Add log entry
        function addLog(level, message) {
            const logContainer = document.getElementById('live-logs');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'INFO': '#00ff00',
                'SUCCESS': '#00ff88',
                'WARNING': '#ffaa00',
                'ERROR': '#ff4444'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[level] || '#00ff00';
            logEntry.innerHTML = `[${timestamp}] [${level}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 100 log entries
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // Start live updates
        function startLiveUpdates() {
            // Reduce frequency to avoid log spam
            setInterval(updateDashboard, 15000);
        }

        // Clear search function for report modal
        function clearSearch() {
            const searchInp = document.getElementById('filterSearch');
            if (searchInp) {
                searchInp.value = '';
                // Trigger search update if renderVolumeSymbols exists
                if (typeof renderVolumeSymbols === 'function') {
                    renderVolumeSymbols();
                }
            }
        }

        // Initialize everything when page loads
        window.onload = function() {
            // Initialize WebSocket first
            initializeWebSocket();
            
            // Load initial dashboard data
            updateDashboard();
            
            // Restore tasks display count preference
            try {
                const sel = document.getElementById('tasks-count-select');
                const prefer = localStorage.getItem('tasksDisplayCount') || '5';
                sel.value = prefer;
                sel.addEventListener('change', function() {
                    localStorage.setItem('tasksDisplayCount', String(this.value));
                    updateRecentTasks();
                });
            } catch (_) { /* ignore */ }

            // Periodik g√ºncelleme: tek interval (20 sn)
            if (!window.__dashInterval) {
                window.__dashInterval = setInterval(() => {
                    updateDashboard();
                    updateRecentTasks();
                }, 20000);
            }
            
            addLog('INFO', 'üöÄ BIST Dashboard initialized with WebSocket support');
            
            // Initialize simulation monitoring
            checkSimulationStatus();
            setInterval(checkSimulationStatus, 30000); // Check every 30 seconds
        }

        // ==========================================
        // PAPER TRADING SIMULATION FUNCTIONS
        // ==========================================
        
        let currentSimulationId = null;
        
        // Start new simulation
        async function startSimulation() {
            const tradeAmountInput = document.getElementById('trade-amount');
            const durationSelect = document.getElementById('simulation-duration');
            const startBtn = document.getElementById('start-simulation-btn');
            const stopBtn = document.getElementById('stop-simulation-btn');
            
            const tradeAmount = parseFloat(tradeAmountInput.value) || 10000;
            const durationHours = parseInt(durationSelect.value) || 48;
            
            try {
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';
                
                const response = await fetch('/api/simulation/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        initial_balance: 100000,  // Unlimited budget
                        trade_amount: tradeAmount,  // Parametrik trade amount
                        duration_hours: durationHours,
                        session_name: `AI Test ${tradeAmount}‚Ç∫/signal ${durationHours}h - ${new Date().toLocaleDateString()}`
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentSimulationId = data.session.id;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    
                    updateSimulationUI(data.session);
                    addLog('SUCCESS', `‚úÖ Simulation started: ID ${currentSimulationId}`);
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                addLog('ERROR', `‚ùå Simulation start failed: ${error.message}`);
                alert('Simulation start failed: ' + error.message);
            } finally {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start 48h Test';
            }
        }
        
        // Stop current simulation
        async function stopSimulation() {
            if (!currentSimulationId) return;
            
            const stopBtn = document.getElementById('stop-simulation-btn');
            
            try {
                stopBtn.disabled = true;
                stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Stopping...';
                
                const response = await fetch(`/api/simulation/${currentSimulationId}/stop`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateSimulationUI(data.session);
                    addLog('INFO', `üõë Simulation stopped: ID ${currentSimulationId}`);
                    
                    document.getElementById('start-simulation-btn').disabled = false;
                    stopBtn.disabled = true;
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                addLog('ERROR', `‚ùå Simulation stop failed: ${error.message}`);
                alert('Simulation stop failed: ' + error.message);
            } finally {
                stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>Stop Test';
            }
        }
        
        // Check simulation status
        async function checkSimulationStatus() {
            try {
                // Get list of recent simulations
                const response = await fetch('/api/simulation/list');
                const data = await response.json();
                
                if (data.status === 'success' && data.sessions.length > 0) {
                    // Find active simulation
                    const activeSession = data.sessions.find(s => s.status === 'active');
                    
                    if (activeSession) {
                        currentSimulationId = activeSession.id;
                        await updateSimulationStatus(activeSession.id);
                    } else {
                        // No active simulation
                        resetSimulationUI();
                    }
                }
                
            } catch (error) {
                console.error('Simulation status check failed:', error);
            }
        }
        
        // Update simulation status with performance data
        async function updateSimulationStatus(sessionId) {
            try {
                const response = await fetch(`/api/simulation/${sessionId}/status`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const session = data.performance.session;
                    updateSimulationUI(session);
                    
                    // Update trade stats if available
                    if (data.performance.open_positions) {
                        updateTradeStats(data.performance);
                    }
                }
                
            } catch (error) {
                console.error('Simulation status update failed:', error);
            }
        }
        
        // Update simulation UI elements
        function updateSimulationUI(session) {
            document.getElementById('sim-status-text').textContent = 
                session.status === 'active' ? 'Simulation Running' : 'Simulation Completed';
            
            document.getElementById('sim-details').textContent = 
                `Started: ${new Date(session.start_time).toLocaleString()}`;
            
            document.getElementById('sim-balance').textContent = 
                `‚Ç∫${session.current_balance.toFixed(2)}`;
            
            const profitLoss = session.profit_loss_percentage;
            const profitElement = document.getElementById('sim-profit');
            profitElement.textContent = `${profitLoss >= 0 ? '+' : ''}${profitLoss.toFixed(2)}%`;
            profitElement.style.color = profitLoss >= 0 ? '#28a745' : '#dc3545';
            
            // Update stats
            document.getElementById('sim-trades').textContent = session.total_trades;
            document.getElementById('sim-winrate').textContent = `${session.win_rate.toFixed(1)}%`;
            
            // Calculate runtime from session times
            let runtimeHours = 0;
            try {
                const start = new Date(session.start_time);
                const end = session.end_time ? new Date(session.end_time) : new Date();
                runtimeHours = Math.max(0, (end - start) / 3600000);
            } catch (e) {
                runtimeHours = 0;
            }
            let runtimeText;
            if (runtimeHours < 1) {
                const runtimeMinutes = Math.floor(runtimeHours * 60);
                runtimeText = `${runtimeMinutes}m`;
            } else {
                runtimeText = `${runtimeHours.toFixed(1)}h`;
            }
            document.getElementById('sim-runtime').textContent = runtimeText;
            
            // Show stats panel
            document.getElementById('simulation-stats').style.display = 'block';
            
            // Update button states
            const isActive = session.status === 'active';
            document.getElementById('start-simulation-btn').disabled = isActive;
            document.getElementById('stop-simulation-btn').disabled = !isActive;
        }
        
        // Reset simulation UI to default state
        function resetSimulationUI() {
            document.getElementById('sim-status-text').textContent = 'No Active Simulation';
            document.getElementById('sim-details').textContent = 'Start a new simulation to test AI performance';
            document.getElementById('sim-balance').textContent = '‚Ç∫0.00';
            document.getElementById('sim-profit').textContent = '¬±0%';
            document.getElementById('sim-profit').style.color = '#6c757d';
            
            document.getElementById('simulation-stats').style.display = 'none';
            
            document.getElementById('start-simulation-btn').disabled = false;
            document.getElementById('stop-simulation-btn').disabled = true;
            
            currentSimulationId = null;
        }
        
        // View detailed simulation results
        function viewSimulationDetails() {
            if (currentSimulationId) {
                // Open simulation details in new tab/modal
                window.open(`/api/simulation/${currentSimulationId}/status`, '_blank');
            } else {
                alert('No active simulation to view');
            }
        }
        
        // Update trade statistics
        function updateTradeStats(performance) {
            const trades = performance.trades || [];
            const recentTrades = trades.slice(0, 5); // Last 5 trades
            
            // Could add more detailed trade info here
            console.log('Recent trades:', recentTrades);
        }

        async function loadCoverage(){
            try{
                const resp = await fetch('/api/internal/pattern-cache/coverage', { headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }});
                if(!resp.ok) return;
                const j = await resp.json();
                const total = Number(j.total_active||0);
                const have = Number(j.with_cache||0);
                const miss = Number(j.without_cache||0);
                const avg = typeof j.avg_age_seconds==='number' ? j.avg_age_seconds : null;
                const fmt = (s)=>{
                    if(typeof s!=='number'||!isFinite(s)) return '--';
                    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60); return h>0?`${h}h ${m}m`:`${m}m`;
                };
                const el = document.getElementById('coverage-stats');
                if(el) el.textContent = `${have}/${total} (missing ${miss})`;
                const ageEl = document.getElementById('coverage-age');
                if(ageEl) ageEl.textContent = `avg age: ${fmt(avg)}`;
            }catch(e){}
        }

        async function refreshBulkNow(){
            try{
                const btn = document.getElementById('btn-refresh-bulk');
                if(btn){ btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Refreshing'; }
                const resp = await fetch('/api/internal/bulk-predictions/refresh', { method:'POST', headers:{ 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }});
                const j = await resp.json().catch(()=>({}));
                console.log('bulk refresh result', j);
                await updateDashboard();
            }catch(e){} finally{
                const btn = document.getElementById('btn-refresh-bulk');
                if(btn){ btn.disabled=false; btn.innerHTML='<i class="fas fa-rotate"></i> Refresh'; }
            }
        }

        async function loadCalibrationSummary(){
            try{
                const el = document.getElementById('calibration-summary');
                if(!el) return;
                // Prefer internal endpoint with token; fall back to admin if needed
                let resp = await fetch('/api/internal/calibration/summary?v=' + Date.now(), { headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }});
                if(!resp.ok){
                    resp = await fetch('/api/admin/calibration/summary?v=' + Date.now());
                }
                if(!resp.ok){ el.textContent = 'Unavailable'; return; }
                const j = await resp.json();
                const ps = (j && j.param_store && j.param_store.horizons) ? j.param_store.horizons : {};
                const m7 = j.metrics_7d || {};
                const m30 = j.metrics_30d || {};
                const ab7 = j.ab_7d || {};
                const genAt = (j && j.param_store && j.param_store.generated_at) ? j.param_store.generated_at : '-';
                // Header
                let html = `<div class="mb-2"><small class="text-muted">Kalibrasyon tarihi:</small> <code>${genAt}</code>
                <div class="small text-muted">G√ºven deƒüeri isotonic kalibrasyon ile d√ºzeltilir; e≈üikler sinyal kalitesi i√ßin optimize edilir.</div></div>`;
                // Helper (hoisted) for badge colors
                function pickColor(v){ if(v===null) return '#e9ecef'; if(v>=70) return '#2a9d8f'; if(v>=50) return '#ffd166'; return '#ef476f'; }
                // Rows with mini gauge + mini reliability
                ['1d','3d','7d','14d','30d'].forEach((h,i)=>{
                    const th = (ps[h] && ps[h].thresholds) ? ps[h].thresholds : {};
                    const iso = (ps[h] && ps[h].isotonic) ? ps[h].isotonic : [];
                    const accPct = (m7[h] && typeof m7[h].acc==='number') ? (m7[h].acc*100) : null;
                    const accStr = accPct!==null ? accPct.toFixed(1)+'%' : '-';
                    const cnt = (m7[h] && m7[h].count) ? m7[h].count : 0;
                    const accPct30 = (m30[h] && typeof m30[h].acc==='number') ? (m30[h].acc*100) : null;
                    const accStr30 = accPct30!==null ? accPct30.toFixed(1)+'%' : '-';
                    const cnt30 = (m30[h] && m30[h].count) ? m30[h].count : 0;
                    const lowSample = ((cnt>0 && cnt<30) || (cnt30>0 && cnt30<30));
                    const abb = (ab7 && ab7[h]) ? ab7[h] : {};
                    const prodAcc = (abb && abb.prod && typeof abb.prod.acc==='number') ? (abb.prod.acc*100) : null;
                    const prodN = (abb && abb.prod && typeof abb.prod.n==='number') ? abb.prod.n : 0;
                    const challAcc = (abb && abb.chall && typeof abb.chall.acc==='number') ? (abb.chall.acc*100) : null;
                    const challN = (abb && abb.chall && typeof abb.chall.n==='number') ? abb.chall.n : 0;
                    const gaugeId = `calibGauge_${h}`;
                    const gaugeId30 = `calibGauge30_${h}`;
                    const relId = `relChart_${h}`;
                    html += `
                      <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div class="flex-grow-1 pe-2">
                          <div class="d-flex align-items-center">
                            <span class="badge bg-light text-dark me-2">${h}</span>
                            <small>Œî‚â•${((th.delta_thr??0.03)*100).toFixed(1)}% ¬∑ conf‚â•${(th.conf_thr??0.65)}</small>
                            ${lowSample ? '<span class="badge bg-warning text-dark ms-2">d√º≈ü√ºk √∂rnek</span>':''}
                          </div>
                          <div class="small text-muted">Kapsama & doƒüruluk (7g): <strong>${accStr}</strong> <span class="text-muted">(n=${cnt})</span> ¬∑ 30g: <strong>${accStr30}</strong> <span class="text-muted">(n=${cnt30})</span></div>
                          <div class="small mt-1">
                            <span class="badge me-1" style="background:${pickColor(prodAcc)};">Prod ${prodAcc!==null?prodAcc.toFixed(1)+'%':'-'}</span>
                            <span class="text-muted">(n=${prodN||0})</span>
                            <span class="badge ms-2 me-1" style="background:${pickColor(challAcc)};">Chall ${challAcc!==null?challAcc.toFixed(1)+'%':'-'}</span>
                            <span class="text-muted">(n=${challN||0})</span>
                            <small class="text-muted ms-2">A/B (7g)</small>
                          </div>
                        </div>
                        <div class="d-flex align-items-center" style="gap:8px;">
                          <canvas id="${gaugeId}" width="70" height="40"></canvas>
                          <canvas id="${gaugeId30}" width="70" height="40"></canvas>
                          <canvas id="${relId}" width="80" height="40"></canvas>
                        </div>
                      </div>`;
                });
                el.innerHTML = html;
                // Render gauges and reliability charts
                const makeGauge = (id, pct)=>{
                    const ctx = document.getElementById(id);
                    if(!ctx) return;
                    const active = pct!==null ? pct : 0;
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: { datasets: [{
                            data: [active, Math.max(0,100-active)],
                            backgroundColor: [pickColor(pct), '#e9ecef'],
                            borderWidth: 0,
                            circumference: 180,
                            rotation: -90,
                            cutout: '70%'
                        }]},
                        options: {responsive:false, plugins:{legend:{display:false}, tooltip:{enabled:false}}}
                    });
                };
                const makeReliability = (id, isoPairs)=>{
                    const ctx = document.getElementById(id);
                    if(!ctx) return;
                    // X: tahmin g√ºveni (%), Y: ger√ßek isabet (%)
                    const xs = (isoPairs||[]).map(p=> (Array.isArray(p)? p[0]: (p.c_in||0))*100);
                    const ys = (isoPairs||[]).map(p=> (Array.isArray(p)? p[1]: (p.c_out||0))*100);
                    const diag = [0,25,50,75,100];
                    new Chart(ctx, {
                        type: 'line',
                        data: { labels: xs.length? xs : [0,100],
                            datasets: [
                              {label:'ƒ∞deal', data: diag, borderColor:'#ced4da', borderWidth:1, pointRadius:0, fill:false, tension:0.2},
                              {label:'Kalibre', data: ys, borderColor:'#6c757d', borderWidth:2, pointRadius:0, fill:false, tension:0.2}
                            ]
                        },
                        options: {responsive:false, plugins:{legend:{display:false}, tooltip:{enabled:false}}, scales:{x:{display:false}, y:{display:false, min:0, max:100}}}
                    });
                };
                ['1d','3d','7d','14d','30d'].forEach(h=>{
                    const accPct7 = (m7[h] && typeof m7[h].acc==='number') ? (m7[h].acc*100) : null;
                    const accPct30 = (m30[h] && typeof m30[h].acc==='number') ? (m30[h].acc*100) : null;
                    makeGauge(`calibGauge_${h}`, accPct7);
                    makeGauge(`calibGauge30_${h}`, accPct30);
                    const iso = (ps[h] && ps[h].isotonic) ? ps[h].isotonic : [];
                    makeReliability(`relChart_${h}`, iso);
                });
            }catch(e){
                const el = document.getElementById('calibration-summary');
                if(el) el.textContent = 'Error loading';
            }
        }
</script>
</body>
</html>