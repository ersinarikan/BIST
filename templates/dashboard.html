<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIST AI System - Real-time Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        // üöÄ CACHE BUSTER & VERSION CONTROL
        const DASHBOARD_VERSION = '2025.10.17.SimulationDetailsEnhanced.1.0';
        const CACHE_BUSTER = 1760351102;
        console.log('üéØ BIST Dashboard - Version:', DASHBOARD_VERSION, 'Cache:', CACHE_BUSTER);
        
        // Force refresh indicator
        if (localStorage.getItem('dashboardVersion') !== DASHBOARD_VERSION) {
            localStorage.setItem('dashboardVersion', DASHBOARD_VERSION);
            console.log('‚úÖ Dashboard version updated - forcing fresh data');
        }
        
        // üîó WebSocket Connection
        let socket = null;
        let isConnected = false;
        
        function initializeWebSocket() {
            socket = io({ 
                path: '/socket.io',
                transports: ['polling', 'websocket'],
                upgrade: true,
                secure: window.location.protocol === 'https:',
                rejectUnauthorized: false,
                withCredentials: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 20,
                timeout: 60000,
                maxReconnectionAttempts: 20
            });
            
            socket.on('connect', function() {
                isConnected = true;
                window._reconnectAttempts = 0; // Reset reconnect counter on successful connection
                console.log('üîó WebSocket connected:', socket.id);
                addLog('SUCCESS', 'üîó Real-time connection established');
                
                // Join admin room
                socket.emit('join_admin');
                
                // Update connection status in navbar
                try {
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-success"></i> Connected';
                    }
                } catch (e) {
                    console.warn('Navbar connection status update error:', e);
                }
                
                // Update connection status in panel
                try {
                    const wsStatusElement = document.getElementById('websocket-status');
                    if (wsStatusElement) {
                        wsStatusElement.textContent = 'connected';
                        wsStatusElement.className = 'badge bg-success';
                    }
                } catch (e) {
                    console.warn('WebSocket status update error:', e);
                }
            });
            
            socket.on('disconnect', function() {
                isConnected = false;
                console.log('‚ùå WebSocket disconnected');
                addLog('ERROR', '‚ùå Real-time connection lost');
                
                // Update connection status in navbar
                try {
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-danger"></i> Disconnected';
                    }
                } catch (e) {
                    console.warn('Navbar connection status update error:', e);
                }
                
                // Update connection status in panel
                try {
                    const wsStatusElement = document.getElementById('websocket-status');
                    if (wsStatusElement) {
                        wsStatusElement.textContent = 'disconnected';
                        wsStatusElement.className = 'badge bg-danger';
                    }
                } catch (e) {
                    console.warn('WebSocket status update error:', e);
                }
                // Controlled reconnect attempt with exponential backoff
                try { 
                    if (!window._reconnectAttempts) window._reconnectAttempts = 0;
                    window._reconnectAttempts++;
                    const delay = Math.min(30000, 1500 * Math.pow(2, window._reconnectAttempts - 1));
                    setTimeout(() => { 
                        if (socket && !socket.connected && window._reconnectAttempts < 10) { 
                            socket.connect(); 
                        }
                    }, delay); 
                } catch (e) {}
            });

            socket.on('connect_error', function(err) {
                try {
                    const msg = (err && (err.message || err.description || err.type || err.name)) || String(err);
                    console.error('‚ùå WebSocket connect_error:', err);
                    addLog('ERROR', `‚ùå WebSocket connect_error: ${msg}`);
                    
                    // Update connection status in navbar on connect error
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-danger"></i> Connection Error';
                    }
                } catch (_) {}
            });

            socket.on('reconnect', function() {
                console.log('üîÑ WebSocket reconnected');
                addLog('SUCCESS', 'üîÑ Real-time connection restored');
                
                // Rejoin admin room after reconnection
                socket.emit('join_admin');
                
                // Update connection status in navbar
                try {
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-success"></i> Connected';
                    }
                } catch (e) {
                    console.warn('Navbar connection status update error:', e);
                }
                
                // Update connection status in panel
                try {
                    const wsStatusElement = document.getElementById('websocket-status');
                    if (wsStatusElement) {
                        wsStatusElement.textContent = 'connected';
                        wsStatusElement.className = 'badge bg-success';
                    }
                } catch (e) {
                    console.warn('WebSocket status update error:', e);
                }
            });

            socket.on('reconnect_attempt', function() {
                console.log('üîÑ Attempting to reconnect...');
                addLog('INFO', 'üîÑ Attempting to reconnect...');
                
                // Update connection status in navbar during reconnect attempt
                try {
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-warning"></i> Reconnecting...';
                    }
                } catch (e) {
                    console.warn('Navbar connection status update error:', e);
                }
            });

            socket.on('reconnect_failed', function() {
                console.log('‚ùå Reconnection failed');
                addLog('ERROR', '‚ùå Reconnection failed - please refresh page');
                
                // Update connection status in navbar when reconnection fails
                try {
                    const connectionStatusElement = document.getElementById('connection-status');
                    if (connectionStatusElement) {
                        connectionStatusElement.innerHTML = '<i class="fas fa-wifi text-danger"></i> Connection Failed';
                    }
                } catch (e) {
                    console.warn('Navbar connection status update error:', e);
                }
            });
            
            socket.on('room_joined', function(data) {
                console.log('üë§ Joined room:', data.room);
                addLog('INFO', `üë§ ${data.message}`);
            });
            
            socket.on('log_update', function(data) {
                // ‚úÖ FIX: Only show working automation logs (filter out HPO and other logs)
                const category = (data.category || '').toLowerCase();
                const service = (data.service || '').toLowerCase();
                
                // ‚úÖ CRITICAL: Only show logs explicitly marked as 'working_automation'
                // Working automation now uses category='working_automation' and service='working_automation'
                // This distinguishes it from HPO logs which use different categories
                const isWorkingAutomationLog = 
                    category === 'working_automation' || 
                    service === 'working_automation';
                
                // Only show working automation logs - no other filtering needed
                if (isWorkingAutomationLog) {
                    addLog(data.level.toUpperCase(), data.message, data.category);
                }
                // All other logs (HPO, gunicorn, system, etc.) are filtered out
            });
            
            socket.on('pattern_analysis', function(data) {
                console.log('üìä Pattern analysis received:', data.symbol);
                addLog('INFO', `üìä Pattern analysis updated for ${data.symbol}`);
                // Auto-refresh dashboard when new analysis arrives
                updateDashboard();
                // Also update recent tasks to show new trading activity
                setTimeout(updateRecentTasks, 1000);
            });
            
            socket.on('error', function(data) {
                console.error('‚ùå Socket error:', data.message);
                addLog('ERROR', `‚ùå ${data.message}`);
            });
            
            // Real-time simulation updates
            socket.on('simulation_trade', function(data) {
                console.log('üí∞ Simulation trade received:', data);
                addLog('INFO', `üí∞ ${data.trade_type}: ${data.symbol} @ ${data.price}‚Ç∫`);
                // Update recent tasks immediately
                updateRecentTasks();
                // Update simulation status if currently shown
                if (currentSimulationId) {
                    checkSimulationStatus();
                }
            });
            
            // Task updates
            socket.on('task_update', function(data) {
                console.log('üìã Task update received:', data);
                updateRecentTasks();
            });
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                statusEl.innerHTML = connected ? 
                    '<i class="fas fa-wifi text-success"></i> Real-time' : 
                    '<i class="fas fa-wifi text-danger"></i> Disconnected';
            }
        }
    </script>
    
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .status-healthy { color: #28a745; }

        /* Automation status styles */
        #automation-status { text-transform: lowercase; }
        #automation-status-header { text-transform: uppercase; color: #000; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .status-unknown { color: #6c757d; }
        
        .metric-card {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        /* Recent tasks panel: let flexbox control height */
        #recent-tasks {
            overflow-y: auto;
        }
        /* Stretch recent tasks list to fill its card height */
        .recent-card { display: flex; flex-direction: column; }
        .recent-card #recent-tasks { flex: 1 1 auto; max-height: none; min-height: 0; overflow-y: auto; }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .chart-container {
            position: relative;
            height: 150px;
            margin: 12px 0;
        }

        .gauge-box { height: 120px; display:flex; align-items:center; justify-content:center; }
        .mid-six {
            min-height: 540px;
            height: 540px;
            overflow: hidden;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Make mid-six panels content flexible without scrollbars */
        .mid-six > div:last-child {
            flex: 1 1 auto;
            overflow: hidden;
        }
        
        /* Hide scrollbars in all panel content areas */
        .dashboard-card {
            overflow: hidden;
        }
        
        .dashboard-card * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }
        
        .dashboard-card *::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        /* Match all panels' height to System Health card height on desktop */
        /* reset row sync */

        /* Make Recent Tasks fill card */
        .recent-fixed { position: relative; }
        #recent-card #recent-tasks { flex: 1 1 auto; min-height: 0; overflow-y: auto; }

        /* Make columns equal height for the 3-up row */
        .equal-panels > [class^="col-"],
        .equal-panels > [class*=" col-"] {
            display: flex;            /* make columns flex containers */
        }
        .equal-panels .dashboard-card {
            flex: 1 1 auto;          /* let cards stretch to column height */
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Ensure proper spacing and alignment for middle 6 panels */
        .equal-panels.g-4 {
            margin-bottom: 2rem;
        }
        
        /* Make content areas flexible within cards */
        .equal-panels .dashboard-card > div:last-child {
            flex: 1 1 auto;
        }

        /* Equalize top metric cards */
        .metric-grid .metric-card {
            height: 120px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .metric-grid .metric-card .metric-value { margin-bottom: 4px; line-height: 1; }
        #bulk-age { position: absolute; bottom: 10px; left: 10px; }
        
        /* Responsive improvements */
        @media (max-width: 991.98px) {
            .mid-six {
                min-height: 350px;
                height: auto;
                overflow: hidden;
            }
            
            .equal-panels .dashboard-card {
                margin-bottom: 1.5rem;
            }
        }
        
        @media (max-width: 767.98px) {
            .mid-six {
                min-height: 300px;
                height: auto;
                overflow: hidden;
            }
            
            .metric-grid .metric-card {
                height: 100px;
            }
            
            .container-fluid {
                padding-left: 15px;
                padding-right: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-robot me-2"></i>lotlot.net y√∂netim paneli</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="connection-status">
                    <i class="fas fa-wifi text-warning"></i> Connecting...
                </span>
                <span class="navbar-text me-3">
                    <i class="fas fa-circle pulse status-healthy"></i> Live Monitoring
                </span>
                <span class="navbar-text me-3" id="last-update">
                    Last update: <span id="timestamp">--:--:--</span>
                </span>
                <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#simulationHelpModal" 
                        title="Sim√ºlasyon Kullanƒ±m Kƒ±lavuzu">
                    <i class="fas fa-question-circle me-1"></i>Sim√ºlasyon Yardƒ±mƒ±
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row equal-panels">
            <!-- System Overview -->
            <div class="col-12 mb-4">
                <div class="dashboard-card p-4">
                    <h3><i class="fas fa-tachometer-alt me-2"></i>System Overview</h3>
                    <div class="row mt-3 metric-grid">
                <div class="col-md-3">
                            <div class="metric-card text-center">
                                <div class="metric-value" id="automation-status-header">--</div>
                                <div class="metric-label">Automation Status</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center" style="background: linear-gradient(45deg, #ffd86f 0%, #fc6262 100%);">
                                <div class="metric-value" id="bulk-count">--</div>
                                <div class="metric-label">Bulk Predictions (records)</div>
                                <div class="small" id="bulk-age" style="opacity:.9">Age: --</div>
                                <span class="badge bg-secondary" id="bulk-stale" style="position:absolute; top:10px; right:10px;">--</span>
                                <button class="btn btn-sm btn-light" style="position:absolute; bottom:10px; right:10px;" id="btn-refresh-bulk" onclick="refreshBulkNow()"><i class="fas fa-rotate"></i> Refresh</button>
                            </div>
                        </div>
                <div class="col-md-3">
                            <div class="metric-card text-center" style="background: linear-gradient(45deg, #4ecdc4 0%, #44a08d 100%);">
                                <div class="metric-value" id="stocks-count">--</div>
                                <div class="metric-label">Stocks in DB</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center" style="background: linear-gradient(45deg, #ffecd2 0%, #fcb69f 100%); color: #333;">
                                <div class="metric-value" id="price-records">--</div>
                                <div class="metric-label">Price Records</div>
                </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Middle 6 Panels in 2x3 Grid -->
        <div class="row equal-panels g-4 mb-4">
            <!-- System Health -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div class="dashboard-card mid-six p-4 w-100 recent-card" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4><i class="fas fa-heartbeat me-2 text-success"></i>System Health</h4>
                    <div id="health-status" class="mt-3" style="max-height: 430px; overflow-y: auto; overflow-x: hidden; scrollbar-gutter: stable both-edges;">
                        <!-- Compact card layout (Overall, Automation, Flask, DB, WebSocket) -->
                        <div class="row g-2">
                            <div class="col-12">
                                <div class="p-2 rounded d-flex justify-content-between align-items-center" style="background:#f8fff9;border:1px solid #e2f3e7;">
                                    <div>
                                        <div class="fw-bold small">Overall Status</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">System Integration</small>
                                    </div>
                                    <span class="badge bg-success" id="overall-status" style="font-size: 0.7rem;">MIGRATED</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-2 rounded d-flex justify-content-between align-items-center" style="background:#f6fbff;border:1px solid #e3f0fb;">
                                    <div>
                                        <div class="fw-bold small">Automation Engine</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">Background Processing</small>
                                    </div>
                                    <span class="badge bg-info" id="automation-status" style="font-size: 0.7rem;">active</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-2 rounded d-flex justify-content-between align-items-center" style="background:#fffaf6;border:1px solid #fde8d9;">
                                    <div>
                                        <div class="fw-bold small">Flask API</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">Web Service</small>
                                    </div>
                                    <span class="badge bg-success" id="flask-status" style="font-size: 0.7rem;">healthy</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-2 rounded d-flex justify-content-between align-items-center" style="background:#fdf9ff;border:1px solid #efe3fb;">
                                    <div>
                                        <div class="fw-bold small">Database</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">PostgreSQL Connection</small>
                                    </div>
                                    <span class="badge bg-success" id="db-status" style="font-size: 0.7rem;">connected</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-2 rounded d-flex justify-content-between align-items-center" style="background:#f9fdff;border:1px solid #e3f7ff;">
                                    <div>
                                        <div class="fw-bold small">WebSocket</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">Real-time Updates</small>
                                    </div>
                                    <span class="badge bg-success" id="websocket-status" style="font-size: 0.7rem;">connected</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Automation Control -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div id="automation-control-card" class="dashboard-card mid-six p-4 w-100" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4><i class="fas fa-cogs me-2 text-primary"></i>Automation Control</h4>
                    <div class="row g-2 mt-3">
                        <div class="col-6">
                            <button class="btn btn-success w-100 py-2" onclick="startAutomation()">
                                <i class="fas fa-play me-1"></i><small>Start</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-danger w-100 py-2" onclick="stopAutomation()">
                                <i class="fas fa-stop me-1"></i><small>Stop</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-warning w-100 py-2" onclick="runTask('health_check')">
                                <i class="fas fa-stethoscope me-1"></i><small>Health</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-info w-100 py-2" onclick="runTask('data_collection')">
                                <i class="fas fa-database me-1"></i><small>Data</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-primary w-100 py-2" onclick="runTask('model_retraining')">
                                <i class="fas fa-brain me-1"></i><small>Retrain</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-secondary w-100 py-2" onclick="generateReport()">
                                <i class="fas fa-file-alt me-1"></i><small>Report</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calibration Summary Panel -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div id="recent-card" class="dashboard-card mid-six p-4 recent-fixed w-100" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 class="d-flex align-items-center justify-content-between">
                        <span><i class="fas fa-sliders-h me-2 text-success"></i>Calibration Summary</span>
                        <span id="calibration-readiness-badge" class="badge bg-secondary">Y√ºkleniyor</span>
                    </h4>
                    <div id="calibration-summary" class="mt-3 small text-muted" style="max-height: 430px; overflow-y: auto; overflow-x: hidden; scrollbar-gutter: stable both-edges;">Loading...</div>
                </div>
            </div>

            <!-- System Performance -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div class="dashboard-card mid-six p-4 w-100" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4><i class="fas fa-chart-line me-2"></i>System Performance</h4>
                    <div class="row g-3">
                        <div class="col-6 text-center">
                            <div class="gauge-box"><canvas id="gaugeCpu"></canvas></div>
                            <div class="small mt-1"><strong>CPU</strong>: <span id="valCpu">-</span>%</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="gauge-box"><canvas id="gaugeRam"></canvas></div>
                            <div class="small mt-1"><strong>RAM</strong>: <span id="valRam">-</span>%</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="gauge-box"><canvas id="gaugeDisk"></canvas></div>
                            <div class="small mt-1"><strong>Disk</strong>: <span id="valDisk">-</span>%</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="gauge-box"><canvas id="gaugeLoad"></canvas></div>
                            <div class="small mt-1"><strong>Load</strong>: <span id="valLoad">-</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cache Coverage + AI Simulation Panel -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div class="dashboard-card mid-six p-4 w-100" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h5><i class="fas fa-database me-2 text-info"></i>Cache Coverage</h5>
                    <div id="coverage-box" class="mb-2">
                        <div class="d-flex justify-content-between align-items-center p-2 rounded" style="background:#f8f9fa;border:1px solid #dee2e6;">
                            <div>
                                <div class="small text-muted">Pattern cache</div>
                                <div class="fw-bold" id="coverage-stats" style="font-size: 0.9rem;">-- / --</div>
                            </div>
                            <span class="badge bg-secondary" id="coverage-age" style="font-size: 0.7rem;">--</span>
                        </div>
                        <div class="mt-1 d-flex gap-1">
                            <button class="btn btn-sm btn-outline-secondary py-1" onclick="loadCoverage()" style="font-size: 0.75rem;"><i class="fas fa-sync"></i></button>
                            <button class="btn btn-sm btn-outline-primary py-1" onclick="refreshBulkNow()" style="font-size: 0.75rem;"><i class="fas fa-rotate"></i></button>
                        </div>
                    </div>
                    
                    <h5><i class="fas fa-robot me-2 text-info"></i>AI Simulation</h5>
                    <div class="small text-muted mb-2">Virtual trading - 606 hisse</div>
                    
                    <!-- Scrollable simulation area -->
                    <div style="max-height: 350px; overflow-y: auto; padding-right: 5px;">
                        <!-- Status -->
                        <div id="simulation-status" class="mb-2">
                            <div class="p-2 rounded" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                                <div class="small fw-bold text-dark" id="sim-status-text">No Active Simulation</div>
                                <small class="text-muted" id="sim-details" style="font-size: 0.7rem;">Start a new simulation to test AI performance</small>
                            </div>
                        </div>
                        
                        <!-- Controls -->
                        <div class="row g-1">
                        <div class="col-4">
                            <button class="btn btn-success w-100 py-1 mb-1" id="start-simulation-btn" onclick="startSimulation()" style="font-size: 0.8rem;">
                                <i class="fas fa-play me-1"></i>Start
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-danger w-100 py-1 mb-1" id="stop-simulation-btn" onclick="stopSimulation()" disabled style="font-size: 0.8rem;">
                                <i class="fas fa-stop me-1"></i>Stop
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-outline-secondary w-100 py-1 mb-1" onclick="openSimDetails()" style="font-size: 0.8rem;">
                                <i class="fas fa-list me-1"></i>Details
                            </button>
                        </div>
                        <div class="col-12">
                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text" style="font-size: 0.75rem;">‚Ç∫</span>
                                <input type="number" class="form-control" id="trade-amount" value="10000" min="1000" max="50000" style="font-size: 0.75rem;">
                            </div>
                            <!-- Strategy params -->
                            <div class="row g-1 mb-2">
                                <div class="col-6">
                                    <label class="form-label mb-0" style="font-size:0.7rem;">Horizon</label>
                                    <select class="form-select form-select-sm" id="sim-horizon" style="font-size:0.8rem;">
                                        <option value="1d" selected>1d</option>
                                        <option value="3d">3d</option>
                                        <option value="7d">7d</option>
                                        <option value="14d">14d</option>
                                        <option value="30d">30d</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label mb-0" style="font-size:0.7rem;">Top N</label>
                                    <input type="number" class="form-control form-control-sm" id="sim-topn" value="10" min="1" max="10" style="font-size:0.8rem;">
                                </div>
                                <div class="col-6">
                                    <label class="form-label mb-0" style="font-size:0.7rem;">Commission</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="sim-commission" value="0.0005" step="0.0001" min="0" max="0.01" style="font-size:0.8rem;">
                                        <span class="input-group-text" style="font-size:0.75rem;">ratio</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label mb-0" style="font-size:0.7rem;">Stop-loss %</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="sim-stoploss" value="3" step="0.5" min="0" max="20" style="font-size:0.8rem;">
                                        <span class="input-group-text" style="font-size:0.75rem;">%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-12">
                                    <label class="form-label mb-0" style="font-size:0.7rem;">Relatif D√º≈ü√º≈ü %</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="sim-rel-drop" value="20" step="1" min="1" max="50" style="font-size:0.8rem;">
                                        <span class="input-group-text" style="font-size:0.75rem;">%</span>
                                    </div>
                                    <div class="form-text" style="font-size:0.65rem;">En y√ºksek g√ºven skorundan d√º≈ü√º≈ü e≈üiƒüi</div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label mb-0" style="font-size:0.7rem;">Sim√ºlasyon Modu</label>
                                    <select class="form-select form-select-sm" id="sim-mode" style="font-size:0.8rem;">
                                        <option value="hybrid" selected>Hibrit (Model + Risk Y√∂netimi)</option>
                                        <option value="model_test">Model Testi (Sadece Model Performansƒ±)</option>
                                        <option value="risk_management">Risk Y√∂netimi (Stop-loss + Confidence Drop)</option>
                                    </select>
                                    <div class="form-text" style="font-size:0.65rem;" id="sim-mode-desc">Model √∂nerilerini ve risk y√∂netimini birlikte test eder</div>
                                    <script>
                                    document.getElementById('sim-mode')?.addEventListener('change', function() {
                                        const desc = document.getElementById('sim-mode-desc');
                                        if (!desc) return;
                                        const mode = this.value;
                                        const descriptions = {
                                            'hybrid': 'Model √∂nerilerini ve risk y√∂netimini birlikte test eder',
                                            'model_test': 'Sadece model performansƒ±nƒ± √∂l√ßer (stop-loss kapalƒ±, horizon\'a kadar tut)',
                                            'risk_management': 'Sadece risk y√∂netimi performansƒ±nƒ± √∂l√ßer (stop-loss ve confidence drop aktif)'
                                        };
                                        desc.textContent = descriptions[mode] || descriptions['hybrid'];
                                    });
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div><!-- End scrollable simulation area -->
                    
                    <!-- Compact Stats removed (legacy) -->
                </div>
            </div>

            <!-- Recent Tasks -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div class="dashboard-card mid-six p-4 w-100" style="background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4>
                        <i class="fas fa-tasks me-2"></i>Recent Tasks
                        <span id="current-phase-badge" class="badge bg-secondary ms-2" title="Current pipeline phase">IDLE</span>
                    </h4>
                    <div class="d-flex justify-content-between align-items-center mt-2" style="flex:0 0 auto;">
                        <div class="small text-muted">
                            <span class="badge" style="background:#0d6efd; font-size: 0.6rem;">INC</span>
                            <span class="badge" style="background:#6f42c1; font-size: 0.6rem;">ANA</span>
                            <span class="badge" style="background:#0dcaf0;color:#000; font-size: 0.6rem;">COL</span>
                            <span class="badge" style="background:#20c997; font-size: 0.6rem;">ML</span>
                        </div>
                        <div class="input-group input-group-sm" style="width: 120px;">
                            <label class="input-group-text" for="tasks-count-select" style="font-size: 0.7rem;">Show</label>
                            <select id="tasks-count-select" class="form-select form-select-sm" style="font-size: 0.75rem;">
                                <option value="3">3</option>
                                <option value="4" selected>4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    <div id="recent-tasks" class="mt-2" style="flex:1 1 auto; min-height:0; overflow-y:auto; overflow-x:hidden;">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <p class="mt-2 small">Loading tasks...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Live Logs -->
            <div class="col-12 mb-4">
                <div class="dashboard-card p-4">
                    <h4><i class="fas fa-terminal me-2"></i>Live System Logs</h4>
                    <div class="log-container" id="live-logs">
                        <div>[INFO] Dashboard initialized - Waiting for system logs...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Sistem Raporu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="reportModalBody">
            <div class="text-muted">Loading...</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
          </div>
        </div>
      </div>
    </div>

<script>
        // Global variables
        let gaugeCpu, gaugeRam, gaugeDisk, gaugeLoad;
        let logCounter = 0;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            updateDashboard();
            // Load recent tasks immediately on page load
            updateRecentTasks();
            loadCalibrationSummary();
            startLiveUpdates();
        });

        // Initialize four semi-circle gauges
        function initializeChart() {
            const makeGauge = (canvasId)=> new Chart(document.getElementById(canvasId).getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Low','Med','High'], datasets: [{ data: [40,35,25], backgroundColor: ['#2a9d8f','#ffd166','#ef476f'], borderWidth:0, circumference:180, rotation:-90, cutout:'70%' }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{enabled:false} } }
            });
            gaugeCpu = makeGauge('gaugeCpu');
            gaugeRam = makeGauge('gaugeRam');
            gaugeDisk = makeGauge('gaugeDisk');
            gaugeLoad = makeGauge('gaugeLoad');
        }

        // Update dashboard data
        async function updateDashboard() {
            try {
                // Update timestamp
                document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
                
                // Get automation status with improved retry logic
                let automationData;
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount < maxRetries) {
                    try {
                        const automationResponse = await fetch('/api/internal/automation/status?v=' + Date.now(), {
                            headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                        });
                        if (automationResponse.ok) {
                            automationData = await automationResponse.json();
                            break; // Success, exit retry loop
                        } else {
                            throw new Error(`HTTP ${automationResponse.status}: ${automationResponse.statusText}`);
                        }
                    } catch (error) {
                        retryCount++;
                        console.warn(`Automation status fetch failed (attempt ${retryCount}/${maxRetries}):`, error.message);
                        
                        if (retryCount >= maxRetries) {
                            // Final fallback
                            automationData = {
                                available: false,
                                scheduler_status: { is_running: false },
                                mode: 'UNKNOWN',
                                error: error.message
                            };
                            addLog('WARNING', `‚ö†Ô∏è Automation status unavailable after ${maxRetries} attempts: ${error.message}`);
                        } else {
                            // Wait before retry (exponential backoff)
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                        }
                    }
                }
                
                if (automationData && automationData.available) {
                    const status = automationData.scheduler_status;
                    // Ensure status exists and has valid data (handle both boolean and string)
                    if (status && (typeof status.is_running === 'boolean' || typeof status.is_running === 'string')) {
                        const isRunning = (status.is_running === true || status.is_running === 'True' || status.is_running === 'true');
                        const currentStatus = isRunning ? 'RUNNING' : 'STOPPED';
                        const currentJobs = (automationData.mode === 'SYMBOL_FLOW') ? 'Symbol Flow (Sequential)' : (status.scheduled_jobs || 0);
                        
                        // Only update if different to prevent flickering
                        const statusElement = document.getElementById('automation-status');
                        const headerEl = document.getElementById('automation-status-header');
                        const jobsElement = null; // removed scheduled-jobs widget
                        
                        if (statusElement) {
                            // Text
                            statusElement.textContent = currentStatus;
                            // Badge color
                            const cls = isRunning ? 'bg-success' : 'bg-danger';
                            statusElement.classList.remove('bg-success','bg-danger','bg-warning','bg-info','bg-secondary','bg-primary');
                            statusElement.classList.add(cls);
                            console.log('üîÑ Automation status updated to:', currentStatus);
                        }
                        if (headerEl) {
                            // Header metric color hint
                            headerEl.classList.remove('text-success','text-danger','text-warning');
                            headerEl.classList.add(isRunning ? 'text-success' : 'text-danger');
                        }
                        if (headerEl && headerEl.textContent !== currentStatus) {
                            headerEl.textContent = currentStatus;
                        }
                        // scheduled-jobs widget removed
                    }
                } else {
                    // Fallback when automation data is unavailable: try admin/system_stats
                    try {
                        const sys = await fetch('/api/admin/system_stats?v=' + Date.now());
                        if (sys.ok) {
                            const sj = await sys.json();
                            const aut = String(sj.automation || '').toUpperCase();
                            const statusEl = document.getElementById('automation-status');
                            const headerEl = document.getElementById('automation-status-header');
                            const txt = (aut === 'RUNNING') ? 'RUNNING' : (aut === 'STOPPED' ? 'STOPPED' : 'CHECKING...');
                            if (statusEl) {
                                statusEl.textContent = txt;
                                const isRun = (txt === 'RUNNING');
                                const isCheck = (txt === 'CHECKING...');
                                statusEl.classList.remove('bg-success','bg-danger','bg-warning','bg-info','bg-secondary','bg-primary');
                                statusEl.classList.add(isCheck ? 'bg-warning' : (isRun ? 'bg-success' : 'bg-danger'));
                            }
                            if (headerEl) {
                                headerEl.textContent = txt;
                                headerEl.classList.remove('text-success','text-danger','text-warning');
                                headerEl.classList.add(txt === 'CHECKING...' ? 'text-warning' : (txt === 'RUNNING' ? 'text-success' : 'text-danger'));
                            }
                        } else {
                            const _as = document.getElementById('automation-status');
                            if (_as) {
                                _as.textContent = 'CHECKING...';
                                _as.classList.remove('bg-success','bg-danger');
                                _as.classList.add('bg-warning');
                            }
                            const _ah = document.getElementById('automation-status-header');
                            if (_ah) {
                                _ah.textContent = 'CHECKING...';
                                _ah.classList.remove('text-success','text-danger');
                                _ah.classList.add('text-warning');
                            }
                        }
                    } catch (_) {
                        const _as = document.getElementById('automation-status');
                        if (_as) {
                            _as.textContent = 'CHECKING...';
                            _as.classList.remove('bg-success','bg-danger');
                            _as.classList.add('bg-warning');
                        }
                        const _ah = document.getElementById('automation-status-header');
                        if (_ah) {
                            _ah.textContent = 'CHECKING...';
                            _ah.classList.remove('text-success','text-danger');
                            _ah.classList.add('text-warning');
                        }
                    }
                }

                // Get system info (safe parse)
                let __dbLooksConnected = false;
                try {
                    const systemResponse = await fetch('/api/system-info');
                    if (systemResponse.ok) {
                        const systemData = await systemResponse.json();
                        if (systemData && systemData.database) {
                            const sc = document.getElementById('stocks-count');
                            const pr = document.getElementById('price-records');
                            if (sc) sc.textContent = systemData.database.stocks || 0;
                            if (pr) pr.textContent = (systemData.database.price_records || 0).toLocaleString();
                            // If DB counts are returned, DB is reachable
                            __dbLooksConnected = true;
                        }
                    }
                } catch (_) { /* ignore */ }

                // Bulk predictions freshness (internal endpoint)
                try {
                    const resp = await fetch('/api/internal/bulk-predictions/status', {
                        headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                    });
                    if (resp.ok) {
                        const bj = await resp.json();
                        const cnt = (bj && typeof bj.predictions_count === 'number') ? bj.predictions_count : null;
                        const ageSec = (bj && typeof bj.age_seconds === 'number') ? bj.age_seconds : null;
                        const stale = (bj && typeof bj.stale !== 'undefined') ? !!bj.stale : null;
                        const fmtAge = (s) => {
                            if (typeof s !== 'number' || !isFinite(s)) return '--';
                            const h = Math.floor(s / 3600);
                            const m = Math.floor((s % 3600) / 60);
                            if (h > 0) return `${h}h ${m}m`;
                            return `${m}m`;
                        };
                        const cntEl = document.getElementById('bulk-count');
                        const ageEl = document.getElementById('bulk-age');
                        const staleEl = document.getElementById('bulk-stale');
                        if (cntEl) cntEl.textContent = (cnt !== null ? cnt : '--');
                        if (ageEl) ageEl.textContent = 'Age: ' + fmtAge(ageSec);
                        if (staleEl) {
                            if (stale === true) { staleEl.textContent = 'STALE'; staleEl.className = 'badge bg-danger'; }
                            else if (stale === false) { staleEl.textContent = 'FRESH'; staleEl.className = 'badge bg-success'; }
                            else { staleEl.textContent = '--'; staleEl.className = 'badge bg-secondary'; }
                        }
                    }
                } catch (e) { /* ignore */ }

                // Get health status using internal endpoint (tokened) to enable CPU/RAM/Disk
                let healthData = { health_check: { systems: {}, overall_status: 'unknown' } };
                try {
                    const healthResponse = await fetch('/api/internal/automation/health?v=' + Date.now(), {
                        headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                    });
                    if (healthResponse.ok) {
                        healthData = await healthResponse.json();
                    }
                } catch (_) { /* ignore, keep default */ }

                // If DB looked connected via /api/system-info, reflect it in health block
                try {
                    if (__dbLooksConnected) {
                        if (!healthData.health_check) healthData.health_check = { systems: {}, overall_status: 'unknown' };
                        if (!healthData.health_check.systems) healthData.health_check.systems = {};
                        healthData.health_check.systems.database = { status: 'connected' };
                    }
                } catch (_) { /* ignore */ }

                updateHealthStatus(healthData);
                updatePerformanceChart(healthData);

                // --- AI Simulation status (active/no-active) ---
                try {
                    const starting = window.__simStarting === true;
                    const active = window.__simActive === true;
                    const stEl = document.getElementById('sim-status-text');
                    const sdEl = document.getElementById('sim-details');
                    const startBtn = document.getElementById('start-simulation-btn');
                    const stopBtn = document.getElementById('stop-simulation-btn');
                    if (starting) {
                        if (stEl) stEl.textContent = 'Starting...';
                        if (sdEl) sdEl.textContent = 'Submitting backtest request';
                        if (startBtn) startBtn.setAttribute('disabled','disabled');
                        if (stopBtn) stopBtn.setAttribute('disabled','disabled');
                    } else if (active) {
                        if (stEl) stEl.textContent = 'Active Simulation';
                        if (sdEl) sdEl.textContent = window.__simSummary || 'Running...';
                        if (startBtn) startBtn.setAttribute('disabled','disabled');
                        if (stopBtn) stopBtn.removeAttribute('disabled');
                    } else {
                        if (stEl) stEl.textContent = 'No Active Simulation';
                        if (sdEl) sdEl.textContent = 'Start a new simulation to test AI performance';
                        if (startBtn) startBtn.removeAttribute('disabled');
                        if (stopBtn) stopBtn.setAttribute('disabled','disabled');
                    }
                } catch (_) {}
                
            // Update Recent Tasks & dynamic pipeline info
            await updateRecentTasks();
            await updatePipelineInfo();
            await loadCalibrationSummary();
                
                // Ba≈üarƒ±lƒ± g√ºncelleme log'unu 60 saniyede bir yaz (spam √∂nleme)
                if (!window.__lastOKLog || (Date.now() - window.__lastOKLog) > 60000) {
                    addLog('INFO', 'Dashboard updated successfully');
                    window.__lastOKLog = Date.now();
                }
        
    } catch (error) {
                console.error('Dashboard update error:', error);
                addLog('ERROR', `Dashboard update failed: ${error.message}`);
            }
        }

        // --- Simulation Controls ---
        async function startSimulation() {
            try {
                if (window.__simActive) { try { alert('Aktif bir sim√ºlasyon zaten √ßalƒ±≈üƒ±yor'); } catch(_){} return; }
                const stEl = document.getElementById('sim-status-text');
                const sdEl = document.getElementById('sim-details');
                const startBtn = document.getElementById('start-simulation-btn');
                const stopBtn = document.getElementById('stop-simulation-btn');
                
                if (stEl) stEl.textContent = 'Ba≈ülatƒ±lƒ±yor...';
                if (sdEl) sdEl.textContent = 'Sim√ºlasyon hazƒ±rlanƒ±yor';
                if (startBtn) startBtn.setAttribute('disabled','disabled');

                const capital = parseFloat(document.getElementById('trade-amount').value || '10000');
                const horizonSel = (document.getElementById('sim-horizon')?.value || '7d');
                const topN = parseInt(document.getElementById('sim-topn')?.value || '10');
                const commission = parseFloat(document.getElementById('sim-commission')?.value || '0.0005');
                const stopPctUi = parseFloat(document.getElementById('sim-stoploss')?.value || '3');
                const relDropPctUi = parseFloat(document.getElementById('sim-rel-drop')?.value || '20');
                const simMode = (document.getElementById('sim-mode')?.value || 'hybrid');
                
                const body = {
                    initial_capital: isFinite(capital) ? capital : 10000,
                    horizon: horizonSel,
                    topN: (isFinite(topN) ? Math.max(1, Math.min(10, topN)) : 10),
                    commission: (isFinite(commission) ? commission : 0.0005),
                    stop_loss_pct: isFinite(stopPctUi) ? (stopPctUi / 100.0) : 0.03,
                    relative_drop_threshold: isFinite(relDropPctUi) ? (relDropPctUi / 100.0) : 0.20,
                    simulation_mode: simMode
                };
                
                const res = await fetch('/api/internal/simulation/forward-start', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' 
                    },
                    body: JSON.stringify(body)
                });
                
                const data = await res.json().catch(()=>null);
                if (!res.ok || !data) {
                    const msg = (data && data.error) ? data.error : `HTTP ${res.status}`;
                    if (stEl) stEl.textContent = 'Hata';
                    if (sdEl) sdEl.textContent = msg;
                    if (startBtn) startBtn.removeAttribute('disabled');
                    try { alert('Sim√ºlasyon ba≈ülatƒ±lamadƒ±: ' + msg); } catch(_){}
                    return;
                }
                
                window.__simActive = true;
                if (stEl) stEl.textContent = 'Aktif Sim√ºlasyon';
                if (sdEl) sdEl.textContent = `G√ºn ${data.elapsed_days}/${data.duration_days} | Sermaye: ‚Ç∫${data.portfolio.equity.toFixed(2)}`;
                if (stopBtn) stopBtn.removeAttribute('disabled');
                if (startBtn) startBtn.removeAttribute('disabled');
                
                // Start polling for status updates
                if (window.__simPollInterval) clearInterval(window.__simPollInterval);
                window.__simPollInterval = setInterval(updateSimulationStatus, 5000);
                
                console.log('‚úÖ Forward simulation started');
                
            } catch (e) {
                console.error('startSimulation error', e);
                const stEl = document.getElementById('sim-status-text');
                const sdEl = document.getElementById('sim-details');
                const startBtn = document.getElementById('start-simulation-btn');
                if (stEl) stEl.textContent = 'Hata';
                if (sdEl) sdEl.textContent = String(e?.message||'ƒ∞stek ba≈üarƒ±sƒ±z');
                if (startBtn) startBtn.removeAttribute('disabled');
                try { alert('Hata: ' + (e?.message || 'Bilinmeyen hata')); } catch(_){}
            }
        }

        async function stopSimulation() {
            try {
                const res = await fetch('/api/internal/simulation/forward-stop', {
                    method: 'POST',
                    headers: { 
                        'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' 
                    }
                });
                
                const data = await res.json().catch(()=>null);
                if (window.__simPollInterval) clearInterval(window.__simPollInterval);
                window.__simActive = false;
                
                const stEl = document.getElementById('sim-status-text');
                const sdEl = document.getElementById('sim-details');
                if (stEl) stEl.textContent = 'Sim√ºlasyon Yok';
                if (sdEl) sdEl.textContent = '';
                
                if (data && data.summary) {
                    try { openSimDetails(data); } catch(_){}
                    console.log('‚úÖ Simulation stopped, P&L:', data.summary.pnl);
                }
                
            } catch (e) {
                console.error('stopSimulation error', e);
                try { alert('Durdurma hatasƒ±: ' + (e?.message || 'Bilinmeyen hata')); } catch(_){}
            }
        }
        
        async function updateSimulationStatus() {
            try {
                const res = await fetch('/api/internal/simulation/status', {
                    headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                });
                const data = await res.json().catch(()=>null);
                
                if (!data || !data.active) {
                    if (window.__simPollInterval) clearInterval(window.__simPollInterval);
                    window.__simActive = false;
                    const stEl = document.getElementById('sim-status-text');
                    const sdEl = document.getElementById('sim-details');
                    if (stEl) stEl.textContent = 'Sim√ºlasyon Yok';
                    if (sdEl) sdEl.textContent = '';
                    return;
                }
                
                window.__simActive = true;
                
                // Update status text
                const stEl = document.getElementById('sim-status-text');
                if (stEl) {
                    stEl.textContent = `Aktif: ${data.horizon} (G√ºn ${data.elapsed_days}/${data.duration_days})`;
                }
                
                // Update details
                const sdEl = document.getElementById('sim-details');
                if (sdEl) {
                    const pnl = data.portfolio.pnl || 0;
                    const pnlSign = pnl >= 0 ? '+' : '';
                    const equity = data.portfolio.equity || 0;
                    const posCount = data.portfolio.positions?.length || 0;
                    sdEl.textContent = `${posCount} pozisyon | Sermaye: ‚Ç∫${equity.toFixed(0)} | P&L: ${pnlSign}‚Ç∫${pnl.toFixed(2)}`;
                }
                
                // Update buttons
                const startBtn = document.getElementById('start-simulation-btn');
                const stopBtn = document.getElementById('stop-simulation-btn');
                if (startBtn) startBtn.disabled = true;
                if (stopBtn) stopBtn.disabled = false;
                
            } catch (e) {
                console.error('Status poll error', e);
            }
        }

        async function openSimDetails(preloaded) {
            let content = preloaded;
            
            // If no preloaded data, fetch from API
            if (!content) {
                try {
                    const res = await fetch('/api/internal/simulation/status', {
                        headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                    });
                    content = await res.json();
                    if (!content.active) {
                        alert('Aktif simulasyon yok!');
                        return;
                    }
                } catch (e) {
                    console.error('Failed to fetch simulation status', e);
                    alert('Simulasyon verisi alƒ±namadƒ±!');
                    return;
                }
            }
            
            const body = document.getElementById('reportModalBody');
            
            // Extract data from simulation state
            const portfolio = content.portfolio || {};
            const pnl = Number(portfolio.pnl || 0);
            const equity = Number(portfolio.equity || 0);
            const cash = Number(portfolio.cash || 0);
            const initialCapital = Number(content.params?.initial_capital || 100000);
            const ret = ((equity - initialCapital) / initialCapital * 100);
            
            const trades = Array.isArray(content.trades) ? content.trades : [];
            const totalTrades = trades.length;
            const commTotal = trades.reduce((sum, t) => sum + (t.commission || 0), 0);
            const positions = Array.isArray(content.portfolio?.positions) ? content.portfolio.positions : [];
            const snapshots = Array.isArray(content.daily_snapshots) ? content.daily_snapshots : [];
            
            // Calculate hit rate (profitable trades)
            const buyTrades = trades.filter(t => t.action === 'buy');
            const sellTrades = trades.filter(t => t.action === 'sell');
            const profitableSells = sellTrades.filter(t => {
                const buyPrice = buyTrades.find(b => b.symbol === t.symbol)?.price || 0;
                return t.price > buyPrice;
            }).length;
            const hitRate = sellTrades.length > 0 ? (profitableSells / sellTrades.length * 100) : 0;
            
            // ‚úÖ NEW: Separate metrics for model performance vs risk management
            const summary = content.summary || {};
            const modelPerf = summary.model_performance || {};
            const riskMgmt = summary.risk_management || {};
            const simMode = summary.simulation_mode || content.params?.simulation_mode || 'hybrid';
            
            // Simulation progress
            const elapsedDays = content.elapsed_days || 0;
            const durationDays = content.duration_days || 0;
            const horizon = content.horizon || '';
            const startTime = content.start_time ? new Date(content.start_time).toLocaleString('tr-TR') : 'N/A';
            
            const modeLabels = {
                'hybrid': 'Hibrit (Model + Risk Y√∂netimi)',
                'model_test': 'Model Testi (Sadece Model Performansƒ±)',
                'risk_management': 'Risk Y√∂netimi (Stop-loss + Confidence Drop)'
            };
            
            body.innerHTML = `
              <div class="alert alert-info mb-3">
                <strong>üìä Simulasyon Durumu:</strong> ${horizon} | 
                G√ºn ${elapsedDays}/${durationDays} | 
                Ba≈ülangƒ±√ß: ${startTime}<br>
                <strong>Mod:</strong> ${modeLabels[simMode] || simMode}
              </div>
              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <div class="card bg-light">
                    <div class="card-body p-2">
                      <small class="text-muted">Equity</small>
                      <div class="h5 mb-0">‚Ç∫${equity.toFixed(2)}</div>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card ${pnl >= 0 ? 'bg-success' : 'bg-danger'} text-white">
                    <div class="card-body p-2">
                      <small>Toplam P&L</small>
                      <div class="h5 mb-0">‚Ç∫${pnl.toFixed(2)}</div>
                      <small>${ret.toFixed(2)}%</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card bg-light">
                    <div class="card-body p-2">
                      <small class="text-muted">Nakit</small>
                      <div class="h5 mb-0">‚Ç∫${cash.toFixed(2)}</div>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card bg-light">
                    <div class="card-body p-2">
                      <small class="text-muted">ƒ∞≈ülem / Komisyon</small>
                      <div class="h6 mb-0">${totalTrades} / ‚Ç∫${commTotal.toFixed(2)}</div>
                      <small>Hit: ${hitRate.toFixed(0)}%</small>
                    </div>
                  </div>
                </div>
              </div>
              ${simMode === 'hybrid' && (modelPerf.trades > 0 || riskMgmt.trades > 0) ? `
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <div class="card ${modelPerf.pnl >= 0 ? 'border-success' : 'border-danger'}">
                    <div class="card-header bg-light">
                      <strong>üéØ Model Performansƒ±</strong>
                    </div>
                    <div class="card-body p-2">
                      <div class="row">
                        <div class="col-6">
                          <small class="text-muted">ƒ∞≈ülem</small>
                          <div class="h6 mb-0">${modelPerf.trades || 0}</div>
                        </div>
                        <div class="col-6">
                          <small class="text-muted">P&L</small>
                          <div class="h6 mb-0 ${modelPerf.pnl >= 0 ? 'text-success' : 'text-danger'}">‚Ç∫${(modelPerf.pnl || 0).toFixed(2)}</div>
                        </div>
                        <div class="col-6">
                          <small class="text-muted">K√¢rlƒ±</small>
                          <div class="h6 mb-0">${modelPerf.profitable_trades || 0}</div>
                        </div>
                        <div class="col-6">
                          <small class="text-muted">Hit Rate</small>
                          <div class="h6 mb-0">${((modelPerf.hit_rate || 0) * 100).toFixed(1)}%</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card ${riskMgmt.pnl >= 0 ? 'border-success' : 'border-danger'}">
                    <div class="card-header bg-light">
                      <strong>üõ°Ô∏è Risk Y√∂netimi</strong>
                    </div>
                    <div class="card-body p-2">
                      <div class="row">
                        <div class="col-6">
                          <small class="text-muted">ƒ∞≈ülem</small>
                          <div class="h6 mb-0">${riskMgmt.trades || 0}</div>
                        </div>
                        <div class="col-6">
                          <small class="text-muted">P&L</small>
                          <div class="h6 mb-0 ${riskMgmt.pnl >= 0 ? 'text-success' : 'text-danger'}">‚Ç∫${(riskMgmt.pnl || 0).toFixed(2)}</div>
                        </div>
                        <div class="col-6">
                          <small class="text-muted">K√¢rlƒ±</small>
                          <div class="h6 mb-0">${riskMgmt.profitable_trades || 0}</div>
                        </div>
                        <div class="col-6">
                          <small class="text-muted">Hit Rate</small>
                          <div class="h6 mb-0">${((riskMgmt.hit_rate || 0) * 100).toFixed(1)}%</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              ` : ''}
              <div class="row g-3 mb-3">
                <div class="col-md-8"><canvas id="simEquityChart" height="140"></canvas></div>
                <div class="col-md-4"><canvas id="simDrawdownChart" height="140"></canvas></div>
              </div>
              <div class="row g-3">
                <div class="col-md-7">
                  <h6>üìà A√ßƒ±k Pozisyonlar (${positions.length})</h6>
                  <div class="table-responsive" style="max-height:280px; overflow:auto;">
                    <table class="table table-sm table-hover mb-0" style="font-size:0.85rem;">
                      <thead class="table-dark">
                        <tr>
                          <th>Sembol</th>
                          <th>Adet</th>
                          <th>Giri≈ü ‚Ç∫</th>
                          <th>G√ºven</th>
                          <th>Ufuk</th>
                          <th>Maliyet ‚Ç∫</th>
                          <th>Giri≈ü Zamanƒ±</th>
                        </tr>
                      </thead>
                      <tbody id="sim-pos-tbody"></tbody>
                    </table>
                  </div>
                </div>
                <div class="col-md-5">
                  <h6>üìã ƒ∞≈ülem Ge√ßmi≈üi (son 20)</h6>
                  <div class="table-responsive" style="max-height:280px; overflow:auto;">
                    <table class="table table-sm table-hover mb-0" style="font-size:0.85rem;">
                      <thead class="table-dark">
                        <tr>
                          <th>Zaman</th>
                          <th>Sembol</th>
                          <th>Y√∂n</th>
                          <th>Adet</th>
                          <th>Fiyat ‚Ç∫</th>
                          <th>Sebep</th>
                          ${simMode === 'hybrid' ? '<th>Kategori</th>' : ''}
                        </tr>
                      </thead>
                      <tbody id="sim-trades-tbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            `;
            
            // Fill positions table
            const pt = document.getElementById('sim-pos-tbody');
            if (pt) {
                pt.innerHTML = positions.map(p => {
                    const entryTime = p.entry_time ? new Date(p.entry_time).toLocaleString('tr-TR', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    }) : 'N/A';
                    const confPct = Math.min(100, Math.max(0, (p.entry_confidence||0)*100));
                    return `
                        <tr>
                            <td><strong>${p.symbol}</strong></td>
                            <td class="text-end">${p.shares || 0}</td>
                            <td class="text-end">${(p.entry_price||0).toFixed(2)}</td>
                            <td><span class="badge bg-info">${confPct.toFixed(0)}%</span></td>
                            <td><span class="badge bg-secondary">${p.entry_horizon || 'N/A'}</span></td>
                            <td class="text-end">${(p.entry_cost||0).toFixed(2)}</td>
                            <td style="font-size:0.75rem;">${entryTime}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Fill trades table
            const tt = document.getElementById('sim-trades-tbody');
            if (tt) {
                tt.innerHTML = trades.slice(-20).reverse().map(t => {
                    const time = t.time ? new Date(t.time).toLocaleString('tr-TR', {
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    }) : 'N/A';
                    const actionBadge = t.action === 'buy' ? 
                        '<span class="badge bg-success">AL</span>' : 
                        '<span class="badge bg-danger">SAT</span>';
                    const reasonMap = {
                        'initial_buy': 'üöÄ ƒ∞lk',
                        'rotation_buy': 'üîÑ Rot.',
                        'stop_loss': 'üõë Stop',
                        'sell_signal': 'üìâ Sinyal',
                        'confidence_drop': '‚ö†Ô∏è G√ºven‚Üì',
                        'horizon_reached': '‚è∞ Ufuk'
                    };
                    const reasonText = reasonMap[t.reason] || t.reason || 'N/A';
                    const categoryBadge = t.category === 'model_performance' ? 
                        '<span class="badge bg-primary" style="font-size:0.65rem;">Model</span>' : 
                        t.category === 'risk_management' ? 
                        '<span class="badge bg-warning" style="font-size:0.65rem;">Risk</span>' : '';
                    return `
                        <tr>
                            <td style="font-size:0.7rem;">${time}</td>
                            <td><strong>${t.symbol}</strong></td>
                            <td>${actionBadge}</td>
                            <td class="text-end">${t.shares || 0}</td>
                            <td class="text-end">${(t.price||0).toFixed(2)}</td>
                            <td style="font-size:0.75rem;">${reasonText}</td>
                            ${simMode === 'hybrid' ? `<td>${categoryBadge}</td>` : ''}
                        </tr>
                    `;
                }).join('');
            }
            
            // Draw charts
            try {
                const labels = snapshots.map(s => s.date);
                const values = snapshots.map(s => s.equity);
                
                if (values.length > 0) {
                    const ctx = document.getElementById('simEquityChart').getContext('2d');
                    if (window.__simEquityChart) window.__simEquityChart.destroy();
                    window.__simEquityChart = new Chart(ctx, { 
                        type: 'line', 
                        data: { 
                            labels, 
                            datasets: [{ 
                                label: 'Sermaye', 
                                data: values, 
                                borderColor: '#0d6efd', 
                                backgroundColor: 'rgba(13,110,253,0.15)', 
                                tension: 0.15, 
                                fill: true, 
                                pointRadius: 2 
                            }] 
                        }, 
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { legend: { display: false } }, 
                            scales: { 
                                x: { display: true }, 
                                y: { ticks: { callback: (v) => '‚Ç∫'+Number(v).toFixed(0) } } 
                            } 
                        } 
                    });
                    
                    // Drawdown calculation
                    const dd = [];
                    let peak = -Infinity;
                    for (let i = 0; i < values.length; i++) {
                        peak = Math.max(peak, values[i] || 0);
                        const dv = peak > 0 ? ((values[i] - peak) / peak) * 100.0 : 0;
                        dd.push(dv);
                    }
                    
                    const ctx2 = document.getElementById('simDrawdownChart').getContext('2d');
                    if (window.__simDDChart) window.__simDDChart.destroy();
                    window.__simDDChart = new Chart(ctx2, { 
                        type: 'line', 
                        data: { 
                            labels, 
                            datasets: [{ 
                                label: 'D√º≈ü√º≈ü %', 
                                data: dd, 
                                borderColor: '#dc3545', 
                                backgroundColor: 'rgba(220,53,69,0.15)', 
                                tension: 0.15, 
                                fill: true, 
                                pointRadius: 2 
                            }] 
                        }, 
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { legend: { display: false } }, 
                            scales: { 
                                x: { display: true }, 
                                y: { ticks: { callback: (v) => (Number(v) || 0).toFixed(0) + '%' } } 
                            } 
                        } 
                    });
                }
            } catch (e) { 
                console.warn('Chart rendering failed', e); 
            }
            
            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            modal.show();
        }

        // Update health status display
        function updateHealthStatus(healthData) {
            const healthContainer = document.getElementById('health-status');
            if (!healthData.health_check) {
                healthContainer.innerHTML = '<div class="alert alert-warning">Health data not available</div>';
                return;
            }
            const health = healthData.health_check;
            const systems = health.systems || {};
            const overall = (health.overall_status || 'unknown').toLowerCase();
            const badge = (key, s) => {
                try {
                    const v = String(s || '').toLowerCase();
                    if (key === 'automation_engine') {
                        if (v === 'running') return 'success';
                        if (v === 'stopped') return 'danger';
                        if (v === 'checking' || v === 'pending') return 'warning';
                    }
                    if (v === 'healthy' || v === 'connected') return 'success';
                    if (v === 'warning' || v === 'degraded') return 'warning';
                    return 'danger';
                } catch (_) { return 'secondary'; }
            };

            // Build modern card layout consistently with static HTML above
            const card = (title, subtitle, id, statusKey) => {
                const val = (statusKey && systems[statusKey]) ? (systems[statusKey].status || 'unknown') : (systems[title] && systems[title].status) || 'unknown';
                return `
                <div class="col-12">
                    <div class="p-3 rounded d-flex justify-content-between align-items-center" style="background:#f8f9fa;border:1px solid #e9ecef;">
                        <div>
                            <div class="fw-bold">${title}</div>
                            <small class="text-muted">${subtitle}</small>
                        </div>
                        <span class="badge bg-${badge(statusKey, val)}" id="${id}">${val}</span>
                    </div>
                </div>`;
            };

            const html = `
            <div class="row g-3">
                <div class="col-12">
                    <div class="p-3 rounded d-flex justify-content-between align-items-center" style="background:#f8fff9;border:1px solid #e2f3e7;">
                        <div>
                            <div class="fw-bold">Overall Status</div>
                            <small class="text-muted">System Integration</small>
                        </div>
                        <span class="badge bg-${overall==='healthy'?'success':overall==='warning'?'warning':'danger'}" id="overall-status">${overall.toUpperCase()}</span>
                    </div>
                </div>
                ${card('Automation Engine','Background Processing','automation-status','automation_engine')}
                ${card('Flask API','Web Service','flask-status','flask_api')}
                ${card('Database','PostgreSQL Connection','db-status','database')}
                ${card('WebSocket','Real-time Updates','websocket-status','websocket')}
            </div>`;
            healthContainer.innerHTML = html;
        }

        // Update performance chart
        function updatePerformanceChart(healthData) {
            // Extract CPU/RAM/Disk metrics if available
            let cpu = null, mem = null, disk = null, loadAvg = null;
            try {
                const res = (healthData && healthData.health_check) ? healthData.health_check.system_resources : null;
                if (res) {
                    cpu = Number(res.cpu_percent);
                    mem = Number(res.memory_percent);
                    disk = Number(res.disk_percent);
                    loadAvg = Array.isArray(res.load_avg) ? res.load_avg[0] : null;
                }
            } catch (_) {}
            // Update gauge pointer text and labels
            try {
                document.getElementById('valCpu').textContent = Number.isFinite(cpu) ? cpu.toFixed(0) : '-';
                document.getElementById('valRam').textContent = Number.isFinite(mem) ? mem.toFixed(0) : '-';
                document.getElementById('valDisk').textContent = Number.isFinite(disk) ? disk.toFixed(0) : '-';
                document.getElementById('valLoad').textContent = loadAvg !== null ? loadAvg.toFixed(2) : '-';
                // Dynamic color band emphasis: adjust dataset data ratios based on value thresholds
                const updateBands = (chart, valPct)=>{
                    // valPct 0-100; we keep three segments Low/Med/High with same sizes, but tint by opacity
                    const colors = ['#2a9d8f','#ffd166','#ef476f'];
                    const idx = valPct >= 80 ? 2 : (valPct >= 50 ? 1 : 0);
                    const bg = colors.map((c,i)=> i===idx ? c : `${c}66`); // active band solid, others translucent
                    chart.data.datasets[0].backgroundColor = bg;
                    chart.update('none');
                };
                if (gaugeCpu && Number.isFinite(cpu)) updateBands(gaugeCpu, cpu);
                if (gaugeRam && Number.isFinite(mem)) updateBands(gaugeRam, mem);
                if (gaugeDisk && Number.isFinite(disk)) updateBands(gaugeDisk, disk);
                if (gaugeLoad && loadAvg !== null) {
                    // Normalize loadAvg (rough heuristic: 0-2 -> 0-100)
                    const pct = Math.max(0, Math.min(100, (loadAvg / 2) * 100));
                    updateBands(gaugeLoad, pct);
                }
            } catch (_) {}
        }

        // Calculate health score
        function calculateHealthScore(healthData) {
            if (!healthData.health_check || !healthData.health_check.systems) return 0;
            
            const systems = healthData.health_check.systems;
            const total = Object.keys(systems).length;
            const healthy = Object.values(systems).filter(s => s.status === 'healthy').length;
            
            return Math.round((healthy / total) * 100);
        }

        // Update Recent Tasks
        async function updateRecentTasks() {
            try {
                const response = await fetch('/api/recent-tasks');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const tasksContainer = document.getElementById('recent-tasks');
                
                if (data.status === 'success' && data.tasks && data.tasks.length > 0) {
                    const preferCount = parseInt(localStorage.getItem('tasksDisplayCount') || '4');
                    const MAX_TASKS_DISPLAY = Number.isFinite(preferCount) ? preferCount : 5;
                const tasksToRender = data.tasks.slice(0, MAX_TASKS_DISPLAY);
                let html = '';
                    
                    tasksToRender.forEach(task => {
                        const state = (task.status || '').toLowerCase();
                        const statusIcon = {
                            'completed': '‚úÖ',
                            'running': '‚è≥',
                            'failed': '‚ùå',
                            'pending': '‚è∞',
                            'start': '‚ñ∂Ô∏è',
                            'end': '‚úÖ',
                            'error': '‚ùå'
                        };
                        const badgeClass = {
                            'completed': 'bg-success',
                            'running': 'bg-primary',
                            'failed': 'bg-danger',
                            'pending': 'bg-warning',
                            'start': 'bg-primary',
                            'end': 'bg-success',
                            'error': 'bg-danger'
                        };
                        const badgeText = (state === 'start' || state === 'end' || state === 'error')
                            ? state.toUpperCase()
                            : (state || 'UNKNOWN').toUpperCase();
                        const phaseKey = String(task.task || '').toLowerCase();
                        const phase = (task.task || '').replace(/_/g, ' ');
                        const phaseColors = {
                            'incremental_cycle': '#0d6efd',
                            'ai_analysis': '#6f42c1',
                            'data_collection': '#0dcaf0',
                            'bulk_predictions': '#20c997',
                            'symbol_flow': '#ffc107'
                        };
                        const leftColor = phaseColors[phaseKey] || '#ced4da';
                        const repeatBadge = (task.repeat && task.repeat > 1) ? `<span class="badge bg-secondary ms-2">x${task.repeat}</span>` : '';
                        html += `
                            <div class="d-flex align-items-start mb-3 p-2 border-bottom" style="border-left:4px solid ${leftColor};">
                                <span class="me-2 fs-5">${statusIcon[state] || task.icon || 'üß©'}</span>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <strong class="small">${phase}</strong>
                                        <small class="text-muted">${task.timestamp}</small>
                                    </div>
                                    <div class="small text-muted">${task.description || ''}</div>
                                    <span class="badge ${badgeClass[state] || 'bg-secondary'}">${badgeText}</span>${repeatBadge}
                                </div>
                            </div>
                        `;
                    });

                    if (data.tasks.length > MAX_TASKS_DISPLAY) {
                        html += `
                            <div class="text-center text-muted small pb-1">
                                Showing ${MAX_TASKS_DISPLAY}/${data.tasks.length}. Panel kaydƒ±rƒ±labilir.
                            </div>
                        `;
                    }
                    
                    // Ensure at least 4 rows visible to avoid big empty area
                    const MIN_ROWS = 4;
                    if (tasksToRender.length < MIN_ROWS) {
                        for (let i = tasksToRender.length; i < MIN_ROWS; i++) {
                            html += `
                            <div class="d-flex align-items-start mb-3 p-2 border-bottom" style="border-left:4px solid transparent; opacity:0.6;">
                                <span class="me-2 fs-5">&nbsp;</span>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <strong class="small text-muted">‚Äî</strong>
                                        <small class="text-muted">‚Äî</small>
                                    </div>
                                    <div class="small text-muted">No more items</div>
                                    <span class="badge bg-light text-muted">&nbsp;</span>
                                </div>
                            </div>`;
                        }
                    }
                    tasksContainer.innerHTML = html;
                    console.log('‚úÖ Recent Tasks updated successfully');
                } else {
                    tasksContainer.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle"></i>
                            <p class="mt-2">No recent tasks available</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Recent Tasks update error:', error);
                const tasksContainer = document.getElementById('recent-tasks');
                tasksContainer.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p class="mt-2">Failed to load tasks</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // Dynamic pipeline info (header metrics)
        async function updatePipelineInfo() {
            try {
                // Read current automation status first to avoid stale phase display
                const statusRes = await fetch('/api/internal/automation/status', {
                    headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                });
                const statusJson = statusRes.ok ? await statusRes.json() : null;
                let isRunning = false;
                if (statusJson) {
                    // Try multiple sources for running status
                    isRunning = !!(statusJson.automation && statusJson.automation.running) ||
                               !!(statusJson.scheduler_status && statusJson.scheduler_status.is_running) ||
                               !!(statusJson.running);
                }

                const res = await fetch('/api/internal/automation/pipeline-history', {
                    headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }
                });
                if (!res.ok) return;
                const data = await res.json();
                const hist = (data.history || []);
                // Update Current Phase badge from last history entry
                const badge = document.getElementById('current-phase-badge');
                if (badge) {
                    let label = 'IDLE', cls = 'bg-secondary';
                    if (isRunning && hist.length > 0) {
                        // Find most recent 'start' entry to decide the phase reliably
                        let lastStart = null;
                        let lastEntry = hist[hist.length - 1]; // Most recent entry
                        for (let i = hist.length - 1; i >= 0; i--) {
                            if (hist[i].state === 'start' && (hist[i].phase === 'data_collection' || hist[i].phase === 'ai_analysis' || hist[i].phase === 'incremental_cycle' || hist[i].phase === 'symbol_flow')) {
                                lastStart = hist[i];
                                break;
                            }
                        }
                        const phase = lastStart ? (lastStart.phase || '') : (lastEntry ? (lastEntry.phase || '') : '');
                        const state = lastStart ? 'start' : (lastEntry ? (lastEntry.state || '') : '');
                        if (state === 'start') {
                            if (phase === 'data_collection') { label = 'Collecting'; cls = 'bg-info'; }
                            else if (phase === 'ai_analysis') { label = 'Analyzing'; cls = 'bg-primary'; }
                            else if (phase === 'incremental_cycle') { label = 'Incremental'; cls = 'bg-primary'; }
                            else if (phase === 'symbol_flow') { label = 'Symbol Flow'; cls = 'bg-warning'; }
                            else { label = 'Running'; cls = 'bg-primary'; }
                        } else if (state === 'end') {
                            // ‚úÖ FIX: If automation is running but last entry is 'end', show 'Running' instead of 'Idle'
                            // This handles the case where a cycle just finished but automation is still active
                            label = 'Running'; cls = 'bg-primary';
                        } else if (state === 'error') {
                            label = 'Error'; cls = 'bg-danger';
                        } else {
                            // No valid state found, but automation is running
                            label = 'Running'; cls = 'bg-primary';
                        }
                    } else if (!isRunning) {
                        label = 'Idle';
                        cls = 'bg-secondary';
                    }
                    badge.textContent = label.toUpperCase();
                    badge.className = `badge ${cls} ms-2`;
                }
                // Intentionally do not mirror pipeline history as log here to avoid misleading entries
            } catch (e) { /* ignore */ }
        }

        // Automation control functions
        async function startAutomation() {
            try {
                addLog('INFO', 'Starting automation...');
                console.log('üöÄ Starting automation via /api/internal/automation/start');
                const response = await fetch('/api/internal/automation/start?v=1.1', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw'
                    }
                });
                let data;
                try { data = await response.json(); } catch (_) { data = { status: 'error', message: `HTTP ${response.status}` }; }
                const okStatuses = ['started', 'already_running'];
                const logType = (response.ok && okStatuses.includes(String(data.status))) ? 'SUCCESS' : 'ERROR';
                addLog(logType, `Automation: ${data.message || data.status || 'Unknown response'}`);
                updateDashboard();
            } catch (error) {
                addLog('ERROR', `Start automation failed: ${error.message}`);
            }
        }

        async function stopAutomation() {
            try {
                addLog('INFO', 'Stopping automation...');
                console.log('üõë Stopping automation via /api/internal/automation/stop');
                const response = await fetch('/api/internal/automation/stop?v=1.1', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw'
                    }
                });
                let data;
                try { data = await response.json(); } catch (_) { data = { status: 'error', message: `HTTP ${response.status}` }; }
                const okStatuses = ['stopped', 'already_stopped'];
                const logType = (response.ok && okStatuses.includes(String(data.status))) ? 'SUCCESS' : 'ERROR';
                addLog(logType, `Automation: ${data.message || data.status || 'Unknown response'}`);
                updateDashboard();
            } catch (error) {
                addLog('ERROR', `Stop automation failed: ${error.message}`);
            }
        }

        async function runTask(taskName) {
            try {
                addLog('INFO', `Running task: ${taskName}...`);
                
                // Add loading state for long-running tasks
                const isLongTask = ['data_collection', 'model_retraining'].includes(taskName);
                if (isLongTask) {
                    addLog('INFO', `‚è≥ ${taskName} is a long-running task, please wait...`);
                }
                
                const headers = {
                    'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw',
                    'X-Internal-Request': 'true',
                    'Content-Type': 'application/json'
                };
                
                // Debug: Log request details
                console.log(`üîç Request: POST /api/internal/automation/run-task/${taskName}`);
                console.log('üîç Headers:', headers);
                
                const response = await fetch(`/api/internal/automation/run-task/${taskName}`, { 
                    method: 'POST',
                    headers: headers,
                    // Set appropriate timeout for long tasks
                    signal: isLongTask ? undefined : AbortSignal.timeout(30000) // 30s for short tasks
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const logType = data.status === 'success' ? 'SUCCESS' : 'ERROR';
                addLog(logType, `Task ${taskName}: ${data.message}`);
                
                // Show detailed results for successful tasks
                if (data.status === 'success' && data.result) {
                    const result = data.result;
                    if (typeof result === 'object') {
                        const details = Object.entries(result)
                            .filter(([k, v]) => k !== 'timestamp' && v !== undefined)
                            .map(([k, v]) => `${k}: ${v}`)
                            .join(', ');
                        if (details) {
                            addLog('INFO', `üìä ${taskName} details: ${details}`);
                        }
                    }
                }
                
                updateDashboard();
            } catch (error) {
                if (error.name === 'TimeoutError') {
                    addLog('WARNING', `Task ${taskName} timed out - may still be running in background`);
                } else {
                    addLog('ERROR', `Task ${taskName} failed: ${error.message}`);
                }
            }
        }

        let __reportChart = null;
        async function generateReport() {
            try {
                addLog('INFO', 'Generating system report...');
                const [repRes, histRes, trainSumRes] = await Promise.all([
                    // Use public automation report which returns { report: { aggregates, volume, ... } }
                    fetch('/api/automation/report?v=' + Date.now()),
                    fetch('/api/internal/automation/pipeline-history?v=' + Date.now(), { headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' } }),
                    fetch('/api/internal/reports/training-summary?v=' + Date.now(), { headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' } })
                ]);
                const rep = repRes.ok ? await repRes.json() : { status: 'error' };
                const hist = histRes.ok ? await histRes.json() : { status: 'error' };
                const trainSummary = trainSumRes.ok ? await trainSumRes.json() : { status: 'error' };
                renderReportModal(rep, hist, trainSummary);
                const modalEl = document.getElementById('reportModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
                addLog('SUCCESS', 'System report generated successfully');
            } catch (error) {
                addLog('ERROR', `Report generation failed: ${error.message}`);
            }
        }

        function renderReportModal(rep, hist, trainSummary) {
            try {
                const body = document.getElementById('reportModalBody');
                // Aggregate metrics since automation start
                const aggr = (rep && rep.report && rep.report.aggregates) ? rep.report.aggregates : {};
                const sinceStarted = (rep && rep.report) ? (rep.report.since_started || '') : '';
                const lastStats = (rep && rep.report && rep.report.last_run_stats) ? rep.report.last_run_stats : {};
                let cycle = Number(lastStats.cycle || 0);
                let analyzed = Number(lastStats.analyzed || 0);
                let collected = Number(lastStats.total_records || 0);
                let updated = Number(lastStats.updated_records || 0);

                const history = (hist && hist.history) ? hist.history.filter(h => h.phase === 'symbol_flow' && h.state === 'end') : [];
                // Fallback: if last_run_stats missing/zero, derive counters from last history end entry
                if ((cycle === 0 && history.length > 0) || (!lastStats || Object.keys(lastStats).length === 0)) {
                    const lastEnd = history[history.length - 1] || {};
                    const det = lastEnd.details || {};
                    cycle = Number(det.cycle || history.length || 0);
                    analyzed = Number(det.analyzed || 0);
                    collected = Number(det.collected_records || 0);
                    updated = Number(det.updated_records || 0);
                }

                // Volume tiers from backend report (if any)
                const volume = (rep && rep.report && rep.report.volume) ? rep.report.volume : null;
                const lookbackDays = volume ? Number(volume.lookback_days || 0) : 0;
                const recent = history.slice(-10);
                const rows = recent.map((r, idx) => {
                    const det = r.details || {};
                    return `<tr>
                        <td>${recent.length - idx}</td>
                        <td>${r.timestamp || ''}</td>
                        <td>${det.analyzed ?? '-'}</td>
                        <td>${det.collected_records ?? 0}</td>
                        <td>${det.updated_records ?? 0}</td>
                        <td>${det.total ?? '-'}</td>
                    </tr>`;
                }).join('');

                // Training summary (best-effort)
                const ts = trainSummary && trainSummary.status === 'success' ? trainSummary : null;
                const tsOk = ts && (ts.ok || ts.ok === 0) ? Number(ts.ok) : null;
                const tsFail = ts && (ts.fail || ts.fail === 0) ? Number(ts.fail) : null;
                const tsHitMean = ts && ts.aggregates && ts.aggregates.hit_rate ? ts.aggregates.hit_rate.mean : null;
                const tsNrmseMean = ts && ts.aggregates && ts.aggregates.nrmse ? ts.aggregates.nrmse.mean : null;
                const tsLogPath = ts && ts.log_path ? ts.log_path : '';

                // Build per-horizon table (prefer metrics file if available)
                const mfByH = (trainSummary && trainSummary.metrics_file && trainSummary.metrics_file.by_horizon) ? trainSummary.metrics_file.by_horizon : {};
                const aggrByH = (trainSummary && trainSummary.aggregates && trainSummary.aggregates.by_horizon) ? trainSummary.aggregates.by_horizon : {};
                const hasMf = (() => {
                    try {
                        return Object.values(mfByH).some(v => {
                            if (!v) return false;
                            const nc = Number(v.nrmse_count || 0);
                            const hc = Number(v.hit_rate_count || 0);
                            const nm = (v.nrmse_mean != null);
                            const hm = (v.hit_rate_mean != null);
                            return (nc > 0 || hc > 0 || nm || hm);
                        });
                    } catch(_) { return false; }
                })();
                const prefByH = hasMf ? mfByH : aggrByH;
                const hkeys = ['1d','3d','7d','14d','30d'];
                const rowsH = hkeys.map(h => {
                    const r = prefByH[h] || {};
                    const nrm = (r.nrmse_mean != null) ? Number(r.nrmse_mean).toFixed(3) : '-';
                    const hitm = (r.hit_rate_mean != null) ? (Number(r.hit_rate_mean).toFixed(2) + '%') : '-';
                    const nc = (r.nrmse_count != null) ? r.nrmse_count : '-';
                    const hc = (r.hit_rate_count != null) ? r.hit_rate_count : '-';
                    return `<tr><td>${h}</td><td>${nrm}</td><td>${hitm}</td><td>${nc}</td><td>${hc}</td></tr>`;
                }).join('');

                body.innerHTML = `
                    <div class="row g-3 mb-3">
                        <div class="col-6 col-md-3">
                            <div class="p-3 rounded text-center" style="background:#f8f9fa;border:1px solid #e9ecef;">
                                <div class="small text-muted">D√∂ng√º</div>
                                <div class="h4 mb-0">${cycle}</div>
                                <div class="small text-muted mt-1">ba≈ülangƒ±√ßtan beri: ${aggr.cycles ?? '-'}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 rounded text-center" style="background:#f8fff9;border:1px solid #e2f3e7;">
                                <div class="small text-muted">Analiz Edilen</div>
                                <div class="h4 mb-0">${analyzed}</div>
                                <div class="small text-muted mt-1">ba≈ülangƒ±√ßtan beri: ${aggr.analyzed ?? '-'}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 rounded text-center" style="background:#f6fbff;border:1px solid #e3f0fb;">
                                <div class="small text-muted">Toplanan</div>
                                <div class="h4 mb-0">${collected}</div>
                                <div class="small text-muted mt-1">ba≈ülangƒ±√ßtan beri: ${aggr.collected ?? '-'}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 rounded text-center" style="background:#fffaf6;border:1px solid #fde8d9;">
                                <div class="small text-muted">G√ºncellenen</div>
                                <div class="h4 mb-0">${updated}</div>
                                <div class="small text-muted mt-1">ba≈ülangƒ±√ßtan beri: ${aggr.updated ?? '-'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <div><strong>Training OK/Fail:</strong> <span>${(tsOk ?? '-') + ' / ' + (tsFail ?? '-')}</span></div>
                                    <div><strong>Hit-rate mean:</strong> <span>${(tsHitMean != null) ? (tsHitMean.toFixed(2) + '%') : '-'}</span></div>
                                    <div><strong>nRMSE mean:</strong> <span>${(tsNrmseMean != null) ? tsNrmseMean.toFixed(3) : '-'}</span></div>
                                    <div class="text-truncate" style="max-width:420px;"><strong>Log:</strong> <span class="text-muted">${tsLogPath || '-'}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <div><strong>Ba≈ülangƒ±√ß:</strong> <span class="text-muted">${sinceStarted || '-'}</span></div>
                                    <div><strong>Toplam Eƒüitim:</strong> <span>${(aggr && (aggr.train_total ?? aggr.train_total === 0)) ? aggr.train_total : '-'}</span></div>
                                    <div><strong>Toplam Sinyal:</strong> <span>${(aggr && (aggr.signals_total ?? aggr.signals_total === 0)) ? aggr.signals_total : '-'}</span></div>
                                    <div><strong>YOLO Tespiti:</strong> <span>${(aggr && (aggr.yolo_detections ?? aggr.yolo_detections === 0)) ? aggr.yolo_detections : '-'}</span></div>
                                    <div><strong>FinGPT Sinyali:</strong> <span>${(aggr && (aggr.fingpt_detections ?? aggr.fingpt_detections === 0)) ? aggr.fingpt_detections : '-'}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Ufuk Bazlƒ± Metrikler</strong>
                                    <small class="text-muted">Son eƒüitim/metriklerden</small>
                                </div>
                                <div class="table-responsive" style="max-height:220px;">
                                    <table class="table table-sm table-striped align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Ufuk</th><th>nRMSE (ortalama)</th><th>Hit-rate (ortalama)</th><th>nRMSE n</th><th>Hit n</th>
                                            </tr>
                                        </thead>
                                        <tbody id="perHTableBody">${rowsH}</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label small">Volume Tier</label>
                            <select class="form-select form-select-sm" id="filterVolumeTier">
                                <option value="all" selected>All</option>
                                <option value="vh">Very High</option>
                                <option value="h">High</option>
                                <option value="m">Medium</option>
                                <option value="l">Low</option>
                                <option value="vl">Very Low</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Timeframe</label>
                            <select class="form-select form-select-sm" id="filterTimeframe">
                                <option value="1">1d</option>
                                <option value="3" selected>3d</option>
                                <option value="7">7d</option>
                                <option value="14">14d</option>
                                <option value="30">30d</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Search <span id="searchResultCount" class="text-muted"></span></label>
                            <div class="input-group input-group-sm">
                                <input class="form-control" id="filterSearch" placeholder="√ñrn: THYAO, T√ºrk Hava" />
                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-lg-6">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <canvas id="reportChart" height="220"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Recent Cycles</strong>
                                    <small class="text-muted">Last ${recent.length}</small>
                                </div>
                                <div class="table-responsive" style="max-height:260px;">
                                    <table class="table table-sm table-striped align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>#</th><th>Time</th><th>Analyzed</th><th>Collected</th><th>Updated</th><th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>${rows || ''}</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mt-3" id="volumeSection">
                        <div class="col-12">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Volume Tiers</strong>
                                    <small class="text-muted">Lookback: ${lookbackDays || '-'} days</small>
                                </div>
                                <div id="volumeSummary" class="mb-2"></div>
                                <div class="table-responsive" style="max-height:260px;">
                                    <table class="table table-sm table-striped align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Symbol</th><th>Avg Volume</th><th>Tier</th>
                                            </tr>
                                        </thead>
                                        <tbody id="volumeSymbolsList"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mt-3" id="tradableSection">
                        <div class="col-12">
                            <div class="p-3 rounded" style="background:#ffffff;border:1px solid #e9ecef;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Trade Edilebilir Adaylar</strong>
                                    <small class="text-muted">Ufuk filtresine g√∂re</small>
                                </div>
                                <div class="table-responsive" style="max-height:260px;">
                                    <table class="table table-sm table-striped align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Sembol</th><th>G√ºven</th><th>Ort. Hacim</th><th>Ufuk</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tradableListBody"><tr><td colspan="4" class="text-muted">Y√ºkleniyor...</td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Build chart
                try {
                    const labels = recent.map((r) => (r.details && (r.details.cycle || ''))).map((v, i) => v || `#${cycle - (recent.length - i)}`);
                    const collectedArr = recent.map(r => (r.details && Number(r.details.collected_records || 0)) || 0);
                    const updatedArr = recent.map(r => (r.details && Number(r.details.updated_records || 0)) || 0);
                    const ctx = document.getElementById('reportChart').getContext('2d');
                    if (__reportChart) { try { __reportChart.destroy(); } catch (_) {} }
                    __reportChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Collected', data: collectedArr, backgroundColor: 'rgba(13, 110, 253, 0.6)' },
                                { label: 'Updated', data: updatedArr, backgroundColor: 'rgba(25, 135, 84, 0.6)' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                } catch (e) { /* ignore chart errors */ }
                // Volume tier rendering and filters
                try {
                    window.__reportVolume = volume || null;
                    const tierSel = document.getElementById('filterVolumeTier');
                    const searchInp = document.getElementById('filterSearch');
                    const sectionEl = document.getElementById('volumeSection');

                    function mapShortToTier(s) {
                        if (s === 'vh') return 'very_high';
                        if (s === 'h') return 'high';
                        if (s === 'm') return 'medium';
                        if (s === 'l') return 'low';
                        if (s === 'vl') return 'very_low';
                        return 'all';
                    }

                    function renderVolumeSymbols() {
                        const vol = window.__reportVolume;
                        const listEl = document.getElementById('volumeSymbolsList');
                        const sumEl = document.getElementById('volumeSummary');
                        if (!vol) {
                            if (sectionEl) sectionEl.style.display = 'none';
                            return;
                        }
                        if (sectionEl) sectionEl.style.display = '';
                        const all = Array.isArray(vol.symbols) ? vol.symbols : [];
                        const sum = vol.summary || {};
                        sumEl.innerHTML = `
                            <span class="badge bg-dark me-1">Very High: ${sum.very_high || 0}</span>
                            <span class="badge bg-primary me-1">High: ${sum.high || 0}</span>
                            <span class="badge bg-secondary me-1">Medium: ${sum.medium || 0}</span>
                            <span class="badge bg-warning text-dark me-1">Low: ${sum.low || 0}</span>
                            <span class="badge bg-light text-dark">Very Low: ${sum.very_low || 0}</span>
                        `;
                        const tierVal = (tierSel && tierSel.value) ? tierSel.value : 'all';
                        const q = (searchInp && searchInp.value ? searchInp.value : '').trim().toUpperCase();
                        let filtered = all.slice();
                        if (tierVal !== 'all') {
                            const target = mapShortToTier(tierVal);
                            filtered = filtered.filter(s => (s.tier || '') === target);
                        }
                        if (q) {
                            filtered = filtered.filter(s => {
                                const sym = String(s.symbol || '').toUpperCase();
                                const name = String(s.name || '').toUpperCase();
                                return sym.includes(q) || name.includes(q);
                            });
                        }
                        const rowsHtml = filtered.slice(0, 200).map(s => {
                            // Highlight search terms
                            let displayText = s.symbol;
                            if (s.name) displayText += ' - ' + s.name;
                            if (q) {
                                const regex = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                                displayText = displayText.replace(regex, '<mark>$1</mark>');
                            }
                            return `
                            <tr>
                                <td>${displayText}</td>
                                <td>${Number(s.avg_volume || 0).toLocaleString('tr-TR')}</td>
                                <td><span class="badge bg-secondary">${s.tier}</span></td>
                            </tr>
                        `;
                        }).join('');
                        
                        // Update search result count
                        const countEl = document.getElementById('searchResultCount');
                        if (countEl) {
                            countEl.textContent = q ? `(${filtered.length} sonu√ß)` : '';
                            if (q) countEl.className = 'text-success';
                        }
                        
                        listEl.innerHTML = rowsHtml || '<tr><td colspan="3" class="text-muted">Sonu√ß bulunamadƒ±</td></tr>';
                    }

                    if (volume) {
                        renderVolumeSymbols();
                        if (tierSel) tierSel.addEventListener('change', renderVolumeSymbols);
                        if (searchInp) {
                            // Remove existing listeners to prevent duplicates
                            searchInp.removeEventListener('input', renderVolumeSymbols);
                            searchInp.addEventListener('input', renderVolumeSymbols);
                            
                            // Enhanced keydown handler
                            searchInp.addEventListener('keydown', function(e){
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    renderVolumeSymbols();
                                    try { 
                                        if (sectionEl) sectionEl.scrollIntoView({behavior: 'smooth', block: 'start'}); 
                                    } catch (_) {}
                                } else if (e.key === 'Escape') {
                                    // Clear search on Escape
                                    searchInp.value = '';
                                    renderVolumeSymbols();
                                }
                            });
                        }
                    } else if (sectionEl) {
                        sectionEl.style.display = 'none';
                    }
                } catch (_) { /* ignore */ }

                // Bind timeframe filter to per-horizon table
                try {
                    const tfSel = document.getElementById('filterTimeframe');
                    const tbody = document.getElementById('perHTableBody');
                    const map = { '1': '1d', '3': '3d', '7': '7d', '14': '14d', '30': '30d' };
                    function renderPerHTable() {
                        if (!tbody) return;
                        const val = (tfSel && tfSel.value) ? tfSel.value : '3';
                        const want = map[val] || null;
                        const src = prefByH || {};
                        const keys = want ? [want] : ['1d','3d','7d','14d','30d'];
                        const html = keys.map(h => {
                            const r = src[h] || {};
                            const nrm = (r.nrmse_mean != null) ? Number(r.nrmse_mean).toFixed(3) : '-';
                            const hitm = (r.hit_rate_mean != null) ? (Number(r.hit_rate_mean).toFixed(2) + '%') : '-';
                            const nc = (r.nrmse_count != null) ? r.nrmse_count : '-';
                            const hc = (r.hit_rate_count != null) ? r.hit_rate_count : '-';
                            return `<tr><td>${h}</td><td>${nrm}</td><td>${hitm}</td><td>${nc}</td><td>${hc}</td></tr>`;
                        }).join('');
                        tbody.innerHTML = html || '<tr><td colspan="5" class="text-muted">No data</td></tr>';
                    }
                    if (tfSel) {
                        tfSel.addEventListener('change', renderPerHTable);
                    }
                    renderPerHTable();
                } catch (_) { /* ignore */ }

                // Tradable candidates loader
                try {
                    const tfSel = document.getElementById('filterTimeframe');
                    const tBody = document.getElementById('tradableListBody');
                    const map = { '1': '1d', '3': '3d', '7': '7d', '14': '14d', '30': '30d' };
                    async function loadTradables() {
                        if (!tBody) return;
                        const tf = tfSel && tfSel.value ? tfSel.value : '7';
                        const horizon = map[tf] || '7d';
                        tBody.innerHTML = '<tr><td colspan="4" class="text-muted">Y√ºkleniyor...</td></tr>';
                        try {
                            const res = await fetch(`/api/internal/reports/tradable?horizon=${encodeURIComponent(horizon)}&limit=20`, { headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' } });
                            const json = res.ok ? await res.json() : { status: 'error' };
                            if (json && json.status === 'success') {
                                const rows = Array.isArray(json.items) ? json.items : [];
                                const html = rows.map(r => `<tr>
                                    <td>${r.symbol}</td>
                                    <td>${(Number(r.confidence || 0)).toFixed(3)}</td>
                                    <td>${r.avg_volume != null ? Number(r.avg_volume).toLocaleString('tr-TR') : '-'}</td>
                                    <td>${r.horizon || '-'}</td>
                                </tr>`).join('');
                                tBody.innerHTML = html || '<tr><td colspan="4" class="text-muted">Aday bulunamadƒ±</td></tr>';
                            } else {
                                tBody.innerHTML = '<tr><td colspan="4" class="text-muted">Veri alƒ±namadƒ±</td></tr>';
                            }
                        } catch (e) {
                            tBody.innerHTML = '<tr><td colspan="4" class="text-muted">Hata olu≈ütu</td></tr>';
                        }
                    }
                    if (tfSel) tfSel.addEventListener('change', loadTradables);
                    loadTradables();
                } catch (_) { /* ignore */ }

            } catch (e) {
                // Fallback content
                const body = document.getElementById('reportModalBody');
                body.innerHTML = '<div class="alert alert-warning">Report content could not be rendered.</div>';
            }
        }

        // Add log entry
        function addLog(level, message, category) {
            const logContainer = document.getElementById('live-logs');
            if (!logContainer) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'INFO': '#00ff00',
                'SUCCESS': '#00ff88',
                'WARNING': '#ffaa00',
                'ERROR': '#ff4444'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[level] || '#00ff00';
            // Show category if provided and not 'system'
            const categoryLabel = (category && category !== 'system') ? `[${category}]` : '';
            logEntry.innerHTML = `[${timestamp}] [${level}] ${categoryLabel} ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 100 log entries
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // Start live updates
        function startLiveUpdates() {
            // Reduce frequency to avoid log spam
            setInterval(updateDashboard, 15000);
        }

        // Clear search function for report modal
        function clearSearch() {
            const searchInp = document.getElementById('filterSearch');
            if (searchInp) {
                searchInp.value = '';
                // Trigger search update if renderVolumeSymbols exists
                if (typeof renderVolumeSymbols === 'function') {
                    renderVolumeSymbols();
                }
            }
        }

        // Initialize everything when page loads
        window.onload = function() {
            // Initialize WebSocket first
            initializeWebSocket();
            
            // Load initial dashboard data
            updateDashboard();
            
            // Restore tasks display count preference
            try {
                const sel = document.getElementById('tasks-count-select');
                const prefer = localStorage.getItem('tasksDisplayCount') || '5';
                sel.value = prefer;
                sel.addEventListener('change', function() {
                    localStorage.setItem('tasksDisplayCount', String(this.value));
                    updateRecentTasks();
                });
            } catch (_) { /* ignore */ }

            // Periodik g√ºncelleme: tek interval (20 sn)
            if (!window.__dashInterval) {
                window.__dashInterval = setInterval(() => {
                    updateDashboard();
                    updateRecentTasks();
                }, 20000);
            }
            
            addLog('INFO', 'üöÄ BIST Dashboard initialized with WebSocket support');
            
            // Initialize simulation monitoring
            checkSimulationStatus();
            setInterval(checkSimulationStatus, 30000); // Check every 30 seconds
        }

        // ==========================================
        // Legacy paper-trading stubs (disabled)
        // ==========================================
        let currentSimulationId = null;
        // Redirect checkSimulationStatus to updateSimulationStatus for forward simulation
        async function checkSimulationStatus() { 
            return await updateSimulationStatus(); 
        }
        function updateSimulationUI(){ /* no-op */ }
        function resetSimulationUI(){ /* no-op */ }
        function viewSimulationDetails(){ try{ openSimDetails(); }catch(_){} }
        function updateTradeStats(){ /* no-op */ }

        async function loadCoverage(){
            try{
                const resp = await fetch('/api/internal/pattern-cache/coverage', { headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }});
                if(!resp.ok) return;
                const j = await resp.json();
                const total = Number(j.total_active||0);
                const have = Number(j.with_cache||0);
                const miss = Number(j.without_cache||0);
                const avg = typeof j.avg_age_seconds==='number' ? j.avg_age_seconds : null;
                const fmt = (s)=>{
                    if(typeof s!=='number'||!isFinite(s)) return '--';
                    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60); return h>0?`${h}h ${m}m`:`${m}m`;
                };
                const el = document.getElementById('coverage-stats');
                if(el) el.textContent = `${have}/${total} (missing ${miss})`;
                const ageEl = document.getElementById('coverage-age');
                if(ageEl) ageEl.textContent = `avg age: ${fmt(avg)}`;
            }catch(e){}
        }

        async function refreshBulkNow(){
            try{
                const btn = document.getElementById('btn-refresh-bulk');
                if(btn){ btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Refreshing'; }
                const resp = await fetch('/api/internal/bulk-predictions/refresh', { method:'POST', headers:{ 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }});
                const j = await resp.json().catch(()=>({}));
                console.log('bulk refresh result', j);
                await updateDashboard();
            }catch(e){} finally{
                const btn = document.getElementById('btn-refresh-bulk');
                if(btn){ btn.disabled=false; btn.innerHTML='<i class="fas fa-rotate"></i> Refresh'; }
            }
        }

        async function loadCalibrationSummary(){
            try{
                const el = document.getElementById('calibration-summary');
                if(!el) return;
                // Prefer internal endpoint with token; fall back to admin if needed
                let resp = await fetch('/api/internal/calibration/summary?v=' + Date.now(), { headers: { 'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw' }});
                if(!resp.ok){
                    resp = await fetch('/api/admin/calibration/summary?v=' + Date.now());
                }
                if(!resp.ok){ el.textContent = 'Unavailable'; return; }
                const j = await resp.json();
                const ps = (j && j.param_store && j.param_store.horizons) ? j.param_store.horizons : {};
                const m7 = j.metrics_7d || {};
                const m30 = j.metrics_30d || {};
                const m90 = j.metrics_90d || {};  // ‚ö° NEW: 90-day metrics
                const ab7 = j.ab_7d || {};
                const ab7Mag = j.ab_7d_magnitude || {};  // ‚ö° NEW: Magnitude-based A/B test
                const thresholdConfig = j.threshold_config || {};  // ‚ö° NEW: Threshold configuration
                const genAt = (j && j.param_store && j.param_store.generated_at) ? j.param_store.generated_at : '-';
                // Sample readiness map from skipped_horizons
                const minSamples = Number((j && j.param_store && j.param_store.min_samples) ? j.param_store.min_samples : 150);
                const skipArr = (j && j.param_store && Array.isArray(j.param_store.skipped_horizons)) ? j.param_store.skipped_horizons : [];
                const skipMap = {};
                try {
                    (skipArr || []).forEach(x => { if (x && x.horizon) { skipMap[x.horizon] = x.reason || ''; } });
                } catch(_) {}
                // Header with calibration state badge
                const cstate = j.calibration_state || {};
                const isBypass = !!cstate.bypass;
                const pen = (typeof cstate.penalty_factor === 'number') ? ` √ó${Number(cstate.penalty_factor).toFixed(2)}` : '';
                const badgeColor = isBypass ? 'bg-warning text-dark' : 'bg-success';
                const badgeText = isBypass ? 'Bypass' : 'Aktif';
                
                // ‚ö° NEW: Online adjustment status
                const onlineAdj = j.online_adjustment || {};
                const onlineAdjEnabled = !!onlineAdj.enabled;
                const onlineAdjBadge = onlineAdjEnabled ? 
                    `<span class="badge bg-info ms-2">Online Adjustment: A√áIK</span>` : 
                    `<span class="badge bg-secondary ms-2">Online Adjustment: KAPALI</span>`;
                
                // ‚úÖ SIMPLIFIED: Cleaner header
                let html = `<div class="mb-3 p-2 bg-light rounded">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                      <span class="badge ${badgeColor} me-2">${badgeText}</span>
                      ${onlineAdjBadge}
                      <small class="text-muted ms-2">Son g√ºncelleme: ${genAt.split('T')[0]}</small>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="calibToggle" ${isBypass ? '' : 'checked'}>
                      <label class="form-check-label" for="calibToggle">${isBypass ? 'Aktif Et' : 'Kapat'}</label>
                    </div>
                  </div>
                </div>`;
                // Helper (hoisted) for badge colors
                function pickColor(v){ if(v===null) return '#e9ecef'; if(v>=70) return '#2a9d8f'; if(v>=50) return '#ffd166'; return '#ef476f'; }
                // Rows with mini gauge + mini reliability
                ['1d','3d','7d','14d','30d'].forEach((h,i)=>{
                    const th = (ps[h] && ps[h].thresholds) ? ps[h].thresholds : {};
                    // ‚úÖ REMOVED: Isotonic badge (clutter reduction - not used anyway)
                    const accPct = (m7[h] && typeof m7[h].acc==='number') ? (m7[h].acc*100) : null;
                    const accStr = accPct!==null ? accPct.toFixed(1)+'%' : '-';
                    const cnt = (m7[h] && m7[h].count) ? m7[h].count : 0;
                    const accPct30 = (m30[h] && typeof m30[h].acc==='number') ? (m30[h].acc*100) : null;
                    const accStr30 = accPct30!==null ? accPct30.toFixed(1)+'%' : '-';
                    const cnt30 = (m30[h] && m30[h].count) ? m30[h].count : 0;
                    const lowSample = ((cnt>0 && cnt<30) || (cnt30>0 && cnt30<30));
                    const abb = (ab7 && ab7[h]) ? ab7[h] : {};
                    const prodAcc = (abb && abb.prod && typeof abb.prod.acc==='number') ? (abb.prod.acc*100) : null;
                    const prodN = (abb && abb.prod && typeof abb.prod.n==='number') ? abb.prod.n : 0;
                    const challAcc = (abb && abb.chall && typeof abb.chall.acc==='number') ? (abb.chall.acc*100) : null;
                    const challN = (abb && abb.chall && typeof abb.chall.n==='number') ? abb.chall.n : 0;
                    const gaugeId = `calibGauge_${h}`;
                    const gaugeId30 = `calibGauge30_${h}`;
                    // Sample status badge per horizon
                    const reason = skipMap[h];
                    let sampleBadge = '';
                    // Check if we have enough samples (use actual count, not just reason)
                    const totalSamples = Math.max(cnt, cnt30);
                    if (totalSamples === 0) {
                        // No samples at all
                        sampleBadge = `<span class="badge bg-secondary ms-2">√ñrnek yetersiz (0/${minSamples})</span>`;
                    } else if (reason) {
                        // Has reason (not enough samples)
                        let got = null;
                        try {
                            const mm = String(reason).match(/not_enough_samples:(\d+)/);
                            got = mm ? parseInt(mm[1], 10) : null;
                        } catch(_) { got = null; }
                        const txt = (got !== null && !Number.isNaN(got)) ? `√ñrnek yetersiz (${got}/${minSamples})` : '√ñrnek yetersiz';
                        sampleBadge = `<span class="badge bg-secondary ms-2">${txt}</span>`;
                    } else if (totalSamples < minSamples) {
                        // Has samples but not enough
                        sampleBadge = `<span class="badge bg-warning text-dark ms-2">√ñrnek yetersiz (${totalSamples}/${minSamples})</span>`;
                    } else {
                        // Enough samples
                        sampleBadge = `<span class="badge bg-success ms-2">Yeterli √∂rnek</span>`;
                    }
                    // ‚úÖ SIMPLIFIED: Cleaner layout with less clutter
                    const hasData = cnt > 0 || cnt30 > 0;
                    const hasProd = prodN > 0;
                    const hasChall = challN > 0;
                    
                    html += `
                      <div class="border rounded p-3 mb-3 ${!hasData ? 'bg-light' : 'bg-white'}">
                        <div class="d-flex justify-content-between align-items-start">
                          <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                              <span class="badge bg-primary me-2">${h}</span>
                              ${sampleBadge}
                            </div>
                            ${hasData ? 
                              `<div class="mb-2">
                                <div class="mb-1"><small><strong>Model Ba≈üarƒ±:</strong> Son 7 g√ºn: <span class="badge" style="background:${pickColor(accPct)};">${accStr}</span> (${cnt} √∂rnek)</small></div>
                                <div class="mb-1"><small>Son 30 g√ºn: <span class="badge" style="background:${pickColor(accPct30)};">${accStr30}</span> (${cnt30} √∂rnek)</small></div>
                                ${(() => {
                                  const accPct90 = (m90[h] && typeof m90[h].acc==='number') ? (m90[h].acc*100) : null;
                                  const accStr90 = accPct90!==null ? accPct90.toFixed(1)+'%' : '-';
                                  const cnt90 = (m90[h] && m90[h].count) ? m90[h].count : 0;
                                  return `<div><small>Son 90 g√ºn: <span class="badge" style="background:${pickColor(accPct90)};">${accStr90}</span> (${cnt90} √∂rnek)</small></div>`;
                                })()}
                              </div>` :
                              '<div class="text-muted small mb-2">Hen√ºz veri yok</div>'
                            }
                            ${hasProd ? 
                              `<div class="mb-1">
                                <small><strong>A/B Test (Y√∂n):</strong> Prod: <span class="badge" style="background:${pickColor(prodAcc)};">${prodAcc!==null?prodAcc.toFixed(1)+'%':'-'}</span> (${prodN})
                                ${hasChall ? 
                                  `¬∑ Chall: <span class="badge" style="background:${pickColor(challAcc)};">${challAcc!==null?challAcc.toFixed(1)+'%':'-'}</span> (${challN})
                                  ${challAcc !== null && prodAcc !== null && challAcc > prodAcc ? 
                                    '<span class="badge bg-success ms-1">Challenger Daha ƒ∞yi</span>' :
                                    challAcc !== null && prodAcc !== null && challAcc < prodAcc ?
                                    '<span class="badge bg-info ms-1">Production Daha ƒ∞yi</span>' : ''
                                  }` :
                                  '<span class="badge bg-secondary ms-1">Challenger yok</span>'
                                }
                                </small>
                                ${(() => {
                                  const abbMag = (ab7Mag && ab7Mag[h]) ? ab7Mag[h] : {};
                                  const prodAccMag = (abbMag && abbMag.prod && typeof abbMag.prod.acc==='number') ? (abbMag.prod.acc*100) : null;
                                  const prodNMag = (abbMag && abbMag.prod && typeof abbMag.prod.n==='number') ? abbMag.prod.n : 0;
                                  const challAccMag = (abbMag && abbMag.chall && typeof abbMag.chall.acc==='number') ? (abbMag.chall.acc*100) : null;
                                  const challNMag = (abbMag && abbMag.chall && typeof abbMag.chall.n==='number') ? abbMag.chall.n : 0;
                                  const hasProdMag = prodNMag > 0;
                                  const hasChallMag = challNMag > 0;
                                  if (hasProdMag || hasChallMag) {
                                    return `<small><strong>A/B Test (B√ºy√ºkl√ºk):</strong> Prod: <span class="badge" style="background:${pickColor(prodAccMag)};">${prodAccMag!==null?prodAccMag.toFixed(1)+'%':'-'}</span> (${prodNMag})
                                    ${hasChallMag ? 
                                      `¬∑ Chall: <span class="badge" style="background:${pickColor(challAccMag)};">${challAccMag!==null?challAccMag.toFixed(1)+'%':'-'}</span> (${challNMag})
                                      ${challAccMag !== null && prodAccMag !== null && challAccMag > prodAccMag ? 
                                        '<span class="badge bg-success ms-1">Challenger Daha ƒ∞yi</span>' :
                                        challAccMag !== null && prodAccMag !== null && challAccMag < prodAccMag ?
                                        '<span class="badge bg-info ms-1">Production Daha ƒ∞yi</span>' : ''
                                      }` :
                                      '<span class="badge bg-secondary ms-1">Challenger yok</span>'
                                    }
                                    </small>`;
                                  }
                                  return '';
                                })()}
                              </div>` :
                              hasData ? '<div class="mb-1"><small class="text-muted">A/B test verileri hen√ºz yok</small></div>' : ''
                            }
                          </div>
                          ${hasData ? 
                            `<div class="d-flex align-items-center ms-3" style="gap:8px;">
                              <canvas id="${gaugeId}" width="60" height="35"></canvas>
                              <canvas id="${gaugeId30}" width="60" height="35"></canvas>
                            </div>` :
                            ''
                          }
                        </div>
                      </div>`;
                });
                el.innerHTML = html;

                // üîé Readiness mini-rozet (√ºst ba≈ülƒ±k saƒü tarafƒ±) ‚Äì local hesap (ek istek yok)
                try {
                    const keys = ['1d','3d','7d','14d','30d'];
                    const need = Number(minSamples || 150);
                    let readyCount = 0;
                    let parts = [];
                    keys.forEach(k=>{
                        const c7 = (m7[k] && m7[k].count) ? m7[k].count : 0;
                        const c30 = (m30[k] && m30[k].count) ? m30[k].count : 0;
                        const cnt = Math.max(c7, c30);
                        if (cnt >= need) readyCount += 1;
                        parts.push(`${k}:${cnt}/${need}`);
                    });
                    const badge = document.getElementById('calibration-readiness-badge');
                    if (badge){
                        const allReady = (readyCount === keys.length);
                        badge.className = 'badge ' + (allReady ? 'bg-success' : (readyCount>0 ? 'bg-warning text-dark' : 'bg-secondary'));
                        badge.textContent = allReady ? 'Ready' : (readyCount>0 ? `Partial (${readyCount}/5)` : 'Not ready');
                        badge.title = parts.join(' | ');
                    }
                } catch(e) {
                    const badge = document.getElementById('calibration-readiness-badge');
                    if (badge){ badge.className = 'badge bg-secondary'; badge.textContent = '‚Äî'; }
                }
                // Render gauges and reliability charts
                const makeGauge = (id, pct)=>{
                    const ctx = document.getElementById(id);
                    if(!ctx) return;
                    const active = pct!==null ? pct : 0;
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: { datasets: [{
                            data: [active, Math.max(0,100-active)],
                            backgroundColor: [pickColor(pct), '#e9ecef'],
                            borderWidth: 0,
                            circumference: 180,
                            rotation: -90,
                            cutout: '70%'
                        }]},
                        options: {responsive:false, plugins:{legend:{display:false}, tooltip:{enabled:false}}}
                    });
                };
                // ‚úÖ REMOVED: makeReliability function (reliability chart not used)
                ['1d','3d','7d','14d','30d'].forEach(h=>{
                    const accPct7 = (m7[h] && typeof m7[h].acc==='number') ? (m7[h].acc*100) : null;
                    const accPct30 = (m30[h] && typeof m30[h].acc==='number') ? (m30[h].acc*100) : null;
                    makeGauge(`calibGauge_${h}`, accPct7);
                    makeGauge(`calibGauge30_${h}`, accPct30);
                });
                // Bind toggle handler (soft toggle via internal API)
                // ‚ö° FIX: Remove old listener before adding new one to prevent duplicates
                try {
                    const tgl = document.getElementById('calibToggle');
                    if (tgl) {
                        // Remove old listener if exists
                        if (window._calibToggleHandler) {
                            tgl.removeEventListener('change', window._calibToggleHandler);
                        }
                        // Define new handler
                        window._calibToggleHandler = async (ev) => {
                            const toggle = ev.target;
                            const desiredBypass = !toggle.checked; // checked => active => bypass=false
                            
                            try {
                                console.log('üîß Calibration toggle clicked:', { checked: toggle.checked, desiredBypass });
                                
                                // ‚ö° UX: Show loading spinner in panel
                                const summaryEl = document.getElementById('calibration-summary');
                                const originalContent = summaryEl ? summaryEl.innerHTML : '';
                                if (summaryEl) {
                                    summaryEl.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><br><small class="text-muted mt-2">Kalibrasyon g√ºncelleniyor...</small></div>';
                                }
                                
                                // ‚ö° UX: Disable toggle during request
                                toggle.disabled = true;
                                
                                const resp = await fetch('/api/internal/calibration/toggle', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-Internal-Token': 'IBx_gsmQUL9oxymAgr67PxES7ACfKlk1Ex5F9jCCOFw'
                                    },
                                    body: JSON.stringify({ bypass: desiredBypass })
                                });
                                
                                if (resp.ok) {
                                    const result = await resp.json();
                                    console.log('‚úÖ Calibration toggle success:', result);
                                    
                                    // ‚ö° UX: Wait a bit then reload panel (smooth transition)
                                    setTimeout(async () => {
                                        try {
                                            await loadCalibrationSummary();
                                            console.log('‚úÖ Panel refreshed successfully');
                                        } catch(err) {
                                            console.error('‚ùå Panel refresh error:', err);
                                            // Force reload on error
                                            window.location.reload();
                                        }
                                    }, 500);
                                } else {
                                    const errorText = await resp.text();
                                    console.error('‚ùå Calibration toggle failed:', resp.status, errorText);
                                    
                                    // ‚ö° UX: Restore original content and revert toggle
                                    if (summaryEl) {
                                        summaryEl.innerHTML = originalContent;
                                    }
                                    toggle.checked = !toggle.checked;
                                    toggle.disabled = false;
                                    
                                    // Show error
                                    if (window.addLog) {
                                        window.addLog('ERROR', '‚ùå Kalibrasyon deƒüi≈ütirilemedi: ' + resp.status);
                                    }
                                }
                            } catch(e) {
                                console.error('‚ùå Calibration toggle error:', e);
                                
                                // ‚ö° UX: Reload panel to restore state
                                loadCalibrationSummary();
                                
                                // Show error
                                if (window.addLog) {
                                    window.addLog('ERROR', '‚ùå Kalibrasyon hatasƒ±: ' + e.message);
                                }
                            }
                        };
                        // Add new listener
                        tgl.addEventListener('change', window._calibToggleHandler);
                    }
                } catch(e) {
                    console.error('‚ùå Calibration toggle setup error:', e);
                }
            }catch(e){
                const el = document.getElementById('calibration-summary');
                if(el) el.textContent = 'Error loading';
            }
        }
</script>

    <!-- ‚úÖ SIM√úLASYON YARDIM MODAL -->
    <div class="modal fade" id="simulationHelpModal" tabindex="-1" aria-labelledby="simulationHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="simulationHelpModalLabel">
                        <i class="fas fa-question-circle me-2"></i>Sim√ºlasyon Paneli Kullanƒ±m Kƒ±lavuzu
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="font-size: 0.95rem;">
                    <!-- Genel Bakƒ±≈ü -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-info-circle me-2"></i>Genel Bakƒ±≈ü
                        </h5>
                        <div class="card border-primary">
                            <div class="card-body">
                                <p>Sim√ºlasyon paneli, geli≈ütirdiƒüiniz AI modelinin √∂nerilerine g√∂re i≈ülem yapƒ±ldƒ±ƒüƒ±nda ne kadar kazan√ßlƒ± √ßƒ±kƒ±lacaƒüƒ±nƒ± test etmenizi saƒülar. Bu, <strong>modelin ger√ßekten i≈üe yarayƒ±p yaramadƒ±ƒüƒ±nƒ± doƒürulamak</strong> i√ßin kritik bir ara√ßtƒ±r.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Parametreler -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-sliders-h me-2"></i>Parametreler ve A√ßƒ±klamalarƒ±
                        </h5>
                        
                        <!-- Sermaye -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>1. Sermaye (Trade Amount)</strong>
                            </div>
                            <div class="card-body">
                                <p><strong>Ne ƒ∞≈üe Yarar:</strong> Sim√ºlasyonda kullanƒ±lacak ba≈ülangƒ±√ß sermayesi</p>
                                <p><strong>√ñnerilen Deƒüer:</strong></p>
                                <ul>
                                    <li>Test i√ßin: 10,000 - 50,000 TL</li>
                                    <li>Ger√ßek√ßi test i√ßin: 100,000 TL</li>
                                </ul>
                                <p><strong>√ñrnek:</strong> 100,000 TL ‚Üí 10 pozisyon i√ßin ortalama 10,000 TL/pozisyon</p>
                            </div>
                        </div>

                        <!-- Horizon -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>2. Horizon (Ufuk)</strong>
                            </div>
                            <div class="card-body">
                                <p><strong>Ne ƒ∞≈üe Yarar:</strong> Modelin √∂ng√∂rd√ºƒü√º zaman dilimi</p>
                                <p><strong>Se√ßenekler:</strong> 1d, 3d, 7d, 14d, 30d</p>
                                <p><strong>√ñnemli:</strong> Model bu horizon'a g√∂re pozisyon tutma s√ºresini belirler. √ñrneƒüin 14d se√ßerseniz, model "14 g√ºn tut" der.</p>
                            </div>
                        </div>

                        <!-- Top N -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>3. Top N</strong>
                            </div>
                            <div class="card-body">
                                <p><strong>Ne ƒ∞≈üe Yarar:</strong> Portf√∂yde tutulacak maksimum pozisyon sayƒ±sƒ± (1-10)</p>
                                <ul>
                                    <li><strong>D√º≈ü√ºk (1-3):</strong> Konsantre portf√∂y, y√ºksek risk</li>
                                    <li><strong>Orta (4-7):</strong> Dengeli portf√∂y</li>
                                    <li><strong>Y√ºksek (8-10):</strong> √áe≈üitlendirilmi≈ü portf√∂y, d√º≈ü√ºk risk</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Commission -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>4. Commission (Komisyon)</strong>
                            </div>
                            <div class="card-body">
                                <p><strong>Ne ƒ∞≈üe Yarar:</strong> Her alƒ±m-satƒ±m i≈üleminde kesilen komisyon oranƒ±</p>
                                <p><strong>√ñnerilen Deƒüer:</strong> 0.0005 (0.05% = BIST standardƒ±)</p>
                            </div>
                        </div>

                        <!-- Stop-loss -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>5. Stop-loss %</strong>
                            </div>
                            <div class="card-body">
                                <p><strong>Ne ƒ∞≈üe Yarar:</strong> Zararƒ± sƒ±nƒ±rlamak i√ßin pozisyonun otomatik satƒ±lacaƒüƒ± d√º≈ü√º≈ü y√ºzdesi</p>
                                <ul>
                                    <li><strong>Sƒ±kƒ± (1-3%):</strong> K√º√ß√ºk zararlarƒ± √∂nler</li>
                                    <li><strong>Orta (3-5%):</strong> Dengeli, normal volatilite i√ßin uygun</li>
                                    <li><strong>Gev≈üek (5-10%):</strong> B√ºy√ºk zararlara izin verir</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Relatif D√º≈ü√º≈ü -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>6. Relatif D√º≈ü√º≈ü %</strong>
                            </div>
                            <div class="card-body">
                                <p><strong>Ne ƒ∞≈üe Yarar:</strong> Modelin g√ºven skorunun (confidence) ne kadar d√º≈ümesine izin verileceƒüi</p>
                                <p><strong>√ñrnek:</strong> Entry confidence: 80%, Relative drop: 20% ‚Üí 64%'e d√º≈üerse satƒ±≈ü</p>
                            </div>
                        </div>

                        <!-- Sim√ºlasyon Modu -->
                        <div class="card mb-3 border-warning">
                            <div class="card-header bg-warning">
                                <strong>7. Sim√ºlasyon Modu ‚≠ê YENƒ∞</strong>
                            </div>
                            <div class="card-body">
                                <p><strong>Ne ƒ∞≈üe Yarar:</strong> Sim√ºlasyonun neyi √∂l√ßeceƒüini belirler</p>
                                
                                <div class="card mb-2 border-success">
                                    <div class="card-header bg-success text-white">
                                        <strong>A. Hibrit (Model + Risk Y√∂netimi) - √ñnerilen</strong>
                                    </div>
                                    <div class="card-body">
                                        <p>Model √∂nerilerini ve risk y√∂netimi mekanizmalarƒ±nƒ± birlikte test eder. Her iki performansƒ± ayrƒ± ayrƒ± √∂l√ßer.</p>
                                    </div>
                                </div>

                                <div class="card mb-2 border-info">
                                    <div class="card-header bg-info text-white">
                                        <strong>B. Model Testi (Sadece Model Performansƒ±)</strong>
                                    </div>
                                    <div class="card-body">
                                        <p>Sadece model √∂nerilerini takip eder. Stop-loss ve confidence drop <strong>devre dƒ±≈üƒ±</strong>. Modelin √∂nerdiƒüi s√ºre (horizon) dolana kadar pozisyon tutar.</p>
                                    </div>
                                </div>

                                <div class="card mb-2 border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <strong>C. Risk Y√∂netimi (Stop-loss + Confidence Drop)</strong>
                                    </div>
                                    <div class="card-body">
                                        <p>Sadece risk y√∂netimi mekanizmalarƒ±nƒ± test eder. Stop-loss ve confidence drop aktif.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hƒ±zlƒ± Ba≈ülangƒ±√ß -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-rocket me-2"></i>Hƒ±zlƒ± Ba≈ülangƒ±√ß
                        </h5>
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <strong>ƒ∞lk Test ƒ∞√ßin √ñnerilen Ayarlar</strong>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li><strong>Sermaye:</strong> 50,000 TL</li>
                                    <li><strong>Horizon:</strong> 7d</li>
                                    <li><strong>Top N:</strong> 5</li>
                                    <li><strong>Commission:</strong> 0.0005</li>
                                    <li><strong>Stop-loss:</strong> 3%</li>
                                    <li><strong>Relatif D√º≈ü√º≈ü:</strong> 20%</li>
                                    <li><strong>Mod:</strong> Hibrit</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- √ñnemli Notlar -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>√ñnemli Notlar
                        </h5>
                        <div class="card border-warning">
                            <div class="card-body">
                                <ul>
                                    <li><strong>Horizon = Pozisyon Tutma S√ºresi:</strong> Model "14d" dedi ‚Üí 14 g√ºn tutulur (model_test modunda)</li>
                                    <li><strong>Commission Etkisi:</strong> Sƒ±k i≈ülem yapan stratejiler commission'dan olumsuz etkilenir</li>
                                    <li><strong>Confidence Aƒüƒ±rlƒ±klandƒ±rmasƒ±:</strong> Y√ºksek confidence ‚Üí daha fazla sermaye</li>
                                    <li><strong>Sim√ºlasyon S√ºresi:</strong> Se√ßilen horizon kadar s√ºrer (√∂rn: 14d ‚Üí 14 g√ºn)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>