# ==========================================
# COMPLETE SYSTEMD OVERRIDE CONFIGURATION
# Place at: /etc/systemd/system/bist-pattern.service.d/99-complete-override.conf
# ==========================================

[Service]

# ==========================================
# CORE SYSTEM CONFIGURATION
# ==========================================

# Python Environment
Environment="PYTHONPATH=/opt/bist-pattern"
Environment="PYTHONWARNINGS=ignore"

# Flask Core
Environment="FLASK_ENV=production"
Environment="FLASK_HOST=0.0.0.0"
Environment="FLASK_PORT=5000"
Environment="FLASK_DEBUG=False"

# Security Keys (CHANGE THESE!)
Environment="FLASK_SECRET_KEY=__GENERATE_STRONG_SECRET_KEY__"
Environment="JWT_SECRET_KEY=__GENERATE_STRONG_JWT_KEY__"
Environment="INTERNAL_API_TOKEN=__GENERATE_STRONG_API_TOKEN__"

# ==========================================
# DATABASE CONFIGURATION
# ==========================================

# PostgreSQL Connection (password from secure file)
Environment="DATABASE_URL=postgresql://bist_user@127.0.0.1:5432/bist_pattern_db"
Environment="DB_HOST=localhost"
Environment="DB_PORT=5432"
Environment="DB_NAME=bist_pattern_db"
Environment="DB_USER=bist_user"
# DB_PASSWORD removed for security - use file-based auth

# SQLAlchemy Settings
Environment="SQLALCHEMY_POOL_SIZE=10"
Environment="SQLALCHEMY_POOL_RECYCLE=120"
Environment="SQLALCHEMY_POOL_PRE_PING=True"

# ==========================================
# REDIS & MESSAGING
# ==========================================

Environment="REDIS_URL=redis://127.0.0.1:6379/0"
Environment="SOCKETIO_MESSAGE_QUEUE=redis://127.0.0.1:6379/0"

# ==========================================
# WEBSOCKET CONFIGURATION
# ==========================================

Environment="SOCKETIO_PING_TIMEOUT=60"
Environment="SOCKETIO_PING_INTERVAL=30"
Environment="SOCKETIO_ALLOW_HTTP=True"
Environment="ENGINEIO_DEBUG=0"

# ==========================================
# SECURITY SETTINGS
# ==========================================

# SSL/HTTPS (Production)
Environment="SESSION_COOKIE_SECURE=True"
Environment="REMEMBER_COOKIE_SECURE=True"
Environment="PREFERRED_URL_SCHEME=https"
Environment="SESSION_COOKIE_HTTPONLY=True"
Environment="SESSION_COOKIE_SAMESITE=Strict"

# CORS Configuration
Environment="CORS_ORIGINS=https://cls.aile.gov.tr,https://lotlot.net,https://www.lotlot.net"

# Internal API Security
Environment="INTERNAL_ALLOW_LOCALHOST=False"

# ==========================================
# THREADING & CONCURRENCY
# ==========================================

# Gunicorn Workers
Environment="GUNICORN_WORKERS=1"
Environment="GUNICORN_WORKER_CLASS=geventwebsocket.gunicorn.workers.GeventWebSocketWorker"
Environment="GUNICORN_TIMEOUT=1800"
Environment="GUNICORN_BIND=0.0.0.0:5000"

# Thread Pool Limits
Environment="COLLECTOR_MAX_WORKERS=2"
Environment="ML_ASYNC_WORKERS=2"
Environment="VISUAL_ASYNC_WORKERS=1"
Environment="PATTERN_COORDINATOR_WORKERS=1"
Environment="VISUAL_THREAD_POOL_WORKERS=1"

# ==========================================
# CACHE MANAGEMENT
# ==========================================

# API Cache
Environment="API_CACHE_MAX_SIZE=1000"
Environment="API_CACHE_TTL_WATCHLIST=5"

# Pattern Cache
Environment="PATTERN_CACHE_TTL=300"
Environment="PATTERN_COORDINATOR_CACHE_TTL=300"
Environment="PATTERN_RESULT_CACHE_MAX_SIZE=200"
Environment="PATTERN_DATA_CACHE_TTL=60"
Environment="PATTERN_DF_CACHE_MAX_SIZE=512"

# Collector Cache
Environment="COLLECTOR_FETCH_CACHE_TTL=300"
Environment="COLLECTOR_NO_DATA_TTL_SECONDS=600"

# ==========================================
# DATA COLLECTION SETTINGS
# ==========================================

# Collection Behavior
Environment="AUTO_CREATE_STOCKS=True"
Environment="VALIDATE_SYMBOLS=False"
Environment="COLLECTION_SCOPE=ALL"
Environment="COLLECTOR_BATCH_SIZE=50"
Environment="COLLECTION_PERIOD=3mo"
Environment="PRIORITY_PERIOD=6mo"
Environment="MIN_HISTORY_DAYS=365"

# Collection Timing
Environment="SYMBOL_SLEEP_SECONDS=0.1"
Environment="BATCH_SLEEP_SECONDS=3"
Environment="COLLECTOR_DELAY_RANGE=1,3"

# Collection Timeouts
Environment="COLLECTOR_HTTP_TIMEOUT=10"
Environment="COLLECTOR_NATIVE_TIMEOUT=12.0"

# Yahoo Finance Settings
Environment="YF_USE_CFFI=1"
Environment="YF_MAX_RETRIES=3"
Environment="YF_BACKOFF_BASE_SECONDS=2.0"
Environment="YF_MIN_DELAY=2.0"
Environment="YF_MAX_DELAY=6.0"
Environment="YF_BURST_DELAY=10.0"
Environment="YF_BURST_THRESHOLD=5"
Environment="YF_SESSION_POOL_SIZE=5"
Environment="YF_FALLBACK_TIMEOUT=60.0"
Environment="ENABLE_YAHOO_FALLBACK=True"
Environment="YF_ENHANCED_ENABLED=True"

# ==========================================
# AUTOMATION & PIPELINE
# ==========================================

# Pipeline Mode
Environment="PIPELINE_MODE=SYMBOL_FLOW"
Environment="SYMBOL_FLOW=1"
Environment="AUTO_START_PIPELINE=True"

# Automation Timing
Environment="AUTOMATION_CYCLE_SLEEP_SECONDS=300"
Environment="AUTOMATION_ERROR_RETRY_DELAY=30"
Environment="FULL_CYCLE_SLEEP_SECONDS=1800"

# Status Management
Environment="STATUS_GRACE_SECONDS=10"
Environment="RUNNING_FLAG_KEY=automation:running"
Environment="RUNNING_FLAG_TTL=120"
Environment="RUNNING_FLAG_HEARTBEAT_SECONDS=30"

# Cooldown Settings
Environment="NO_DATA_COOLDOWN_CYCLES=20"

# ==========================================
# MACHINE LEARNING SETTINGS
# ==========================================

# ML Feature Flags
Environment="ENABLE_ENHANCED_ML=True"
Environment="ENABLE_BASIC_ML=True"
Environment="ENABLE_FINGPT=True"

# ML Training Configuration
Environment="ML_MIN_DATA_DAYS=200"
Environment="ML_MAX_MODEL_AGE_DAYS=7"
Environment="ML_TRAINING_COOLDOWN_HOURS=6"
Environment="ML_CANDIDATE_COOLDOWN_HOURS=2"
Environment="ML_TOP_POOL_SIZE=20"
Environment="ML_TRAIN_INTERVAL_CYCLES=1"
Environment="ML_TRAIN_PER_CYCLE=50"

# Model Paths
Environment="ML_MODEL_PATH=/opt/bist-pattern/.cache/enhanced_ml_models"
Environment="CATBOOST_TRAIN_DIR=/opt/bist-pattern/.cache/catboost"
Environment="TRANSFORMERS_CACHE=/opt/bist-pattern/cache/huggingface"
Environment="HF_HOME=/opt/bist-pattern/cache/huggingface"

# ==========================================
# VISUAL PATTERN DETECTION (YOLO)
# ==========================================

Environment="ENABLE_YOLO=True"
Environment="YOLO_MODEL_PATH=/opt/bist-pattern/yolo/patterns_all_v7_rectblend.pt"
Environment="YOLO_MIN_CONF=0.12"

# ==========================================
# PATTERN DETECTION SETTINGS
# ==========================================

# Performance Thresholds (milliseconds)
Environment="PATTERN_FAST_THRESHOLD_MS=100"
Environment="PATTERN_STANDARD_THRESHOLD_MS=500"
Environment="PATTERN_COMPREHENSIVE_THRESHOLD_MS=2000"

# Pattern Analysis
Environment="CONSENSUS_DELTA=2"
Environment="VOL_HIGH_THRESHOLD=0.10"
Environment="VOL_LOW_THRESHOLD=0.03"

# ==========================================
# NEWS & SENTIMENT ANALYSIS
# ==========================================

Environment="NEWS_SOURCES=https://www.milliyet.com.tr/rss/rssnew/ekonomi.xml,https://www.ekonomidunya.com/rss_ekonomi_1.xml,https://tr.investing.com/rss/news_95.rss,https://tr.investing.com/rss/news_14.rss,https://www.ntv.com.tr/ekonomi.rss,https://www.sabah.com.tr/rss/ekonomi.xml,https://www.borsagundem.com.tr/rss"
Environment="NEWS_LOOKBACK_HOURS=24"
Environment="NEWS_MAX_ITEMS=10"
Environment="NEWS_CACHE_TTL=600"
Environment="RSS_TIMEOUT=5"

# ==========================================
# LOGGING & MONITORING
# ==========================================

# Log Configuration
Environment="BIST_LOG_PATH=/opt/bist-pattern/logs"
Environment="DEBUG_VERBOSE=1"
Environment="LOG_LEVEL=INFO"

# Cache & Status Monitoring
Environment="STATUS_CACHE_TTL=15"

# ==========================================
# SIMULATION SETTINGS
# ==========================================

# Paper Trading
Environment="MIN_SIGNAL_CONFIDENCE=0.6"
Environment="SIMULATION_COMMISSION_RATE=0.001"

# ==========================================
# PERFORMANCE TUNING
# ==========================================

# HTTP Client Settings
Environment="HTTP_CONNECTION_POOL_SIZE=10"
Environment="HTTP_REQUEST_TIMEOUT=30"

# Background Processing
Environment="BACKGROUND_TASK_TIMEOUT=300"
Environment="QUEUE_PROCESSING_BATCH_SIZE=10"

# ==========================================
# EXTERNAL SERVICES
# ==========================================

# API URLs
Environment="BIST_API_URL=https://api.lotlot.net"
Environment="PUBLIC_BASE_URL=https://lotlot.net"

# Rate Limiting
Environment="API_RATE_LIMIT_PER_MINUTE=60"
Environment="INTERNAL_API_RATE_LIMIT=1000"

# ==========================================
# DEVELOPMENT & DEBUG
# ==========================================

# Debug Flags (disable in production)
Environment="COLLECTOR_BROADCAST_LOGS=1"
Environment="BROADCAST_PROGRESS=True"

# ==========================================
# RESOURCE LIMITS
# ==========================================

# Memory Management
Environment="MAX_MEMORY_USAGE_MB=2048"
Environment="CACHE_CLEANUP_INTERVAL_SECONDS=600"

# File Limits
Environment="MAX_LOG_FILES=10"
Environment="LOG_ROTATION_SIZE_MB=100"
Environment="MAX_TEMP_FILES=1000"
