# SECURE SYSTEMD OVERRIDE CONFIGURATION
# Place this file at: /etc/systemd/system/bist-pattern.service.d/99-secure-override.conf

[Service]
# ==========================================
# SECURITY FIXES
# ==========================================

# Database credentials (SECURE: read from file instead of environment)
# Create password file: echo "YOUR_SECURE_PASSWORD" | sudo tee /opt/bist-pattern/.secrets/db_password
# Set permissions: sudo chmod 600 /opt/bist-pattern/.secrets/db_password
Environment="DATABASE_URL=postgresql://bist_user@127.0.0.1:5432/bist_pattern_db"
Environment="DB_HOST=localhost"
Environment="DB_PORT=5432"
Environment="DB_NAME=bist_pattern_db"
Environment="DB_USER=bist_user"
# Remove DB_PASSWORD from environment - use file-based auth instead

# Strong internal API token (CHANGE THIS!)
Environment="INTERNAL_API_TOKEN=__GENERATE_SECURE_TOKEN__"

# Disable localhost fallback for internal API (production security)
Environment="INTERNAL_ALLOW_LOCALHOST=False"

# ==========================================
# THREADING OPTIMIZATION
# ==========================================

# Coordinated thread pool limits (total: 6 threads max)
Environment="COLLECTOR_MAX_WORKERS=2"
Environment="ML_ASYNC_WORKERS=2"
Environment="VISUAL_ASYNC_WORKERS=1"
Environment="PATTERN_COORDINATOR_WORKERS=1"

# Disable additional thread pools in code
Environment="DISABLE_EXTRA_THREAD_POOLS=True"

# ==========================================
# SSL/HTTPS CONSISTENCY
# ==========================================

# Production HTTPS settings (align with nginx)
Environment="SESSION_COOKIE_SECURE=True"
Environment="REMEMBER_COOKIE_SECURE=True"
Environment="PREFERRED_URL_SCHEME=https"

# ==========================================
# CORS CONSOLIDATION
# ==========================================

# Single source of truth for CORS origins
Environment="CORS_ORIGINS=https://cls.aile.gov.tr,https://lotlot.net,https://www.lotlot.net"

# ==========================================
# PERFORMANCE OPTIMIZATIONS
# ==========================================

# Cache management
Environment="PATTERN_CACHE_TTL=300"
Environment="DATA_CACHE_TTL=60"
Environment="API_CACHE_TTL_WATCHLIST=5"

# Collection optimization
Environment="COLLECTOR_BATCH_SIZE=25"
Environment="SYMBOL_SLEEP_SECONDS=0.05"
Environment="BATCH_SLEEP_SECONDS=2"

# ==========================================
# ERROR HANDLING IMPROVEMENTS
# ==========================================

# Enable detailed error logging
Environment="DEBUG_VERBOSE=1"
Environment="LOG_LEVEL=INFO"

# Circuit breaker settings
Environment="YF_MAX_RETRIES=3"
Environment="YF_BACKOFF_BASE_SECONDS=2.0"
Environment="NO_DATA_COOLDOWN_CYCLES=20"

# ==========================================
# MONITORING & OBSERVABILITY
# ==========================================

# Health check intervals
Environment="STATUS_GRACE_SECONDS=10"
Environment="RUNNING_FLAG_TTL=120"
Environment="RUNNING_FLAG_HEARTBEAT_SECONDS=30"

# Log retention
Environment="MAX_LOG_FILES=10"
Environment="LOG_ROTATION_SIZE=100MB"
