#!/usr/bin/env python3
import schedule
import time
import logging
import threading
import signal
import sys
from datetime import datetime
from advanced_collector import AdvancedBISTCollector

# Logging setup
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/opt/bist-pattern/logs/scheduler.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class BISTSchedulerDaemon:
    def __init__(self):
        self.collector = AdvancedBISTCollector()
        self.is_running = False
        self.scheduler_thread = None
        
        # Graceful shutdown
        signal.signal(signal.SIGTERM, self.signal_handler)
        signal.signal(signal.SIGINT, self.signal_handler)

    def signal_handler(self, signum, frame):
        """Handle shutdown signals"""
        logger.info(f"Received signal {signum}, shutting down gracefully...")
        self.stop_scheduler()
        sys.exit(0)

    def collect_priority_data(self):
        """Ã–ncelikli hisseler iÃ§in veri toplama"""
        logger.info("ğŸ“Š Ã–ncelikli hisse veri toplama baÅŸlatÄ±lÄ±yor...")
        try:
            result = self.collector.collect_priority_stocks()
            logger.info(f"âœ… Ã–ncelikli toplama tamamlandÄ±: {result['success_count']} baÅŸarÄ±lÄ±, {result['total_records']} kayÄ±t")
            return result
        except Exception as e:
            logger.error(f"âŒ Ã–ncelikli toplama hatasÄ±: {e}")
            return None

    def collect_all_data(self):
        """TÃ¼m hisseler iÃ§in veri toplama"""
        logger.info("ğŸ“Š Tam veri toplama baÅŸlatÄ±lÄ±yor...")
        try:
            result = self.collector.collect_all_stocks_parallel(batch_size=25)
            logger.info(f"âœ… Tam toplama tamamlandÄ±: {result['success_count']} baÅŸarÄ±lÄ±, {result['total_records']} kayÄ±t")
            return result
        except Exception as e:
            logger.error(f"âŒ Tam toplama hatasÄ±: {e}")
            return None

    def run_scheduler(self):
        """Scheduler loop"""
        logger.info("ğŸ•’ Scheduler loop baÅŸlatÄ±ldÄ±")
        while self.is_running:
            try:
                schedule.run_pending()
                time.sleep(60)  # Her dakika kontrol et
            except Exception as e:
                logger.error(f"Scheduler loop hatasÄ±: {e}")
                time.sleep(60)

    def start_scheduler(self):
        """Scheduler'Ä± baÅŸlat"""
        if self.is_running:
            logger.warning("âš ï¸ Scheduler zaten Ã§alÄ±ÅŸÄ±yor!")
            return

        logger.info("ğŸš€ BIST Scheduler Daemon baÅŸlatÄ±lÄ±yor...")

        # Zamanlama kurallarÄ±
        schedule.every().day.at("09:30").do(self.collect_priority_data)  # Borsa aÃ§Ä±lÄ±ÅŸ
        schedule.every().day.at("12:00").do(self.collect_priority_data)  # Ã–ÄŸle
        schedule.every().day.at("18:00").do(self.collect_priority_data)  # AkÅŸam
        schedule.every().sunday.at("10:00").do(self.collect_all_data)    # HaftalÄ±k tam

        # Ä°lk veriyi topla
        logger.info("ğŸ”„ Ä°lk veri toplama iÅŸlemi...")
        self.collect_priority_data()

        self.is_running = True
        self.scheduler_thread = threading.Thread(target=self.run_scheduler, daemon=True)
        self.scheduler_thread.start()
        
        logger.info("âœ… Scheduler baÅŸarÄ±yla baÅŸlatÄ±ldÄ±")
        
        # Ana thread'i canlÄ± tut
        try:
            while self.is_running:
                time.sleep(10)
        except KeyboardInterrupt:
            self.stop_scheduler()

    def stop_scheduler(self):
        """Scheduler'Ä± durdur"""
        logger.info("ğŸ›‘ Scheduler durduruluyor...")
        self.is_running = False
        schedule.clear()
        if self.scheduler_thread and self.scheduler_thread.is_alive():
            self.scheduler_thread.join(timeout=5)
        logger.info("âœ… Scheduler durduruldu")

if __name__ == "__main__":
    daemon = BISTSchedulerDaemon()
    try:
        daemon.start_scheduler()
    except Exception as e:
        logger.error(f"Daemon baÅŸlatma hatasÄ±: {e}")
        sys.exit(1)
